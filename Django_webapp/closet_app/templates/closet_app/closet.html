{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#673ab7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>æˆ‘çš„è¡£æŸœ - åˆ†ç±»æŸ¥çœ‹</title>
  {% csrf_token %}
  <link rel="stylesheet" href="{% static 'closet_app/responsive.css' %}">
  <script src="{% static 'closet_app/device-adapter.js' %}"></script>
  <style>
    /* é‡ç½®é»˜è®¤æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    /* ä¸ºé¡µé¢ä¸»ä½“æ·»åŠ åº•éƒ¨è¾¹è·ï¼Œé˜²æ­¢è¢«å›ºå®šå¯¼èˆªæ é®æŒ¡ */
    body {
      padding-bottom: 80px;
      background-color: #E4DCF5;
    }

    /* é¡µé¢å®¹å™¨æœ€å¤§å®½åº¦é™åˆ¶ */
    .page-container {
      max-width: 440px; /* æ¯”ä¸€èˆ¬æ‰‹æœºå±å¹•(375px)å®½çº¦17% */
      margin: 0 auto;
      background-color: #E4DCF5;
      min-height: 100vh;
      position: relative;
      overflow: hidden; /* ç¦ç”¨çºµå‘æ»‘åŠ¨ */
      touch-action: none; /* ç¦ç”¨è§¦æ‘¸æ»‘åŠ¨ */
      -webkit-overflow-scrolling: none; /* ç¦ç”¨iOSæ»šåŠ¨ */
    }

    /* æ‰‹æœºç«¯ç¦ç”¨é¡µé¢æ•´ä½“æ»‘åŠ¨ï¼Œä½†å…è®¸å®¹å™¨å†…æ»‘åŠ¨ */
    @media (max-width: 440px) {
      body {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
        touch-action: none;
        -webkit-overflow-scrolling: none;
      }
      
      html {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }

      /* å…è®¸closetå®¹å™¨å†…çš„æ»‘åŠ¨ */
      .closet-container {
        overflow: visible;
      }

      .clothes-container {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }

      .category-list {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
    }

    /* åœ¨ç”µè„‘ç«¯æ˜¾ç¤ºè¾¹æ¡†æ•ˆæœ */
    @media (min-width: 441px) {
      .page-container {
        border-left: 1px solid rgba(103, 58, 183, 0.1);
        border-right: 1px solid rgba(103, 58, 183, 0.1);
        box-shadow: 0 0 20px rgba(103, 58, 183, 0.1);
        margin-top: 20px; /* åœ¨ç”µè„‘ç«¯æ·»åŠ é¡¶éƒ¨è¾¹è· */
        margin-bottom: 20px; /* åœ¨ç”µè„‘ç«¯æ·»åŠ åº•éƒ¨è¾¹è· */
        border-radius: 12px; /* åœ†è§’æ•ˆæœ */
      }
    }

    /* é‡ç½® i æ ‡ç­¾çš„æ–œä½“æ ·å¼ï¼Œç¡®ä¿å›¾æ ‡æ­£å¸¸æ˜¾ç¤º */
    i {
      font-style: normal;
    }

    /* æœç´¢æ ä¸ä¸Šä¼ æŒ‰é’®åŒºåŸŸ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0px 16px;
      background-color: #D0B0EB;
      height: 72px;
      max-height: 72px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .search-box {
      display: flex;
      align-items: center;
      background-color: #f8f8f8;
      border-radius: 20px;
      padding: 4px 16px;
      flex: 1;
      margin: 0 12px;
      min-height: 32px;
    }

    .search-box input {
      border: none;
      outline: none;
      background-color: transparent;
      font-size: 14px;
      color: #333;
      flex: 1;
    }

    .search-icon {
      width: 20px;
      height: 20px;
      background: url('https://cdn-icons-png.flaticon.com/512/482/482501.png') center/cover no-repeat;
    }

    /* è¡£æŸœå†…å®¹åŒºåŸŸ */
    .closet-container {
      display: flex;
      padding: 16px;
      height: calc(100vh - 72px - 60px);
      overflow: hidden;
    }

    /* å³ä¾§è¡£æœå±•ç¤ºåŒºåŸŸå¯æ»‘åŠ¨ */
    .clothes-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
    .clothes-container::-webkit-scrollbar {
      width: 6px;
    }

    .clothes-container::-webkit-scrollbar-track {
      background: rgba(103, 58, 183, 0.1);
      border-radius: 3px;
    }

    .clothes-container::-webkit-scrollbar-thumb {
      background: rgba(103, 58, 183, 0.3);
      border-radius: 3px;
    }

    .clothes-container::-webkit-scrollbar-thumb:hover {
      background: rgba(103, 58, 183, 0.5);
    }

    /* å·¦ä¾§åˆ†ç±»åˆ—è¡¨ï¼ˆå¯ç‚¹å‡»åˆ‡æ¢ï¼‰ */
    .category-list {
      width: 80px;
      background-color: #e5f3ff;
      border-radius: 8px;
      padding: 8px;
      margin-right: 16px;
      overflow-y: auto;
      max-height: 100%;
      flex-shrink: 0;
    }

    /* å·¦ä¾§åˆ†ç±»åˆ—è¡¨æ»šåŠ¨æ¡æ ·å¼ */
    .category-list::-webkit-scrollbar {
      width: 4px;
    }

    .category-list::-webkit-scrollbar-track {
      background: rgba(103, 58, 183, 0.1);
      border-radius: 2px;
    }

    .category-list::-webkit-scrollbar-thumb {
      background: rgba(103, 58, 183, 0.3);
      border-radius: 2px;
    }

    .category-list::-webkit-scrollbar-thumb:hover {
      background: rgba(103, 58, 183, 0.5);
    }

    .category-item {
      width: 100%;
      background-color: #fff;
      border-radius: 4px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 4px;
      position: relative;
      min-height: 40px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateZ(0);
    }

    .category-item:hover {
      transform: translateZ(0) scale(1.05);
      box-shadow: 0 4px 12px rgba(103, 58, 183, 0.2);
    }

    .category-item:active {
      transform: translateZ(0) scale(0.98);
      transition: all 0.1s ease;
    }

    /* é€‰ä¸­çš„åˆ†ç±»é«˜äº® */
    .category-item.active {
      background-color: #673ab7; /* ç´«è‰²é«˜äº® */
    }

    .category-item.active span {
      color: white; /* é€‰ä¸­æ—¶æ–‡å­—å˜ç™½ */
    }

    .category-item span {
      font-size: 10px;
      color: #333;
      text-align: center;
      margin-top: 4px;
      transition: color 0.2s;
    }

    /* å³ä¾§å›¾ç‰‡åŒºåŸŸï¼ˆé»˜è®¤éšè—æ‰€æœ‰åˆ†ç±»ï¼Œåªæ˜¾ç¤ºé€‰ä¸­çš„ï¼‰ */
    .clothes-container {
      flex: 1;
      overflow-y: auto;
      max-height: 100%;
      padding: 10px 8px;
      background-color: rgba(128, 0, 128, 0.05);
      border-radius: 8px;
    }

    /* åˆ†ç±»å›¾ç‰‡åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼Œç‚¹å‡»åˆ†ç±»åæ˜¾ç¤ºï¼‰ */
    .category-section {
      display: none; /* é»˜è®¤éšè—æ‰€æœ‰åˆ†ç±» */
    }

    /* é€‰ä¸­çš„åˆ†ç±»åŒºåŸŸæ˜¾ç¤º */
    .category-section.active {
      display: block;
    }

    /* å›¾ç‰‡ç½‘æ ¼ï¼ˆä¸€è¡Œä¸¤å¼ ï¼‰ */
    .clothes-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-gap: 16px;
    }

    .clothes-item {
      border-radius: 8px;
      width: 100%;
      height: 160px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .clothes-item:hover {
      transform: scale(1.05) translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .clothes-item:active {
      transform: scale(1.02) translateY(0);
      transition: all 0.1s ease;
    }
    
    .clothes-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* åˆ†ç±»æ ‡é¢˜ */
    .category-title {
      font-size: 16px;
      color: #6a0dad;
      margin: 0 0 12px 4px;
      font-weight: 600;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(128, 0, 128, 0.1);
    }

    /* æ— å›¾ç‰‡æç¤º */
    .empty-message {
      grid-column: 1 / -1;
      background: #f9f9f9;
      border-radius: 8px;
      padding: 30px 20px;
      text-align: center;
      color: #666;
      font-size: 14px;
      border: 1px dashed #ddd;
    }

    /* åº•éƒ¨å¯¼èˆªä¸æ‚¬æµ®æŒ‰é’® */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 440px; /* ä¸é¡µé¢å®¹å™¨ä¿æŒä¸€è‡´ */
      height: 60px;
      background: #fff;
      border-top: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1000;
    }

    /* åœ¨ç”µè„‘ç«¯ä¸ºåº•éƒ¨å¯¼èˆªæ æ·»åŠ è¾¹æ¡†æ•ˆæœ */
    @media (min-width: 441px) {
      .bottom-nav {
        border-left: 1px solid rgba(103, 58, 183, 0.1);
        border-right: 1px solid rgba(103, 58, 183, 0.1);
        border-bottom: 1px solid rgba(103, 58, 183, 0.1);
        border-radius: 0 0 12px 12px; /* åº•éƒ¨åœ†è§’ */
        box-shadow: 0 0 20px rgba(103, 58, 183, 0.1);
      }
    }

    .nav-item {
      text-align: center;
      flex: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s ease;
      padding: 8px 0;
      min-height: 60px;
    }
    .nav-item:hover {
      background-color: #f5f5f5;
    }
    .nav-item:active {
      background-color: #e0e0e0;
    }
    .nav-item i {
      font-size: 22px;
      color: #999;
      display: block;
      margin-bottom: 2px;
      pointer-events: none;
    }
    .nav-item span {
      font-size: 12px;
      color: #999;
      pointer-events: none;
    }
    .nav-item.active span {
      color: #673ab7;
    }

    .floating-btn {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      width: 56px;
      height: 56px;
      background: #673ab7;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
      z-index: 1000;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .floating-btn:hover {
      transform: translateX(-50%) scale(1.05);
    }

    /* ä¸Šä¼ æŒ‰é’®æ ·å¼ */
    .upload-btn {
      background-color: #673ab7;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 4px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s;
      min-height: 32px;
      white-space: nowrap;
    }

    .upload-btn:hover {
      background-color: #5a2ca0;
    }

    /* éšè—åŸç”Ÿæ–‡ä»¶é€‰æ‹©æ¡† */
    #file-upload {
      display: none;
    }

    /* å¼¹çª—æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.show {
      opacity: 1;
    }

    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 12px;
      width: 300px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transform: scale(0.8) translateY(-20px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal.show .modal-content {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 12px;
      width: 300px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    .modal-btn.confirm {
      background: #ff4757;
      color: white;
    }

    .modal-btn.confirm:hover {
      background: #ff3742;
    }

    .modal-btn.cancel {
      background: #f1f2f6;
      color: #333;
    }

    .modal-btn.cancel:hover {
      background: #e9ecef;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* é€šçŸ¥æç¤ºæ ·å¼ */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      max-width: 300px;
      text-align: center;
    }

    .notification.success {
      background-color: #4caf50;
      color: white;
    }

    .notification.error {
      background-color: #f44336;
      color: white;
    }

    .notification.loading {
      background-color: #2196f3;
      color: white;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .notification.hide {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    /* å›¾ç‰‡åˆ‡æ¢åŠ¨ç”»æ ·å¼ */
    .outfit-image {
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: center;
    }

    .outfit-image.fade-out {
      opacity: 0;
      transform: scale(0.8) rotate(-5deg);
    }

    .outfit-image.fade-in {
      opacity: 1;
      transform: scale(1) rotate(0deg);
    }

    .outfit-image.loading {
      opacity: 0.6;
      transform: scale(0.95);
      filter: blur(1px);
    }

    .outfit-image.switching {
      animation: switching-animation 0.6s ease-in-out;
    }

    @keyframes switching-animation {
      0% {
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
      25% {
        opacity: 0.3;
        transform: scale(0.9) rotate(-3deg);
      }
      50% {
        opacity: 0.1;
        transform: scale(0.8) rotate(-5deg);
      }
      75% {
        opacity: 0.3;
        transform: scale(0.9) rotate(3deg);
      }
      100% {
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
    }

    .outfit-image.fit-mode {
      border: 3px solid #673ab7;
      box-shadow: 0 4px 20px rgba(103, 58, 183, 0.3);
    }

    .outfit-image.coord-mode {
      border: 2px dashed rgba(103, 58, 183, 0.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* åŠ è½½æŒ‡ç¤ºå™¨ */
    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 3px solid rgba(103, 58, 183, 0.2);
      border-top: 3px solid #673ab7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 10;
    }

    /* å›¾ç‰‡å®¹å™¨ç›¸å¯¹å®šä½ */
    .outfit-image-container {
      position: relative;
      display: inline-block;
    }

    /* åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .switch-mode-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(103, 58, 183, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      cursor: pointer;
      z-index: 9998;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .switch-mode-btn:hover {
      background: rgba(103, 58, 183, 1);
      transform: scale(1.1);
    }

    /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .mode-indicator {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      z-index: 9997;
    }
  </style>
</head>

<body>
    <div class="page-container">
      <!-- æœç´¢æ ä¸ä¸Šä¼ æŒ‰é’® -->
      <div class="header">
      <div class="search-box">
        <input type="text" placeholder="æœç´¢è¡£ç‰©">
        <div class="search-icon"></div>
      </div>
      <!-- ä¸Šä¼ æŒ‰é’® -->
      <label for="file-upload" class="upload-btn">
        <i>ğŸ“</i> ä¸Šä¼ 
      </label>
      <input type="file" id="file-upload" accept="image/*" multiple>
    </div>

    <!-- è¡£æŸœå†…å®¹åŒºåŸŸ -->
    <div class="closet-container">
      <!-- å·¦ä¾§åˆ†ç±»åˆ—è¡¨ï¼ˆå¯ç‚¹å‡»ï¼‰ -->
      <div class="category-list">
        <div class="category-item" data-category="Tæ¤">
          <img src="{% static 'closet_app/icon/T-shirt.png' %}" alt="Tæ¤" width="24" height="24">
          <span>Tæ¤</span>
        </div>
        <div class="category-item" data-category="å¤–å¥—">
          <img src="{% static 'closet_app/icon/coat.png' %}" alt="å¤–å¥—" width="24" height="24">
          <span>å¤–å¥—</span>
        </div>
        <div class="category-item" data-category="è¿è¡£è£™">
          <img src="{% static 'closet_app/icon/dress.png' %}" alt="è¿è¡£è£™" width="24" height="24">
          <span>è¿è¡£è£™</span>
        </div>
        <div class="category-item" data-category="å¼€è¡«">
          <img src="{% static 'closet_app/icon/cardigan.png' %}" alt="å¼€è¡«" width="24" height="24">
          <span>å¼€è¡«</span>
        </div>
        <div class="category-item" data-category="é•¿è£¤">
          <img src="{% static 'closet_app/icon/trousers.png' %}" alt="é•¿è£¤" width="24" height="24">
          <span>é•¿è£¤</span>
        </div>
        <div class="category-item" data-category="è¡¬è¡«">
          <img src="{% static 'closet_app/icon/shirt.png' %}" alt="è¡¬è¡«" width="24" height="24">
          <span>è¡¬è¡«</span>
        </div>
        <div class="category-item" data-category="çŸ­è£™">
          <img src="{% static 'closet_app/icon/short-skirt.png' %}" alt="çŸ­è£™" width="24" height="24">
          <span>çŸ­è£™</span>
        </div>
        <div class="category-item" data-category="æ­£è£…">
          <img src="{% static 'closet_app/icon/suit.png' %}" alt="æ­£è£…" width="24" height="24">
          <span>æ­£è£…</span>
        </div>
        <div class="category-item" data-category="çŸ­è£¤">
          <img src="{% static 'closet_app/icon/shorts.png' %}" alt="çŸ­è£¤" width="24" height="24">
          <span>çŸ­è£¤</span>
        </div>
        <div class="category-item" data-category="å«è¡£">
          <img src="{% static 'closet_app/icon/sweatshirt.png' %}" alt="å«è¡£" width="24" height="24">
          <span>å«è¡£</span>
        </div>
      </div>

      <!-- å³ä¾§å›¾ç‰‡åŒºåŸŸï¼ˆæŒ‰åˆ†ç±»æ˜¾ç¤ºï¼‰ -->
      <div class="clothes-container">
        {% for category, images in closet_images.items %}
          <!-- æ¯ä¸ªåˆ†ç±»å¯¹åº”ä¸€ä¸ªåŒºåŸŸï¼ŒIDä¸åˆ†ç±»åå…³è” -->
          <div class="category-section" id="section-{{ category }}">
            <h3 class="category-title">{{ category }}</h3>
            <div class="clothes-grid">
              {% for image_info in images %}
                <div class="clothes-item" data-filename="{{ image_info.filename }}" data-url="{{ image_info.url }}" oncontextmenu="event.preventDefault(); showDeleteConfirm('{{ image_info.filename }}', '{{ image_info.url }}')">
                  <img class="clothes-img" src="{{ image_info.url }}" alt="{{ category }}" title="{{ image_info.remark }}">
                </div>
              {% empty %}
                <div class="empty-message">æš‚æ— {{ category }}å›¾ç‰‡</div>
              {% endfor %}
            </div>
          </div>
        {% empty %}
          <div style="text-align: center; padding: 60px 20px; color: #666;">
            è¡£æŸœè¿˜æ˜¯ç©ºçš„ï¼Œå¿«å»æ·»åŠ è¡£ç‰©å§ï½
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªä¸æ‚¬æµ®æŒ‰é’® -->
    <div class="bottom-nav">
      <div class="nav-item">
        <a href="{% url 'index' %}" style="text-decoration: none;">
          <i>ğŸ </i>
          <span>home</span>
        </a>
      </div>
      <div class="nav-item active">
        <i>ğŸ‘•</i>
        <span>closet</span>
      </div>
      <div class="nav-item">
        <a href="{% url 'match' %}" style="text-decoration: none;">
          <i>â­ï¸</i>
          <span>favourite</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="{% url 'profile' %}" style="text-decoration: none;">
          <i>ğŸ‘¤</i>
          <span>profile</span>
        </a>
      </div>
    </div>

    <div class="floating-btn">
      <a href="{% url 'mirror' %}" style="text-decoration: none; color: white;">
        <i>ğŸª</i>
      </a>
    </div>
  <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">ç¡®è®¤åˆ é™¤</div>
      <p>æ˜¯å¦ç¡®è®¤åˆ é™¤è¿™ä»¶è¡£ç‰©ï¼Ÿ</p>
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
        <button class="modal-btn cancel" onclick="closeDeleteModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- æ¨èæ­é…å¼¹çª— -->
  <div id="recomModal" class="modal"></div>

  <!-- åˆ†ç±»åˆ‡æ¢çš„JavaScript -->
  <script>
    // å…¨å±€é”™è¯¯å¤„ç†å™¨
    window.addEventListener('error', function(e) {
      console.error('JavaScripté”™è¯¯:', e.error);
      console.error('é”™è¯¯ä¿¡æ¯:', e.message);
      console.error('é”™è¯¯æ–‡ä»¶:', e.filename);
      console.error('é”™è¯¯è¡Œå·:', e.lineno);
      console.error('é”™è¯¯åˆ—å·:', e.colno);
    });
    
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      // è·å–æ‰€æœ‰åˆ†ç±»é¡¹å’Œåˆ†ç±»åŒºåŸŸ
      const categoryItems = document.querySelectorAll('.category-item');
      const categorySections = document.querySelectorAll('.category-section');

      // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰åˆ†ç±»ä¿¡æ¯
      const urlParams = new URLSearchParams(window.location.search);
      const targetCategory = urlParams.get('category');
      
      if (targetCategory) {
        // å¦‚æœæœ‰ç›®æ ‡åˆ†ç±»ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°è¯¥åˆ†ç±»
        console.log(`è‡ªåŠ¨è·³è½¬åˆ°åˆ†ç±»: ${targetCategory}`);
        
        // æŸ¥æ‰¾å¯¹åº”çš„åˆ†ç±»é¡¹
        const targetCategoryItem = Array.from(categoryItems).find(item => 
          item.getAttribute('data-category') === targetCategory
        );
        
        if (targetCategoryItem) {
          // ç§»é™¤æ‰€æœ‰åˆ†ç±»é¡¹çš„é€‰ä¸­çŠ¶æ€
          categoryItems.forEach(i => i.classList.remove('active'));
          // ç»™ç›®æ ‡åˆ†ç±»é¡¹æ·»åŠ é€‰ä¸­çŠ¶æ€
          targetCategoryItem.classList.add('active');
          
          // éšè—æ‰€æœ‰åˆ†ç±»åŒºåŸŸ
          categorySections.forEach(section => {
            section.classList.remove('active');
          });
          
          // æ˜¾ç¤ºå¯¹åº”çš„åˆ†ç±»åŒºåŸŸ
          const targetSection = document.getElementById(`section-${targetCategory}`);
          if (targetSection) {
            targetSection.classList.add('active');
            
            // è‡ªåŠ¨è·³è½¬å®Œæˆï¼Œç”¨æˆ·å¯ä»¥æ»‘åŠ¨æŸ¥çœ‹è¡£ç‰©
            console.log(`å·²è‡ªåŠ¨è·³è½¬åˆ°${targetCategory}åˆ†ç±»`);
          }
          
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          showNotification(`å·²è‡ªåŠ¨è·³è½¬åˆ°${targetCategory}åˆ†ç±»`, 'success');
        } else {
          console.warn(`æœªæ‰¾åˆ°åˆ†ç±»: ${targetCategory}`);
          // å¦‚æœæ²¡æ‰¾åˆ°ç›®æ ‡åˆ†ç±»ï¼Œä½¿ç”¨é»˜è®¤é€»è¾‘
          if (categoryItems.length > 0 && categorySections.length > 0) {
            categoryItems[0].classList.add('active');
            categorySections[0].classList.add('active');
          }
        }
      } else {
        // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªåˆ†ç±»ï¼ˆå¦‚æœæœ‰åˆ†ç±»çš„è¯ï¼‰
        if (categoryItems.length > 0 && categorySections.length > 0) {
          categoryItems[0].classList.add('active');
          categorySections[0].classList.add('active');
        }
      }

      // ç»™æ¯ä¸ªåˆ†ç±»é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
      categoryItems.forEach(item => {
        item.addEventListener('click', function() {
          // è·å–å½“å‰ç‚¹å‡»çš„åˆ†ç±»åç§°
          const category = this.getAttribute('data-category');
          
          // ç§»é™¤æ‰€æœ‰åˆ†ç±»é¡¹çš„é€‰ä¸­çŠ¶æ€
          categoryItems.forEach(i => i.classList.remove('active'));
          // ç»™å½“å‰ç‚¹å‡»çš„åˆ†ç±»é¡¹æ·»åŠ é€‰ä¸­çŠ¶æ€
          this.classList.add('active');
          
          // éšè—æ‰€æœ‰åˆ†ç±»åŒºåŸŸ
          categorySections.forEach(section => {
            if (section.classList.contains('active')) {
              // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
              section.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              section.style.opacity = '0';
              section.style.transform = 'translateY(-10px)';
              
              setTimeout(() => {
                section.classList.remove('active');
                section.style.transition = '';
                section.style.opacity = '';
                section.style.transform = '';
              }, 300);
            }
          });
          
          // æ˜¾ç¤ºå¯¹åº”çš„åˆ†ç±»åŒºåŸŸ
          const targetSection = document.getElementById(`section-${category}`);
          if (targetSection) {
            // æ·»åŠ æ·¡å…¥åŠ¨ç”»
            targetSection.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            targetSection.style.opacity = '0';
            targetSection.style.transform = 'translateY(10px)';
            
            targetSection.classList.add('active');
            
            setTimeout(() => {
              targetSection.style.opacity = '1';
              targetSection.style.transform = 'translateY(0)';
              
              setTimeout(() => {
                targetSection.style.transition = '';
                targetSection.style.opacity = '';
                targetSection.style.transform = '';
              }, 300);
            }, 50);
            
            // ç±»åˆ«åˆ‡æ¢å®Œæˆï¼Œç”¨æˆ·å¯ä»¥æ»‘åŠ¨æŸ¥çœ‹è¡£ç‰©
            console.log(`å·²åˆ‡æ¢åˆ°${category}åˆ†ç±»`);
          }
        });
      });
    
      // æ–°å¢ï¼šæ–‡ä»¶ä¸Šä¼ é€»è¾‘
      const fileInput = document.getElementById('file-upload');
      fileInput.addEventListener('change', function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        // 1. æ˜¾ç¤ºä¸Šä¼ æç¤º
        showNotification(`å·²é€‰æ‹© ${files.length} å¼ å›¾ç‰‡ï¼Œå³å°†ä¸Šä¼ ...`, 'success');

        // 2. é€ä¸ªä¸Šä¼ æ–‡ä»¶
        for (let i = 0; i < files.length; i++) {
          const formData = new FormData();
          formData.append('image', files[i]);

          // 3. å‘é€ä¸Šä¼ è¯·æ±‚åˆ°æ–°çš„äº‘ç«¯ä¸Šä¼ æ¥å£
          fetch("{% url 'upload_clothes' %}", {
            method: 'POST',
            body: formData,
          })
          .then(response => {
            if (!response.ok) throw new Error('ä¸Šä¼ å¤±è´¥');
            return response.json();
          })
          .then(data => {
            if (data.success) {
              showNotification(`ç¬¬${i+1}å¼ å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼åˆ†ç±»ç»“æœï¼š${data.label}`, 'success');
              
              // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç±»ä¿¡æ¯ï¼Œå¦‚æœæœ‰åˆ™è·³è½¬åˆ°å¯¹åº”åˆ†ç±»
              if (data.closet_category) {
                showNotification(`å·²å°†æ–°ä¸Šä¼ çš„è¡£ç‰©åˆ†ç±»ä¸º${data.closet_category}`, 'success');
                
                // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                setTimeout(() => {
                  // è·³è½¬åˆ°closeté¡µé¢å¹¶ä¼ é€’åˆ†ç±»å‚æ•°
                  window.location.href = `{% url 'closet' %}?category=${encodeURIComponent(data.closet_category)}`;
                }, 1500);
              } else {
                // å¦‚æœæ²¡æœ‰åˆ†ç±»ä¿¡æ¯ï¼Œåˆ·æ–°é¡µé¢
                setTimeout(() => {
                  window.location.reload();
                }, 1000);
              }
            } else {
              showNotification(`ç¬¬${i+1}å¼ å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š${data.error}`, 'error');
            }
          })
          .catch(error => {
            console.error('ä¸Šä¼ é”™è¯¯ï¼š', error);
            showNotification(`ç¬¬${i+1}å¼ å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•`, 'error');
          });
        }

        // 4. æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼ˆå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶ï¼‰
        fileInput.value = '';
      });
    });

    // è¡£ç‰©å›¾ç‰‡ç‚¹å‡»å¼¹çª—æ¨èæ­é…ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
    document.addEventListener('click', function(e) {
      console.log('=== å…¨å±€ç‚¹å‡»äº‹ä»¶è¢«è§¦å‘ ===');
      console.log('ç‚¹å‡»äº‹ä»¶è¢«è§¦å‘ï¼Œç›®æ ‡å…ƒç´ :', e.target); // æ·»åŠ è°ƒè¯•æ—¥å¿—
      console.log('ç›®æ ‡å…ƒç´ çš„classList:', e.target.classList);
      console.log('ç›®æ ‡å…ƒç´ çš„tagName:', e.target.tagName);
      
      // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è¡£ç‰©å›¾ç‰‡å®¹å™¨
      const clothesItem = e.target.closest('.clothes-item');
      console.log('æ‰¾åˆ°çš„clothes-item:', clothesItem); // æ·»åŠ è°ƒè¯•æ—¥å¿—
      
      if (clothesItem) {
        const filename = clothesItem.getAttribute('data-filename');
        const url = clothesItem.getAttribute('data-url');
        console.log('è·å–åˆ°çš„filename:', filename); // æ·»åŠ è°ƒè¯•æ—¥å¿—
        console.log('è·å–åˆ°çš„url:', url); // æ·»åŠ è°ƒè¯•æ—¥å¿—
        
        if (filename) {
          console.log('å‡†å¤‡è°ƒç”¨showRecomModal'); // æ·»åŠ è°ƒè¯•æ—¥å¿—
          showRecomModal(filename).catch(error => {
            console.error('æ˜¾ç¤ºæ¨èå¼¹çª—å¤±è´¥:', error);
          });
        } else {
          console.log('filenameä¸ºç©ºï¼Œä¸è°ƒç”¨showRecomModal');
        }
      } else {
        console.log('æœªæ‰¾åˆ°clothes-itemå…ƒç´ ');
      }
    });

    // åˆ é™¤åŠŸèƒ½ç›¸å…³å˜é‡
    let currentDeleteFilename = '';
    let currentDeleteUrl = '';

    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¼¹çª—
    function showDeleteConfirm(filename, url) {
      currentDeleteFilename = filename;
      currentDeleteUrl = url;
      const modal = document.getElementById('deleteModal');
      modal.style.display = 'block';
      
      // æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        modal.classList.add('show');
      }, 10);
    }

    // å…³é—­åˆ é™¤ç¡®è®¤å¼¹çª—
    function closeDeleteModal() {
      const modal = document.getElementById('deleteModal');
      modal.classList.remove('show');
      
      // ç­‰å¾…åŠ¨ç”»å®Œæˆåéšè—
      setTimeout(() => {
        modal.style.display = 'none';
        currentDeleteFilename = '';
        currentDeleteUrl = '';
      }, 300);
    }

    // ç¡®è®¤åˆ é™¤è¡£ç‰©
    function confirmDelete() {
      if (!currentDeleteFilename) {
        showNotification('åˆ é™¤å¤±è´¥ï¼šæœªæ‰¾åˆ°è¡£ç‰©ä¿¡æ¯','error');
        closeDeleteModal();
        return;
      }

      // å‘é€åˆ é™¤è¯·æ±‚åˆ°åç«¯
      fetch("{% url 'closet_delete' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          id: currentDeleteFilename
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotification('è¡£ç‰©åˆ é™¤æˆåŠŸï¼','success');
          // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ›´æ–°åçš„è¡£æŸœ
          window.location.reload();
        } else {
          showNotification('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'),'error');
        }
      })
      .catch(error => {
        console.error('åˆ é™¤é”™è¯¯ï¼š', error);
        showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•','error');
      })
      .finally(() => {
        closeDeleteModal();
      });
    }

    // è·å–CSRF Tokençš„è¾…åŠ©å‡½æ•°
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
    window.onclick = function(event) {
      const modal = document.getElementById('deleteModal');
      if (event.target === modal) {
        closeDeleteModal();
      }
    }

    // æ¨èæ­é…å¼¹çª—
    async function showRecomModal(filename) {
      console.log('=== showRecomModalå‡½æ•°è¢«è°ƒç”¨ ===');
      console.log('ä¼ å…¥çš„filename:', filename);
      console.log('å‡½æ•°è°ƒç”¨æ ˆ:', new Error().stack);
      
      // è§£æä¸»æ–‡ä»¶åï¼ˆå»é™¤æ‰©å±•åï¼‰
      const base = filename.replace(/\.[^.]+$/, '');
      const img1 = `/static/recoms/${base}/${base}-COORD1.jpg`;
      const img2 = `/static/recoms/${base}/${base}-COORD2.jpg`;
      
      console.log('å›¾ç‰‡è·¯å¾„:', img1, img2); // æ·»åŠ è°ƒè¯•æ—¥å¿—
      console.log('åŸºç¡€æ–‡ä»¶å:', base); // æ·»åŠ è°ƒè¯•æ—¥å¿—
      
      // ç§»é™¤å·²æœ‰å¼¹çª—
      const old = document.getElementById('recomModal');
      if (old) old.remove();
      
      // åˆ›å»ºå¼¹çª—
      const modal = document.createElement('div');
      modal.id = 'recomModal';
      modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);`;
      
      // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ˜¾ç¤ºå ä½å›¾
      const placeholderImg = `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(`
        <svg width="150" height="260" xmlns="http://www.w3.org/2000/svg">
          <rect width="150" height="260" fill="#f5f5f5" stroke="#ddd" stroke-width="2" stroke-dasharray="5,5"/>
          <text x="75" y="130" text-anchor="middle" fill="#999" font-size="12" font-family="Arial">å½“å‰çš„è¡£ç‰©æ•°é‡ä¸è¶³</text>
          <text x="75" y="150" text-anchor="middle" fill="#999" font-size="12" font-family="Arial">ç‚¹å‡»ä¸‹æ–¹åˆ·æ–°é‡è¯•</text>
        </svg>
      `)))}`;
      
      // æ·»åŠ æ—¶é—´æˆ³é¿å…æµè§ˆå™¨ç¼“å­˜
      const timestamp = new Date().getTime();
      const img1WithTimestamp = `${img1}?t=${timestamp}`;
      const img2WithTimestamp = `${img2}?t=${timestamp}`;
      
      console.log('å¸¦æ—¶é—´æˆ³çš„å›¾ç‰‡è·¯å¾„:', img1WithTimestamp, img2WithTimestamp); // æ·»åŠ è°ƒè¯•æ—¥å¿—
      
      // å¼ºåˆ¶æ¸…é™¤ç›¸å…³å›¾ç‰‡çš„ç¼“å­˜
      await clearImageCache(base);
      
      modal.innerHTML = `
        <div style="background:rgba(255,255,255,0.8);backdrop-filter:blur(10px);border-radius:20px;padding:24px 16px;max-width:420px;width:90vw;display:flex;flex-direction:column;gap:18px;box-shadow:0 8px 32px rgba(0,0,0,0.3);position:relative;transform:scale(0.8) translateY(-20px);opacity:0;transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);" id="recomModalContent">
          <button onclick="closeRecomModal()" style="position:absolute;top:10px;right:10px;background:rgba(255,255,255,0.9);border:none;font-size:24px;color:#999;cursor:pointer;width:32px;height:32px;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:all 0.2s ease;z-index:9999;">Ã—</button>
          
          <div style="display:flex;flex-direction:row;gap:18px;">
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <div class="outfit-image-container">
                <img src="${img1WithTimestamp}" alt="æ­é…1" class="outfit-image coord-mode" style="width:100%;max-width:150px;max-height:260px;border-radius:12px;object-fit:contain;background:rgba(245,245,245,0.8);margin-bottom:8px;cursor:pointer;" onerror="this.src='${placeholderImg}';this.onerror=null;" onclick="handleOutfitImageClick('${base}', '${base}-COORD1.jpg', this)" data-filename="${base}-COORD1.jpg" data-base="${base}">
                <div class="mode-indicator">æ­é…</div>
                <button class="switch-mode-btn" onclick="toggleImageMode(this.parentElement.querySelector('.outfit-image'))" title="åˆ‡æ¢æ¨¡å¼">ğŸ”„</button>
              </div>
              <div style="text-align:center;font-size:13px;color:#673ab7;font-weight:bold;">æ¨èæ­é…1</div>
            </div>
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <div class="outfit-image-container">
                <img src="${img2WithTimestamp}" alt="æ­é…2" class="outfit-image coord-mode" style="width:100%;max-width:150px;max-height:260px;border-radius:12px;object-fit:contain;background:rgba(245,245,245,0.8);margin-bottom:8px;cursor:pointer;" onerror="this.src='${placeholderImg}';this.onerror=null;" onclick="handleOutfitImageClick('${base}', '${base}-COORD2.jpg', this)" data-filename="${base}-COORD2.jpg" data-base="${base}">
                <div class="mode-indicator">æ­é…</div>
                <button class="switch-mode-btn" onclick="toggleImageMode(this.parentElement.querySelector('.outfit-image'))" title="åˆ‡æ¢æ¨¡å¼">ğŸ”„</button>
              </div>
              <div style="text-align:center;font-size:13px;color:#673ab7;font-weight:bold;">æ¨èæ­é…2</div>
            </div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:center;">
            <button onclick="refreshOutfitRecommendations('${filename}')" style="background:linear-gradient(135deg,#673ab7,#9c27b0);color:white;border:none;border-radius:20px;padding:12px 24px;font-size:14px;font-weight:bold;cursor:pointer;box-shadow:0 4px 12px rgba(103,58,183,0.3);transition:all 0.3s ease;">
              <span>ğŸ”„ åˆ·æ–°æ¨èæ­é…</span>
            </button>
            <button onclick="showDeleteConfirm('${filename}', ''); document.getElementById('recomModal').remove();" style="background:linear-gradient(135deg,#ff4757,#ff3742);color:white;border:none;border-radius:20px;padding:12px 24px;font-size:14px;font-weight:bold;cursor:pointer;box-shadow:0 4px 12px rgba(255,71,87,0.3);transition:all 0.3s ease;">
              <span>ğŸ—‘ï¸ åˆ é™¤è¡£ç‰©</span>
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      console.log('å¼¹çª—å·²åˆ›å»ºå¹¶æ·»åŠ åˆ°é¡µé¢'); // æ·»åŠ è°ƒè¯•æ—¥å¿—
      
      // æ£€æŸ¥äº‹ä»¶ç»‘å®š
      setTimeout(() => {
        const buttons = modal.querySelectorAll('.switch-mode-btn');
        console.log('æ‰¾åˆ°åˆ‡æ¢æŒ‰é’®æ•°é‡:', buttons.length);
        
        buttons.forEach((button, index) => {
          console.log(`æŒ‰é’® ${index + 1} çš„ onclick å±æ€§:`, button.getAttribute('onclick'));
          
          // æ·»åŠ é¢å¤–çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ä½œä¸ºå¤‡ç”¨
          button.addEventListener('click', function(e) {
            console.log('æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆé€šè¿‡addEventListenerï¼‰');
            const imgElement = this.parentElement.querySelector('.outfit-image');
            console.log('æ‰¾åˆ°çš„imgElement:', imgElement);
            if (imgElement) {
              toggleImageMode(imgElement);
            }
          });
        });
      }, 100);
      
      // æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        const content = document.getElementById('recomModalContent');
        if (content) {
          content.style.transform = 'scale(1) translateY(0)';
          content.style.opacity = '1';
        }
      }, 10);
      
      // ç‚¹å‡»é®ç½©å…³é—­
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeRecomModal();
      });
    }

    // å…³é—­æ¨èæ­é…å¼¹çª—
    function closeRecomModal() {
      const modal = document.getElementById('recomModal');
      const content = document.getElementById('recomModalContent');
      
      if (content) {
        content.style.transform = 'scale(0.8) translateY(-20px)';
        content.style.opacity = '0';
      }
      
      setTimeout(() => {
        if (modal && modal.parentNode) {
          modal.remove();
        }
      }, 400);
    }
    
    // æ˜¾ç¤ºé€šçŸ¥æç¤º
    function showNotification(message, type = 'info') {
      // ç§»é™¤ä¹‹å‰çš„é€šçŸ¥
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // åˆ›å»ºæ–°é€šçŸ¥
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      // æ ¹æ®ç±»å‹æ·»åŠ å›¾æ ‡
      let icon = '';
      if (type === 'loading') {
        icon = '<div class="loading-spinner"></div>';
      } else if (type === 'success') {
        icon = 'âœ… ';
      } else if (type === 'error') {
        icon = 'âŒ ';
      }
      
      notification.innerHTML = `${icon}${message}`;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(notification);
      
      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);
      
      // è‡ªåŠ¨éšè—ï¼ˆé™¤äº†loadingç±»å‹ï¼‰
      if (type !== 'loading') {
        setTimeout(() => {
          notification.classList.add('hide');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }, 3000);
      }
      
      return notification;
    }

    // å¤„ç†æ­é…å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
    async function handleOutfitImageClick(baseFilename, coordFilename, imgElement) {
      console.log('=== å¤„ç†æ­é…å›¾ç‰‡ç‚¹å‡»äº‹ä»¶ ===');
      console.log('åŸºç¡€æ–‡ä»¶å:', baseFilename);
      console.log('æ­é…æ–‡ä»¶å:', coordFilename);
      
      // æ£€æŸ¥å½“å‰æ˜¾ç¤ºçš„æ˜¯æ­é…å›¾è¿˜æ˜¯è¯•ç©¿å›¾
      const isShowingFit = imgElement.getAttribute('data-showing-fit') === 'true';
      
      if (isShowingFit) {
        // å½“å‰æ˜¾ç¤ºè¯•ç©¿å›¾ï¼Œåˆ‡æ¢å›æ­é…å›¾
        await switchToCoordMode(imgElement, baseFilename, coordFilename);
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯¹åº”çš„è¯•ç©¿å›¾åƒ
      const fitFilename = coordFilename.replace('.jpg', '_FIT.jpg');
      const fitPath = `/static/recoms/${baseFilename}/${fitFilename}`;
      const coordPath = `/static/recoms/${baseFilename}/${coordFilename}`;
      
      console.log('è¯•ç©¿å›¾åƒè·¯å¾„:', fitPath);
      console.log('æ­é…å›¾åƒè·¯å¾„:', coordPath);
      
      // æ£€æŸ¥è¯•ç©¿å›¾åƒæ˜¯å¦å­˜åœ¨
      try {
        // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
        const fitPathWithTimestamp = fitPath + '?t=' + Date.now();
        console.log('æ£€æŸ¥FITæ–‡ä»¶ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰:', fitPathWithTimestamp);
        
        const fitResponse = await fetch(fitPathWithTimestamp, { 
          method: 'HEAD',
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        
        console.log('FITæ–‡ä»¶æ£€æŸ¥å“åº”çŠ¶æ€:', fitResponse.status);
        console.log('FITæ–‡ä»¶æ£€æŸ¥å“åº”å¤´:', Object.fromEntries(fitResponse.headers.entries()));
        
        const fitExists = fitResponse.ok;
        
        console.log('FITæ–‡ä»¶æ£€æŸ¥ç»“æœ:', fitExists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
        
        if (fitExists) {
          console.log('è¯•ç©¿å›¾åƒå­˜åœ¨ï¼Œåˆ‡æ¢åˆ°è¯•ç©¿æ•ˆæœ');
          // è¯•ç©¿å›¾åƒå­˜åœ¨ï¼Œåˆ‡æ¢åˆ°è¯•ç©¿æ•ˆæœ
          await switchToFitMode(imgElement, fitPathWithTimestamp);
        } else {
          console.log('è¯•ç©¿å›¾åƒä¸å­˜åœ¨ï¼Œç”Ÿæˆè¯•ç©¿æ•ˆæœ');
          // è¯•ç©¿å›¾åƒä¸å­˜åœ¨ï¼Œç”Ÿæˆè¯•ç©¿æ•ˆæœ
          await generateTryOnImage(baseFilename, coordFilename, imgElement);
        }
      } catch (error) {
        console.log('æ£€æŸ¥è¯•ç©¿å›¾åƒå¤±è´¥ï¼Œç”Ÿæˆæ–°çš„è¯•ç©¿æ•ˆæœ:', error);
        // æ£€æŸ¥å¤±è´¥ï¼Œç”Ÿæˆæ–°çš„è¯•ç©¿æ•ˆæœ
        await generateTryOnImage(baseFilename, coordFilename, imgElement);
      }
    }

    // åˆ‡æ¢åˆ°è¯•ç©¿æ¨¡å¼
    async function switchToFitMode(imgElement, fitPath) {
      console.log('=== åˆ‡æ¢åˆ°è¯•ç©¿æ¨¡å¼ ===');
      console.log('ä¼ å…¥çš„fitPath:', fitPath);
      
      // æ·»åŠ åˆ‡æ¢åŠ¨ç”»
      imgElement.classList.add('switching');
      
      // ç­‰å¾…åŠ¨ç”»å¼€å§‹
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // åˆ‡æ¢å›¾ç‰‡æºï¼ˆå¦‚æœè·¯å¾„å·²ç»åŒ…å«æ—¶é—´æˆ³ï¼Œå°±ç›´æ¥ä½¿ç”¨ï¼‰
      let fitPathWithTimestamp = fitPath;
      if (!fitPath.includes('?t=')) {
        const timestamp = Date.now();
        fitPathWithTimestamp = fitPath.includes('?') ? 
          fitPath + '&t=' + timestamp : 
          fitPath + '?t=' + timestamp;
      }
      
      console.log('æœ€ç»ˆä½¿ç”¨çš„å›¾ç‰‡è·¯å¾„:', fitPathWithTimestamp);
      imgElement.src = fitPathWithTimestamp;
      imgElement.setAttribute('data-showing-fit', 'true');
      
      // æ›´æ–°æ ·å¼ç±»
      imgElement.classList.remove('coord-mode');
      imgElement.classList.add('fit-mode');
      
      // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
      const indicator = imgElement.parentElement.querySelector('.mode-indicator');
      if (indicator) {
        indicator.textContent = 'è¯•ç©¿';
        indicator.style.background = 'rgba(103, 58, 183, 0.8)';
      }
      
      // ç­‰å¾…åŠ¨ç”»å®Œæˆ
      setTimeout(() => {
        imgElement.classList.remove('switching');
      }, 600);
      
      showNotification('å·²åˆ‡æ¢åˆ°è¯•ç©¿æ•ˆæœ', 'success');
    }

    // åˆ‡æ¢åˆ°æ­é…æ¨¡å¼
    async function switchToCoordMode(imgElement, baseFilename, coordFilename) {
      // æ·»åŠ åˆ‡æ¢åŠ¨ç”»
      imgElement.classList.add('switching');
      
      // ç­‰å¾…åŠ¨ç”»å¼€å§‹
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // åˆ‡æ¢å›¾ç‰‡æº
      const coordPath = `/static/recoms/${baseFilename}/${coordFilename}`;
      imgElement.src = coordPath;
      imgElement.removeAttribute('data-showing-fit');
      
      // æ›´æ–°æ ·å¼ç±»
      imgElement.classList.remove('fit-mode');
      imgElement.classList.add('coord-mode');
      
      // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
      const indicator = imgElement.parentElement.querySelector('.mode-indicator');
      if (indicator) {
        indicator.textContent = 'æ­é…';
        indicator.style.background = 'rgba(0, 0, 0, 0.7)';
      }
      
      // ç­‰å¾…åŠ¨ç”»å®Œæˆ
      setTimeout(() => {
        imgElement.classList.remove('switching');
      }, 600);
      
      showNotification('å·²åˆ‡æ¢å›æ­é…æ•ˆæœ', 'success');
    }

    // åˆ‡æ¢å›¾ç‰‡æ¨¡å¼ï¼ˆé€šè¿‡æŒ‰é’®ï¼‰
    async function toggleImageMode(imgElement) {
      const baseFilename = imgElement.getAttribute('data-base');
      const coordFilename = imgElement.getAttribute('data-filename');
      const isShowingFit = imgElement.getAttribute('data-showing-fit') === 'true';
      
      if (isShowingFit) {
        await switchToCoordMode(imgElement, baseFilename, coordFilename);
      } else {
        const fitFilename = coordFilename.replace('.jpg', '_FIT.jpg');
        const fitPath = `/static/recoms/${baseFilename}/${fitFilename}`;
        
        console.log('=== å¼€å§‹æ£€æŸ¥FITæ–‡ä»¶ ===');
        console.log('åŸºç¡€æ–‡ä»¶å:', baseFilename);
        console.log('æ­é…æ–‡ä»¶å:', coordFilename);
        console.log('æœŸæœ›çš„FITæ–‡ä»¶:', fitFilename);
        console.log('FITæ–‡ä»¶è·¯å¾„:', fitPath);
        
        try {
          // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
          const fitPathWithTimestamp = fitPath + '?t=' + Date.now();
          console.log('æ£€æŸ¥FITæ–‡ä»¶ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰:', fitPathWithTimestamp);
          
          const fitResponse = await fetch(fitPathWithTimestamp, { 
            method: 'HEAD',
            cache: 'no-cache',
            headers: {
              'Cache-Control': 'no-cache, no-store, must-revalidate',
              'Pragma': 'no-cache',
              'Expires': '0'
            }
          });
          
          console.log('FITæ–‡ä»¶æ£€æŸ¥å“åº”çŠ¶æ€:', fitResponse.status);
          console.log('FITæ–‡ä»¶æ£€æŸ¥å“åº”å¤´:', Object.fromEntries(fitResponse.headers.entries()));
          
          const fitExists = fitResponse.ok;
          
          console.log('FITæ–‡ä»¶æ£€æŸ¥ç»“æœ:', fitExists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
          
          if (fitExists) {
            console.log('FITæ–‡ä»¶å­˜åœ¨ï¼Œåˆ‡æ¢åˆ°è¯•ç©¿æ¨¡å¼');
            await switchToFitMode(imgElement, fitPathWithTimestamp);
          } else {
            console.log('FITæ–‡ä»¶ä¸å­˜åœ¨ï¼Œç«‹å³è°ƒç”¨8899ç«¯å£ç”Ÿæˆæ–°è¯•ç©¿å›¾åƒ');
            await generateTryOnImage(baseFilename, coordFilename, imgElement);
          }
        } catch (error) {
          console.log('æ£€æŸ¥FITæ–‡ä»¶å¤±è´¥ï¼Œç«‹å³è°ƒç”¨8899ç«¯å£ç”Ÿæˆæ–°è¯•ç©¿å›¾åƒ:', error);
          await generateTryOnImage(baseFilename, coordFilename, imgElement);
        }
      }
    }
    
    // ç”Ÿæˆè¯•ç©¿å›¾åƒ
    async function generateTryOnImage(baseFilename, coordFilename, imgElement) {
      try {
        console.log('=== å¼€å§‹ç”Ÿæˆè¯•ç©¿å›¾åƒ ===');
        console.log('åŸºç¡€æ–‡ä»¶å:', baseFilename);
        console.log('æ­é…æ–‡ä»¶å:', coordFilename);
        console.log('ç›®æ ‡å…ƒç´ :', imgElement);
        
        // æ·»åŠ åŠ è½½çŠ¶æ€
        imgElement.classList.add('loading');
        
        // æ˜¾ç¤ºåŠ è½½é€šçŸ¥
        showNotification('æ­£åœ¨ç”Ÿæˆè¯•ç©¿æ•ˆæœï¼Œè¯·ç¨å€™...', 'loading');
        
        console.log('è°ƒç”¨åç«¯APIç”Ÿæˆè¯•ç©¿å›¾åƒ...');
        // è°ƒç”¨åç«¯APIç”Ÿæˆè¯•ç©¿å›¾åƒ
        const response = await fetch("{% url 'generate_try_on_image' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            coord_filename: coordFilename,
            base_filename: baseFilename
          })
        });
        
        const result = await response.json();
        console.log('åç«¯APIå“åº”:', result);
        
        if (result.success) {
          // ç”ŸæˆæˆåŠŸï¼Œæ˜¾ç¤ºè¯•ç©¿å›¾åƒ
          const fitPath = result.fit_path;
          console.log('è¯•ç©¿å›¾åƒç”ŸæˆæˆåŠŸï¼Œè·¯å¾„:', fitPath);
          
          // æ·»åŠ åˆ‡æ¢åŠ¨ç”»
          imgElement.classList.add('switching');
          imgElement.classList.remove('loading');
          
          // ç­‰å¾…åŠ¨ç”»å¼€å§‹
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // åˆ‡æ¢å›¾ç‰‡æºï¼ˆæ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜ï¼‰
          const timestamp = Date.now();
          const fitPathWithTimestamp = fitPath + '?t=' + timestamp;
          
          // ç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå†è®¾ç½®src
          const img = new Image();
          img.onload = function() {
            imgElement.src = fitPathWithTimestamp;
            imgElement.setAttribute('data-showing-fit', 'true');
            
            // æ›´æ–°æ ·å¼ç±»
            imgElement.classList.remove('coord-mode');
            imgElement.classList.add('fit-mode');
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const indicator = imgElement.parentElement.querySelector('.mode-indicator');
            if (indicator) {
              indicator.textContent = 'è¯•ç©¿';
              indicator.style.background = 'rgba(103, 58, 183, 0.8)';
            }
            
            // ç­‰å¾…åŠ¨ç”»å®Œæˆ
            setTimeout(() => {
              imgElement.classList.remove('switching');
            }, 600);
            
            showNotification('è¯•ç©¿æ•ˆæœç”ŸæˆæˆåŠŸï¼', 'success');
          };
          
          img.onerror = function() {
            console.error('è¯•ç©¿å›¾åƒåŠ è½½å¤±è´¥:', fitPathWithTimestamp);
            imgElement.classList.remove('loading');
            showNotification('è¯•ç©¿å›¾åƒåŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
          };
          
          // å¼€å§‹åŠ è½½å›¾ç‰‡
          img.src = fitPathWithTimestamp;
        } else {
          // ç”Ÿæˆå¤±è´¥
          imgElement.classList.remove('loading');
          showNotification('è¯•ç©¿æ•ˆæœç”Ÿæˆå¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
        
      } catch (error) {
        console.error('ç”Ÿæˆè¯•ç©¿å›¾åƒå¤±è´¥:', error);
        imgElement.classList.remove('loading');
        showNotification('ç”Ÿæˆè¯•ç©¿æ•ˆæœå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // æ¸…é™¤å›¾ç‰‡ç¼“å­˜
    async function clearImageCache(baseFilename) {
      try {
        console.log('å¼€å§‹æ¸…é™¤å›¾ç‰‡ç¼“å­˜:', baseFilename);
        
        // 1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ä¸­çš„å›¾ç‰‡
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          for (const cacheName of cacheNames) {
            const cache = await caches.open(cacheName);
            const requests = await cache.keys();
            
            for (const request of requests) {
              const url = request.url;
              // æ¸…é™¤ç‰¹å®šç›®å½•ä¸‹çš„å›¾ç‰‡ç¼“å­˜
              if (url.includes(`/static/recoms/${baseFilename}/`)) {
                await cache.delete(request);
                console.log('å·²æ¸…é™¤ç¼“å­˜:', url);
              }
            }
          }
        }
        
        // 2. æ¸…é™¤localStorageä¸­çš„ç›¸å…³æ•°æ®
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.includes('image') || key.includes('cache') || key.includes(baseFilename))) {
            localStorage.removeItem(key);
            console.log('å·²æ¸…é™¤localStorage:', key);
          }
        }
        
        // 3. æ¸…é™¤sessionStorageä¸­çš„ç›¸å…³æ•°æ®
        for (let i = 0; i < sessionStorage.length; i++) {
          const key = sessionStorage.key(i);
          if (key && (key.includes('image') || key.includes('cache') || key.includes(baseFilename))) {
            sessionStorage.removeItem(key);
            console.log('å·²æ¸…é™¤sessionStorage:', key);
          }
        }
        
        // 4. æ¸©å’Œåœ°æ¸…é™¤DOMä¸­çš„å›¾ç‰‡ç¼“å­˜ï¼ˆåªæ¸…é™¤æ­é…å›¾ç‰‡ï¼Œä¸æ¸…é™¤è¯•ç©¿å›¾ç‰‡ï¼‰
        const images = document.querySelectorAll('img');
        for (const img of images) {
          const src = img.src;
          if (src && src.includes(`/static/recoms/${baseFilename}/`) && !src.includes('_FIT.jpg')) {
            // åªå¯¹æ­é…å›¾ç‰‡æ·»åŠ æ—¶é—´æˆ³ï¼Œé¿å…å½±å“è¯•ç©¿å›¾ç‰‡
            const separator = src.includes('?') ? '&' : '?';
            img.src = src + separator + 't=' + Date.now();
            console.log('å¼ºåˆ¶é‡æ–°åŠ è½½æ­é…å›¾ç‰‡:', src);
          }
        }
        
        // 5. æ¸…é™¤fetchç¼“å­˜ï¼ˆé€šè¿‡å‘é€HEADè¯·æ±‚ï¼‰
        const imageUrls = [
          `/static/recoms/${baseFilename}/${baseFilename}-COORD1.jpg`,
          `/static/recoms/${baseFilename}/${baseFilename}-COORD2.jpg`,
          `/static/recoms/${baseFilename}/${baseFilename}-COORD1_FIT.jpg`,
          `/static/recoms/${baseFilename}/${baseFilename}-COORD2_FIT.jpg`
        ];
        
        for (const url of imageUrls) {
          try {
            // å‘é€HEADè¯·æ±‚å¼ºåˆ¶æ¸…é™¤ç¼“å­˜
            await fetch(url + '?t=' + Date.now(), { 
              method: 'HEAD',
              cache: 'no-cache'
            });
            console.log('å·²æ¸…é™¤fetchç¼“å­˜:', url);
          } catch (error) {
            console.log('æ¸…é™¤fetchç¼“å­˜å¤±è´¥:', url, error);
          }
        }
        
        console.log('å›¾ç‰‡ç¼“å­˜æ¸…é™¤å®Œæˆ');
        return true;
      } catch (error) {
        console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
        return false;
      }
    }
    
    // åˆ·æ–°æ¨èæ­é…
    async function refreshOutfitRecommendations(filename) {
      try {
        // æ˜¾ç¤ºåŠ è½½é€šçŸ¥
        showNotification('æ­£åœ¨åˆ·æ–°æ­é…æ¨èï¼Œè¯·ç¨å€™...', 'loading');
        
        // è§£æåŸºç¡€æ–‡ä»¶å
        const baseFilename = filename.replace(/\.[^.]+$/, '');
        
        // è°ƒç”¨åç«¯API
        const response = await fetch("{% url 'refresh_outfit_recommendations' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            garment_filename: filename
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // åˆ·æ–°æˆåŠŸåæ¸…é™¤ç¼“å­˜
          console.log('æ­é…åˆ·æ–°æˆåŠŸï¼Œå¼€å§‹æ¸…é™¤ç¼“å­˜...');
          await clearImageCache(baseFilename);
          
          // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ç¼“å­˜æ¸…é™¤å®Œæˆ
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // é‡æ–°æ˜¾ç¤ºå¼¹çª—
          await showRecomModal(filename);
          showNotification('æ­é…æ¨èåˆ·æ–°æˆåŠŸï¼å·²æ¸…ç©ºæ—§æ­é…å¹¶æ¸…é™¤ç¼“å­˜ã€‚', 'success');
        } else if (result.no_outfits) {
          // æ²¡æœ‰æ‰¾åˆ°æ­é…
          showNotification('æš‚æœªæ‰¾åˆ°åˆé€‚çš„æ­é…ï¼Œè¯·ç¨åå†è¯•ï¼', 'error');
          await showRecomModal(filename); // é‡æ–°æ˜¾ç¤ºå¼¹çª—
        } else {
          // å…¶ä»–é”™è¯¯
          showNotification('åˆ·æ–°å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
          await showRecomModal(filename); // é‡æ–°æ˜¾ç¤ºå¼¹çª—
        }
        
      } catch (error) {
        console.error('åˆ·æ–°æ­é…æ¨èå¤±è´¥:', error);
        showNotification('åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        await showRecomModal(filename); // é‡æ–°æ˜¾ç¤ºå¼¹çª—
      }
    }
  </script>
    </div>
</body>
</html>