<!DOCTYPE html>
<html lang="zh-CN">
{% load static %}
<head>
  <meta charset="UTF-8" />
  <!-- é€‚é…ç§»åŠ¨ç«¯ï¼Œè®¾ç½®è§†å£ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#673ab7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>ä¸ªäººä¸­å¿ƒ - æ™ºèƒ½è¡£æ©±</title>
  <link rel="stylesheet" href="{% static 'closet_app/responsive.css' %}">
  <script src="{% static 'closet_app/device-adapter.js' %}"></script>
  <style>
    /* é‡ç½®é»˜è®¤æ ·å¼ï¼Œæ–¹ä¾¿ç»Ÿä¸€æ§åˆ¶ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    /* ä¸ºé¡µé¢ä¸»ä½“æ·»åŠ åº•éƒ¨è¾¹è·ï¼Œé˜²æ­¢è¢«å›ºå®šå¯¼èˆªæ é®æŒ¡ */
    body {
      padding-bottom: 80px;
      background-color: #E4DCF5;
    }

    /* é¡µé¢å®¹å™¨æœ€å¤§å®½åº¦é™åˆ¶ */
    .page-container {
      max-width: 440px; /* æ¯”ä¸€èˆ¬æ‰‹æœºå±å¹•(375px)å®½çº¦17% */
      margin: 0 auto;
      background-color: #E4DCF5;
      min-height: 100vh;
      position: relative;
      overflow: hidden; /* ç¦ç”¨çºµå‘æ»‘åŠ¨ */
      touch-action: none; /* ç¦ç”¨è§¦æ‘¸æ»‘åŠ¨ */
      -webkit-overflow-scrolling: none; /* ç¦ç”¨iOSæ»šåŠ¨ */
    }

    /* æ‰‹æœºç«¯ç¦ç”¨æ»‘åŠ¨ */
    @media (max-width: 440px) {
      body {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
        touch-action: none;
        -webkit-overflow-scrolling: none;
      }
      
      html {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }
    }

    /* åœ¨ç”µè„‘ç«¯æ˜¾ç¤ºè¾¹æ¡†æ•ˆæœ */
    @media (min-width: 441px) {
      .page-container {
        border-left: 1px solid rgba(103, 58, 183, 0.1);
        border-right: 1px solid rgba(103, 58, 183, 0.1);
        box-shadow: 0 0 20px rgba(103, 58, 183, 0.1);
        margin-top: 20px; /* åœ¨ç”µè„‘ç«¯æ·»åŠ é¡¶éƒ¨è¾¹è· */
        margin-bottom: 20px; /* åœ¨ç”µè„‘ç«¯æ·»åŠ åº•éƒ¨è¾¹è· */
        border-radius: 12px; /* åœ†è§’æ•ˆæœ */
      }
    }

    /* é‡ç½® i æ ‡ç­¾çš„æ–œä½“æ ·å¼ï¼Œç¡®ä¿å›¾æ ‡æ­£å¸¸æ˜¾ç¤º */
    i {
      font-style: normal;
    }

    /* é¡¶éƒ¨èƒŒæ™¯å›¾åŒºåŸŸ */
    .header {
      width: 100%;
      height: 200px;
      background: url('https://th.bing.com/th/id/R.c9b78a30cca10670011a4d7fa214fff1?rik=X5cMbIXIGY39bA&riu=http%3a%2f%2fpic.616pic.com%2fbg_w1180%2f00%2f02%2f13%2fO0n24hjcGH.jpg!%2ffw%2f1120&ehk=YKswPr5no8ymZf3Iywiba8pGEAUm9ylb%2fkO3F3T7ipo%3d&risl=&pid=ImgRaw&r=0') center/cover no-repeat;
      position: relative;
      padding-top: 20px;
    }
    /* ç”¨æˆ·å¤´åƒ + æ˜µç§°å¸ƒå±€ */
    .user-info {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0 20px;
    }
    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: url('https://tse3.mm.bing.net/th/id/OIP.xHi99XtEH9P3sTcBsPoVegAAAA?rs=1&pid=ImgDetMain&o=7&rm=3') center/cover no-repeat;
      margin-right: 12px;
    }
    .nickname {
      font-size: 17px;
      color: #333;
      font-weight: 500;
    }
    /* ç»Ÿè®¡æ•°æ®ï¼ˆè¡£æœã€æ­é…ç­‰ï¼‰ */
    .stats {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      color: #7948EA;
    }
    .stats-item {
      text-align: center;
    }
    .stats-number {
      font-size: 16px;
      color: #7948EA;
      display: block;
      margin-bottom: 4px;
    }

    /* åŠŸèƒ½æ¨¡å—å®¹å™¨ï¼Œé€šç”¨å¡ç‰‡æ ·å¼ */
    .card {
      background: #fff;
      margin: 12px 16px;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .card-title {
      font-size: 16px;
      color: #333;
      font-weight: 500;
      margin-bottom: 12px;
    }
    /* è¡£æœè®¾ç½®ï¼šå›¾æ ‡+æ–‡å­—å¸ƒå±€ */
    .clothes-setting {
      display: flex;
      justify-content: space-around;
    }
    .setting-item {
      text-align: center;
      width: 25%;
    }
    .setting-item i {
      display: block;
      width: 40px;
      height: 40px;
      background: #F7F6E9;
      border-radius: 8px;
      margin: 0 auto 6px;
      /* å¯æ›¿æ¢ä¸ºå®é™…å›¾æ ‡å­—ä½“æˆ–å›¾ç‰‡èƒŒæ™¯ */
      line-height: 40px;
      color: #999;
      font-size: 20px;
    }
    .setting-item span {
      font-size: 13px;
      color: #666;
    }

    /* æ—¥ç¨‹åŠ©æ‰‹æ¨¡å— */
    .schedule-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .schedule-text {
      font-size: 14px;
      color: #666;
      line-height: 1.4;
    }
    .schedule-btn {
      color: #8bc34a;
      font-size: 15px;
      text-decoration: none;
      font-weight: 500;
    }

    /* å…¶ä»–åŠŸèƒ½æ¨¡å— */
    .other-functions {
      display: flex;
      justify-content: space-around;
    }
    .function-item {
      text-align: center;
      width: 25%;
    }
    .function-item i {
      display: block;
      width: 36px;
      height: 36px;
      background: #eee;
      border-radius: 8px;
      margin: 0 auto 4px;
      line-height: 36px;
      color: #999;
      font-size: 18px;
    }
    .function-item span {
      font-size: 13px;
      color: #666;
      display: block;
    }

    /* åº•éƒ¨å¯¼èˆªæ  */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 440px; /* ä¸é¡µé¢å®¹å™¨ä¿æŒä¸€è‡´ */
      height: 60px;
      background: #fff;
      border-top: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1000;
    }

    /* åœ¨ç”µè„‘ç«¯ä¸ºåº•éƒ¨å¯¼èˆªæ æ·»åŠ è¾¹æ¡†æ•ˆæœ */
    @media (min-width: 441px) {
      .bottom-nav {
        border-left: 1px solid rgba(103, 58, 183, 0.1);
        border-right: 1px solid rgba(103, 58, 183, 0.1);
        border-bottom: 1px solid rgba(103, 58, 183, 0.1);
        border-radius: 0 0 12px 12px; /* åº•éƒ¨åœ†è§’ */
        box-shadow: 0 0 20px rgba(103, 58, 183, 0.1);
      }
    }
    .nav-item {
      text-align: center;
      flex: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s ease;
      padding: 8px 0;
      min-height: 60px;
    }
    .nav-item:hover {
      background-color: #f5f5f5;
    }
    .nav-item:active {
      background-color: #e0e0e0;
    }
    .nav-item i {
      font-size: 22px;
      color: #999;
      display: block;
      margin-bottom: 2px;
      pointer-events: none;
    }
    .nav-item span {
      font-size: 12px;
      color: #999;
      pointer-events: none;
    }
    /* çªå‡ºå½“å‰æ¿€æ´»é¡¹ï¼ˆç¤ºä¾‹ç»™ Profile åŠ è“è‰²ï¼‰ */
    .nav-item.active span {
      color: #673ab7;
    }

    /* ä¸­é—´æ‚¬æµ®æŒ‰é’® */
    .floating-btn {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      width: 56px;
      height: 56px;
      background: #673ab7;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    /* æ–°å¢æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 16px;
      width: 90%;
      max-width: 350px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .close {
      color: #999;
      float: right;
      font-size: 28px;
      font-weight: bold;
      transition: color 0.3s;
    }

    .close:hover,
    .close:focus {
      color: #333;
      text-decoration: none;
      cursor: pointer;
    }

    .user-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .user-form input,
    .user-form select,
    .user-form button {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .user-form input:focus,
    .user-form select:focus {
      outline: none;
      border-color: #673ab7;
    }

    .user-form button {
      background-color: #673ab7;
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .user-form button:hover {
      background-color: #512e91;
    }

    /* æ–°å¢ï¼šç…§ç‰‡ä¸Šä¼ åŒºåŸŸæ ·å¼ */
    .photo-upload-section {
      border: 2px dashed #ddd;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      background-color: #f9f9f9;
      margin: 12px 0;
      transition: border-color 0.3s;
    }

    .photo-upload-section:hover {
      border-color: #673ab7;
      background-color: #f0f0f0;
    }

    .photo-upload-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
      font-weight: 500;
    }

    .photo-upload-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .photo-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .upload-btn {
      background: linear-gradient(135deg, #673ab7, #9c27b0);
      color: white;
    }

    .upload-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(103, 58, 183, 0.3);
    }

    .camera-btn {
      background: linear-gradient(135deg, #2196f3, #1976d2);
      color: white;
    }

    .camera-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
    }

    .camera-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .close-camera-btn {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
    }

    .close-camera-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
    }

    .capture-btn {
      background: linear-gradient(135deg, #4caf50, #388e3c);
      color: white;
    }

    .capture-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
    }

    .capture-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* è§†é¢‘é¢„è§ˆåŒºåŸŸ */
    .video-container {
      margin: 12px 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .video-container video {
      width: 100%;
      height: auto;
      display: block;
    }

    /* éšè—æ–‡ä»¶è¾“å…¥æ¡† */
    .hidden-input {
      display: none;
    }

    /* æ·»åŠ ç”¨æˆ·æŒ‰é’®æ ·å¼ */
    .add-user-btn {
      background: linear-gradient(135deg, #673ab7, #9c27b0);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(103, 58, 183, 0.3);
      transition: all 0.3s ease;
      margin-bottom: 16px;
    }

    .add-user-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(103, 58, 183, 0.4);
    }

    .add-user-btn:active {
      transform: translateY(0);
    }

    .user-list {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 10px;
      background-color: #f9f9f9;
    }

    .user-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .user-info-text {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .user-info-text p {
      font-size: 13px;
      color: #333;
    }

    .user-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 80px; /* ç¡®ä¿æŒ‰é’®å®¹å™¨æœ‰å›ºå®šå®½åº¦ */
    }

    .user-actions button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: opacity 0.3s;
      width: 100%; /* è®©æ‰€æœ‰æŒ‰é’®å æ»¡å®¹å™¨å®½åº¦ */
      min-height: 28px; /* ç¡®ä¿æŒ‰é’®é«˜åº¦ä¸€è‡´ */
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
    }

    .user-actions button:hover {
      opacity: 0.9;
    }

    .user-actions .edit-btn {
      background-color: #2196f3;
      color: white;
    }

    .user-actions .delete-btn {
      background-color: #f44336;
      color: white;
    }

    .user-actions .default-btn {
      background-color: #673ab7;
      color: white;
    }

    .user-actions .default-btn.disabled {
      background-color: #ccc;
      color: #666;
      cursor: not-allowed;
    }

    /* é»˜è®¤ç”¨æˆ·èƒŒæ™¯æ ·å¼ */
    .user-item.default-user {
      background-color: rgba(103, 58, 183, 0.1);
      border-color: #673ab7;
    }

    /* é€šçŸ¥æç¤ºæ ·å¼ */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      max-width: 300px;
      text-align: center;
    }

    .notification.success {
      background-color: #4caf50;
      color: white;
    }

    .notification.error {
      background-color: #f44336;
      color: white;
    }

    .notification.info {
      background-color: #2196f3;
      color: white;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .notification.hide {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }
  </style>
</head>
<body>
    <div class="page-container">
      <!-- é¡¶éƒ¨èƒŒæ™¯+ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
      <div class="header">
      <div class="user-info">
        <div class="avatar"></div>
        <div class="nickname">ç”¨æˆ·â€”â€”21hegkj367</div>
      </div>
      <div class="stats">
        <div class="stats-item">
          <span class="stats-number">27</span>
          <span>è¡£æœ</span>
        </div>
        <div class="stats-item">
          <span class="stats-number">6</span>
          <span>æ”¶è—ç©¿æ­</span>
        </div>
        <div class="stats-item">
          <span class="stats-number">æš‚æ— </span>
          <span>æ—¥ç¨‹</span>
        </div>
      </div>
    </div>

    <!-- è¡£æœè®¾ç½®å¡ç‰‡ -->
    <div class="card">
      <div class="card-title">è¡£æœè®¾ç½®</div>
      <div class="clothes-setting">
        <div class="setting-item">
          <i>ğŸ“–</i>
          <span>è¡£æ©±è®¾ç½®</span>
        </div>
        <div class="setting-item">
          <i>ğŸ”²</i>
          <span>è¡£ç‰©åˆ†ç±»</span>
        </div>
        <div class="setting-item">
          <i>ğŸ</i>
          <span>è¡£ç‰©åœºåˆ</span>
        </div>
        <div class="setting-item">
          <i>ğŸ‘š</i>
          <span>è¡£ç‰©å±æ€§</span>
        </div>
      </div>
    </div>

    <!-- æ—¥ç¨‹åŠ©æ‰‹å¡ç‰‡ -->
    <div class="card">
      <div class="schedule-box">
        <div class="schedule-text">
          <div>æ—¥ç¨‹åŠ©æ‰‹</div>
          <div>è®°å½•ç¾å¥½ç”Ÿæ´»ï¼Œç©¿æ­æ—¥ç¨‹åŠ©æ‰‹</div>
        </div>
        <a href="#" class="schedule-btn">è¿›å…¥æ—¥ç¨‹</a>
      </div>
    </div>

    <!-- å…¶ä»–åŠŸèƒ½å¡ç‰‡ -->
    <div class="card">
      <div class="card-title">å…¶ä»–åŠŸèƒ½</div>
      <div class="other-functions">
        <div class="function-item" onclick="openUserModal()">
          <i>ğŸ‘¤</i>
          <span>ä¸ªäººä¿¡æ¯</span>
        </div>
        <div class="function-item">
          <i>ğŸ’¡</i>
          <span>åŠŸèƒ½å»ºè®®</span>
        </div>
        <div class="function-item">
          <i>ğŸ“</i>
          <span>è”ç³»æˆ‘ä»¬</span>
        </div>
        <div class="function-item">
          <i>ğŸšª</i>
          <span>é€€å‡ºç™»å½•</span>
        </div>
      </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="userModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeUserModal()">&times;</span>
        <button onclick="showUserForm()" class="add-user-btn">
          <span>â•</span>
          <span>æ·»åŠ ç”¨æˆ·</span>
        </button>
        <div id="userForm" class="user-form" style="display: none;">
          <input type="text" id="name" placeholder="å§“å">
          <select id="gender">
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
          </select>
          <input type="number" id="age" placeholder="å¹´é¾„">
          <input type="number" id="height" placeholder="èº«é«˜(cm)">
          <input type="number" id="weight" placeholder="ä½“é‡(kg)">
          
          <!-- ç…§ç‰‡ä¸Šä¼ åŒºåŸŸ -->
          <div class="photo-upload-section">
            <div class="photo-upload-title">è¯·ä¸Šä¼ ä¸ªäººçœŸå®å…¨èº«ç…§</div>
            <div class="photo-upload-buttons">
              <button type="button" class="photo-btn upload-btn" onclick="document.getElementById('photo').click()">
                <span>ğŸ“</span>
                <span>é€‰æ‹©æ–‡ä»¶</span>
              </button>
              <button type="button" class="photo-btn camera-btn" onclick="openCamera()">
                <span>ğŸ“·</span>
                <span>æ‹æ‘„ç…§ç‰‡</span>
              </button>
            </div>
            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
            <input type="file" id="photo" accept="image/*" class="hidden-input">
          </div>
          
          <!-- è§†é¢‘é¢„è§ˆåŒºåŸŸ -->
          <div id="videoContainer" class="video-container" style="display: none;">
            <video id="video" autoplay muted></video>
            <div class="photo-upload-buttons" style="margin-top: 8px;">
              <button type="button" id="captureBtn" class="photo-btn capture-btn" onclick="capturePhoto()">
                <span>ğŸ“¸</span>
                <span>æ‹ç…§</span>
              </button>
              <button type="button" id="closeCameraBtn" class="photo-btn close-camera-btn" onclick="closeCamera()">
                <span>âŒ</span>
                <span>å…³é—­</span>
              </button>
            </div>
          </div>
          
          <select id="style">
            <option value="ä¼‘é—²">ä¼‘é—²</option>
            <option value="å•†åŠ¡">å•†åŠ¡</option>
            <option value="è¿åŠ¨">è¿åŠ¨</option>
          </select>
          <button onclick="saveUser()" class="user-form button">ä¿å­˜</button>
        </div>
        <div class="user-list" id="userList"></div>
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="floating-btn">
      <a href="{% url 'mirror' %}" style="text-decoration: none;">
        <i>ğŸª</i>
      </a>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    {% load static %}
    <div class="bottom-nav">
      <div class="nav-item active">
        <a href="{% url 'index' %}" style="text-decoration: none;">
          <i>ğŸ </i>
          <span>Home</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="{% url 'closet' %}" style="text-decoration: none;">
          <i>ğŸ‘•</i>
          <span>closet</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="{% url 'match' %}" style="text-decoration: none;">
          <i>â­ï¸</i>
          <span>favourite</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="{% url 'profile' %}" style="text-decoration: none;">
          <i>ğŸ‘¤</i>
          <span>profile</span>
        </a>
      </div>
    </div>
  <script>
    let currentUserId = null;
    let stream = null;

    // æ˜¾ç¤ºé€šçŸ¥æç¤º
    function showNotification(message, type = 'info') {
      // ç§»é™¤ä¹‹å‰çš„é€šçŸ¥
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // åˆ›å»ºæ–°é€šçŸ¥
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      // æ ¹æ®ç±»å‹æ·»åŠ å›¾æ ‡
      let icon = '';
      if (type === 'success') {
        icon = 'âœ… ';
      } else if (type === 'error') {
        icon = 'âŒ ';
      } else if (type === 'info') {
        icon = 'â„¹ï¸ ';
      }
      
      notification.innerHTML = `${icon}${message}`;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(notification);
      
      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);
      
      // è‡ªåŠ¨éšè—
      setTimeout(() => {
        notification.classList.add('hide');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }, 3000);
      
      return notification;
    }

    function openUserModal() {
      document.getElementById('userModal').style.display = "block";
      loadUsers();
    }

    function closeUserModal() {
      document.getElementById('userModal').style.display = "none";
      document.getElementById('userForm').style.display = "none";
      currentUserId = null;
      closeCamera(); // å…³é—­æ‘„åƒå¤´
    }

    function showUserForm() {
      currentUserId = null;
      document.getElementById('name').value = '';
      document.getElementById('gender').value = 'ç”·';
      document.getElementById('age').value = '';
      document.getElementById('height').value = '';
      document.getElementById('weight').value = '';
      document.getElementById('photo').value = '';
      document.getElementById('style').value = 'ä¼‘é—²';
      document.getElementById('userForm').style.display = "block";
    }

    function saveUser() {
      const name = document.getElementById('name').value;
      const gender = document.getElementById('gender').value;
      const age = document.getElementById('age').value;
      const height = document.getElementById('height').value;
      const weight = document.getElementById('weight').value;
      const photo = document.getElementById('photo').files[0];
      const style = document.getElementById('style').value;

      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!name || !gender || !age || !height || !weight) {
        showNotification('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«ä¿¡æ¯', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('name', name);
      formData.append('gender', gender);
      formData.append('age', age);
      formData.append('height', height);
      formData.append('weight', weight);
      formData.append('photo', photo);
      formData.append('style', style);

      if (currentUserId) {
        formData.append('id', currentUserId);
      }

      fetch("{% url 'save_user' %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotification('ç”¨æˆ·ä¿¡æ¯ä¿å­˜æˆåŠŸï¼', 'success');
          loadUsers();
          document.getElementById('userForm').style.display = "none";
        } else {
          showNotification('ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      })
      .catch(error => {
        console.error('ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      });
    }

    function loadUsers() {
      fetch("{% url 'load_users' %}")
      .then(response => response.json())
      .then(data => {
        const userList = document.getElementById('userList');
        userList.innerHTML = '';
        
        data.users.forEach(user => {
          const userItem = document.createElement('div');
          userItem.className = 'user-item';
          
          // å¦‚æœæ˜¯é»˜è®¤ç”¨æˆ·ï¼Œæ·»åŠ é»˜è®¤ç”¨æˆ·æ ·å¼
          if (user.is_default) {
            userItem.classList.add('default-user');
          }
          
          const isDefault = user.is_default;
          const defaultBtnText = isDefault ? 'å·²è®¾ä¸ºé»˜è®¤' : 'è®¾ä¸ºé»˜è®¤';
          const defaultBtnClass = isDefault ? 'default-btn disabled' : 'default-btn';
          
          userItem.innerHTML = `
            <img class="user-photo" src="${user.photo_url}" alt="ç”¨æˆ·ç…§ç‰‡">
            <div class="user-info-text">
              <p>å§“å: ${user.name}</p>
              <p>æ€§åˆ«: ${user.gender}</p>
              <p>å¹´é¾„: ${user.age}</p>
              <p>èº«é«˜: ${user.height}cm</p>
              <p>ä½“é‡: ${user.weight}kg</p>
              <p>é£æ ¼: ${user.style}</p>
            </div>
            <div class="user-actions">
              <button class="edit-btn" onclick="editUser('${user.id}')">ç¼–è¾‘</button>
              <button class="delete-btn" onclick="deleteUser('${user.id}')">åˆ é™¤</button>
              <button class="${defaultBtnClass}" onclick="setDefaultUser('${user.id}')" ${isDefault ? 'disabled' : ''}>${defaultBtnText}</button>
            </div>
          `;
          userList.appendChild(userItem);
        });
      });
    }

    function editUser(id) {
      currentUserId = id;
      fetch(`{% url 'get_user' %}?id=${id}`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('name').value = data.name;
        document.getElementById('gender').value = data.gender;
        document.getElementById('age').value = data.age;
        document.getElementById('height').value = data.height;
        document.getElementById('weight').value = data.weight;
        document.getElementById('style').value = data.style;
        document.getElementById('userForm').style.display = "block";
      });
    }

    function deleteUser(id) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿ')) {
        fetch(`{% url 'delete_user' %}?id=${id}`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadUsers();
          }
        });
      }
    }

    function setDefaultUser(id) {
        fetch("{% url 'set_default_user' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({
            user_id: id
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showNotification('å·²å°†ç”¨æˆ·è®¾ä¸ºé»˜è®¤ç”¨æˆ·ï¼', 'success');
            loadUsers();
          } else {
            showNotification('è®¾ç½®é»˜è®¤ç”¨æˆ·å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        })
        .catch(error => {
          console.error('è®¾ç½®é»˜è®¤ç”¨æˆ·å¤±è´¥:', error);
          showNotification('è®¾ç½®é»˜è®¤ç”¨æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        });
      
    }

    // æ‰“å¼€æ‘„åƒå¤´
    function openCamera() {
      const video = document.getElementById('video');
      const videoContainer = document.getElementById('videoContainer');
      const captureBtn = document.getElementById('captureBtn');
      const closeCameraBtn = document.getElementById('closeCameraBtn');
      const photoInput = document.getElementById('photo');

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(function(newStream) {
            stream = newStream;
            video.srcObject = stream;
            video.addEventListener('canplay', function() {
              video.play();
              videoContainer.style.display = 'block';
              captureBtn.disabled = false;
              closeCameraBtn.disabled = false;
            }, { once: true });
          })
          .catch(function(error) {
            console.error('è®¿é—®æ‘„åƒå¤´å¤±è´¥:', error);
            showNotification('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®ã€‚', 'error');
          });
      } else {
        showNotification('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½ã€‚', 'error');
      }
    }

    // æ‹ç…§
    function capturePhoto() {
      const video = document.getElementById('video');
      const photoInput = document.getElementById('photo');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || video.clientWidth;
      canvas.height = video.videoHeight || video.clientHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(function(blob) {
        const file = new File([blob], 'photo.jpg', { type: 'image/jpeg' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        photoInput.files = dataTransfer.files;
        closeCamera();
      }, 'image/jpeg');
    }

    // å…³é—­æ‘„åƒå¤´
    function closeCamera() {
      const video = document.getElementById('video');
      const videoContainer = document.getElementById('videoContainer');
      const captureBtn = document.getElementById('captureBtn');
      const closeCameraBtn = document.getElementById('closeCameraBtn');

      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }

      videoContainer.style.display = 'none';
      captureBtn.disabled = true;
      closeCameraBtn.disabled = true;
    }
  </script>
    </div>
</body>
</html>
