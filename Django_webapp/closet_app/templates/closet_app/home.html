<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#673ab7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>æ™ºèƒ½è¡£æ©± - å¤©æ°”ç©¿æ­åŠ©æ‰‹</title>
  <!-- åŠ è½½é™æ€æ–‡ä»¶æ ‡ç­¾ -->
  {% load static %}
  <link rel="stylesheet" href="{% static 'closet_app/responsive.css' %}">
  <script src="{% static 'closet_app/device-adapter.js' %}"></script>
  <style>
    /* é‡ç½®é»˜è®¤æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
    }

    /* ä¸ºé¡µé¢ä¸»ä½“æ·»åŠ åº•éƒ¨è¾¹è·ï¼Œé˜²æ­¢è¢«å›ºå®šå¯¼èˆªæ é®æŒ¡ */
    body {
      padding-bottom: 80px;
      background-color: #E4DCF5;
    }

    /* é¡µé¢å®¹å™¨æœ€å¤§å®½åº¦é™åˆ¶ */
    .page-container {
      max-width: 440px; /* æ¯”ä¸€èˆ¬æ‰‹æœºå±å¹•(375px)å®½çº¦17% */
      margin: 0 auto;
      background-color: #E4DCF5;
      min-height: 100vh;
      position: relative;
      overflow: hidden; /* ç¦ç”¨çºµå‘æ»‘åŠ¨ */
      touch-action: none; /* ç¦ç”¨è§¦æ‘¸æ»‘åŠ¨ */
      -webkit-overflow-scrolling: none; /* ç¦ç”¨iOSæ»šåŠ¨ */
    }

    /* æ‰‹æœºç«¯ç¦ç”¨æ»‘åŠ¨ */
    @media (max-width: 440px) {
      body {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
        touch-action: none;
        -webkit-overflow-scrolling: none;
      }
      
      html {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }
    }

    /* åœ¨ç”µè„‘ç«¯æ˜¾ç¤ºè¾¹æ¡†æ•ˆæœ */
    @media (min-width: 441px) {
      .page-container {
        border-left: 1px solid rgba(103, 58, 183, 0.1);
        border-right: 1px solid rgba(103, 58, 183, 0.1);
        box-shadow: 0 0 20px rgba(103, 58, 183, 0.1);
        margin-top: 20px; /* åœ¨ç”µè„‘ç«¯æ·»åŠ é¡¶éƒ¨è¾¹è· */
        margin-bottom: 20px; /* åœ¨ç”µè„‘ç«¯æ·»åŠ åº•éƒ¨è¾¹è· */
        border-radius: 12px; /* åœ†è§’æ•ˆæœ */
      }
    }

    /* é‡ç½® i æ ‡ç­¾çš„æ–œä½“æ ·å¼ï¼Œç¡®ä¿å›¾æ ‡æ­£å¸¸æ˜¾ç¤º */
    i {
      font-style: normal;
    }



    /* å¤©æ°”æ¨¡å— */
    .weather-section {
      background: linear-gradient(180deg, #c9e8ff 0%, #e4f2ff 100%);
      padding: 16px;
    }

    .city-title {
      font-size: 24px;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(103, 58, 183, 0.2);
      border-radius: 20px;
      padding: 12px 20px;
      outline: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(103, 58, 183, 0.1);
      backdrop-filter: blur(10px);
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
    }

    .city-title:hover {
      border-color: rgba(103, 58, 183, 0.4);
      box-shadow: 0 6px 16px rgba(103, 58, 183, 0.2);
      transform: translateY(-1px);
    }

    .city-title:focus {
      border-color: #673ab7;
      box-shadow: 0 0 0 3px rgba(103, 58, 183, 0.1);
    }

    .city-title option {
      background: white;
      color: #333;
      padding: 8px;
      font-size: 16px;
    }

    .weather-cards {
      display: flex;
      overflow-x: auto;
      /* æ¨ªå‘æ»šåŠ¨ */
      padding-bottom: 8px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
      /* ç¡®ä¿è§¦æ‘¸æ»šåŠ¨æ­£å¸¸å·¥ä½œ */
      touch-action: pan-x;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      /* å¢å¼ºæ»‘åŠ¨å“åº”æ€§ */
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      /* ç¡®ä¿å®¹å™¨æœ‰è¶³å¤Ÿçš„é«˜åº¦æ¥å“åº”è§¦æ‘¸ */
      min-height: 120px;
      /* æ·»åŠ å†…è¾¹è·ç¡®ä¿è§¦æ‘¸åŒºåŸŸè¶³å¤Ÿå¤§ */
      padding: 8px 0;
    }
    
    .weather-cards::-webkit-scrollbar {
      display: none; /* Chrome, Safari and Opera */
    }
    
    /* æ»‘åŠ¨æç¤ºåŠ¨ç”» */
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-50%) translateX(20px); }
      20% { opacity: 1; transform: translateY(-50%) translateX(0); }
      80% { opacity: 1; transform: translateY(-50%) translateX(0); }
      100% { opacity: 0; transform: translateY(-50%) translateX(-20px); }
    }

    .weather-card {
      flex: 0 0 auto;
      width: 100px;
      background: #fff;
      border-radius: 8px;
      margin-right: 8px;
      padding: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      /* å¢å¼ºè§¦æ‘¸å“åº” */
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      /* ç¡®ä¿å¡ç‰‡æœ‰è¶³å¤Ÿçš„è§¦æ‘¸åŒºåŸŸ */
      min-height: 100px;
      /* é˜²æ­¢è§¦æ‘¸æ—¶å‡ºç°é€‰ä¸­æ•ˆæœ */
      pointer-events: auto;
    }

    .weather-date {
      font-size: 14px;
      color: #999;
      margin-bottom: 4px;
    }

    .weather-icon {
      width: 36px;
      height: 36px;
      margin: 4px auto;
    }

    .weather-temp {
      font-size: 14px;
      color: #666;
    }

    /* ç©¿æ­å»ºè®®æ¨¡å— */
    .suggest-section {
      background: #f2f2f2;
      margin: 12px 16px;
      border-radius: 12px;
      padding: 16px;
    }

    .suggest-title {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .suggest-title .hot-tag {
      font-size: 28px;
      font-weight: bold;
      margin-right: 8px;
    }

    /* å®šä¹‰ä¸åŒå¤©æ°”çŠ¶æ€ä¸‹çš„é¢œè‰²æ ·å¼ */
    .suggest-title .hot-tag.hot {
      color: #e63946;
    }

    .suggest-title .hot-tag.rain {
      color: #2196F3;
    }

    .suggest-title .hot-tag.cloudy {
      color: #999;
    }

    .suggest-title .text {
      font-size: 16px;
      color: #333;
    }

    .schedule-btn {
      display: inline-block;
      background: #e9c46a;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      margin-top: 8px;
    }

    /* ä»Šæ—¥æ­é…æ¨¡å— */
    .match-section {
      margin: 0 16px 12px;
    }

    .match-header {
      font-size: 16px;
      color: #333;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .match-desc {
      font-size: 14px;
      color: #f4a261;
      margin-bottom: 12px;
    }

    .match-cards {
      display: flex;
      gap: 12px;
    }

    .match-card {
      flex: 1;
      height: 120px;
      background: #ccc;
      border-radius: 8px;
    }

    /* åº•éƒ¨å¯¼èˆªæ ï¼ˆå¤ç”¨é€šç”¨æ ·å¼ï¼‰ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 440px; /* ä¸é¡µé¢å®¹å™¨ä¿æŒä¸€è‡´ */
      height: 60px;
      background: #fff;
      border-top: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1000;
    }

    /* åœ¨ç”µè„‘ç«¯ä¸ºåº•éƒ¨å¯¼èˆªæ æ·»åŠ è¾¹æ¡†æ•ˆæœ */
    @media (min-width: 441px) {
      .bottom-nav {
        border-left: 1px solid rgba(103, 58, 183, 0.1);
        border-right: 1px solid rgba(103, 58, 183, 0.1);
        border-bottom: 1px solid rgba(103, 58, 183, 0.1);
        border-radius: 0 0 12px 12px; /* åº•éƒ¨åœ†è§’ */
        box-shadow: 0 0 20px rgba(103, 58, 183, 0.1);
      }
    }

    .nav-item {
      text-align: center;
      flex: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s ease;
      padding: 8px 0;
      min-height: 60px;
    }
    .nav-item:hover {
      background-color: #f5f5f5;
    }
    .nav-item:active {
      background-color: #e0e0e0;
    }
    .nav-item i {
      font-size: 22px;
      color: #999;
      display: block;
      margin-bottom: 2px;
      pointer-events: none;
    }
    .nav-item span {
      font-size: 12px;
      color: #999;
      pointer-events: none;
    }
    .nav-item.active span {
      color: #673ab7;
    }

    /* ä¸­é—´æ‚¬æµ®æŒ‰é’® */
    .floating-btn {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      width: 56px;
      height: 56px;
      background: #673ab7;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    /* å¼¹çª—æ ·å¼ */
    .outfit-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .outfit-modal.show {
      opacity: 1;
    }

    .outfit-modal-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 24px 16px;
      max-width: 420px;
      width: 90vw;
      display: flex;
      flex-direction: column;
      gap: 18px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      position: relative;
      transform: scale(0.8) translateY(-20px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .outfit-modal.show .outfit-modal-content {
      transform: scale(1) translateY(0);
    }

    .outfit-modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      z-index: 9999;
    }

    .outfit-modal-close:hover {
      background: rgba(255, 255, 255, 1);
      color: #666;
      transform: scale(1.1);
    }

    .outfit-image-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .outfit-image {
      width: 100%;
      max-width: 150px;
      max-height: 260px;
      border-radius: 12px;
      object-fit: contain;
      background: rgba(245, 245, 245, 0.8);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .outfit-image:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .outfit-image.switching {
      animation: imageSwitch 0.6s ease-in-out;
    }

    @keyframes imageSwitch {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.3; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }

    .mode-indicator {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      transition: all 0.3s ease;
      z-index: 9997;
    }

    .switch-mode-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(103, 58, 183, 0.8);
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 9998;
    }

    .switch-mode-btn:hover {
      background: rgba(103, 58, 183, 1);
      transform: scale(1.1);
    }
  </style>
</head>

<body>
    <div class="page-container">
      <!-- åˆå¹¶åŸå¸‚é€‰æ‹©å’Œå¤©æ°”æ¨¡å— -->
      <div class="weather-section">
      <select id="citySelect" class="city-title" onchange="getWeather()">
        <option value="å—äº¬å¸‚">å—äº¬å¸‚</option>
        <option value="åŒ—äº¬å¸‚">åŒ—äº¬å¸‚</option>
        <option value="ä¹Œé²æœ¨é½å¸‚">ä¹Œé²æœ¨é½å¸‚</option>
        <option value="å¦é—¨å¸‚">å¦é—¨å¸‚</option>
        <option value="ä¸‰äºšå¸‚">ä¸‰äºšå¸‚</option>
        <option value="é€šè¾½å¸‚">é€šè¾½å¸‚</option>
        <option value="ä¸Šæµ·å¸‚">ä¸Šæµ·å¸‚</option>
        <option value="å¹¿å·å¸‚">å¹¿å·å¸‚</option>
        <option value="æ·±åœ³å¸‚">æ·±åœ³å¸‚</option>
        <option value="æˆéƒ½å¸‚">æˆéƒ½å¸‚</option>
        <option value="æ­å·å¸‚">æ­å·å¸‚</option>
        <option value="æ­¦æ±‰å¸‚">æ­¦æ±‰å¸‚</option>
        <option value="è¥¿å®‰å¸‚">è¥¿å®‰å¸‚</option>
        <option value="é‡åº†å¸‚">é‡åº†å¸‚</option>
        <option value="å¤©æ´¥å¸‚">å¤©æ´¥å¸‚</option>
        <option value="æ²ˆé˜³å¸‚">æ²ˆé˜³å¸‚</option>
        <option value="å¤§è¿å¸‚">å¤§è¿å¸‚</option>
        <option value="é•¿æ²™å¸‚">é•¿æ²™å¸‚</option>
        <option value="éƒ‘å·å¸‚">éƒ‘å·å¸‚</option>
        <option value="ç¦å·å¸‚">ç¦å·å¸‚</option>
        <option value="æ˜†æ˜å¸‚">æ˜†æ˜å¸‚</option>
        <!-- å¯æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šåŸå¸‚ -->
      </select>
      <div class="weather-cards" id="weatherCards"></div>
    </div>

    <!-- ç©¿æ­å»ºè®®æ¨¡å— -->
    <div class="suggest-section">
      <div class="suggest-title">
        <div class="hot-tag" id="hotTag">è¯·ç¨ç­‰</div>
        <div class="text" id="suggestText">æ­£åœ¨è·å–å¤©æ°”ä¿¡æ¯...</div>
      </div>
      <a href="#" class="schedule-btn">æš‚æ— æ—¥ç¨‹</a>
    </div>

    <!-- ä»Šæ—¥æ­é…æ¨¡å— -->
    <div class="match-section">
      <div class="match-header">ä»Šæ—¥æ­é…</div>
      <div class="match-desc" id="matchDesc">ä»Šæ—¥é€‚åˆæ¸…æ–°å¤æ—¥é£</div>
      <div class="match-cards" id="matchCards"></div>
    </div>

    <!-- ä¸­é—´æ‚¬æµ®æŒ‰é’® -->
    <div class="floating-btn">
      <a href="{% url 'mirror' %}" style="text-decoration: none;">
        <i>ğŸª</i>
      </a>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
     {% load static %}
    <div class="bottom-nav">
      <div class="nav-item active">
        <i>ğŸ </i>
        <span>Home</span>
      </div>
      <div class="nav-item">
        <a href="{% url 'closet' %}" style="text-decoration: none;">
          <i>ğŸ‘•</i>
          <span>closet</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="{% url 'match' %}" style="text-decoration: none;">
          <i>â­ï¸</i>
          <span>favourite</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="{% url 'profile' %}" style="text-decoration: none;">
          <i>ğŸ‘¤</i>
          <span>profile</span>
        </a>
      </div>
    </div>

    <!-- æ­é…å¼¹çª— -->
    <div id="outfitModal" class="outfit-modal">
      <div class="outfit-modal-content">
        <button class="outfit-modal-close" onclick="closeOutfitModal()">Ã—</button>
        <div style="display:flex;flex-direction:row;gap:18px;">
          <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <div class="outfit-image-container">
              <img id="outfitImage1" class="outfit-image coord-mode" style="width:100%;max-width:150px;max-height:260px;border-radius:12px;object-fit:contain;background:rgba(245,245,245,0.8);margin-bottom:8px;cursor:pointer;" onclick="handleOutfitImageClick()" data-filename="" data-base="">
              <div class="mode-indicator">æ­é…</div>
              <button class="switch-mode-btn" onclick="toggleImageMode(document.getElementById('outfitImage1'))" title="åˆ‡æ¢æ¨¡å¼">ğŸ”„</button>
            </div>
            <div style="text-align:center;font-size:13px;color:#673ab7;font-weight:bold;">æ¨èæ­é…</div>
          </div>
        </div>
      </div>
    </div>
  <script>
    // æ˜¾ç¤ºé€šçŸ¥å‡½æ•°
    function showNotification(message, type = 'info') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            max-width: 300px;
            word-wrap: break-word;
        `;
        
        // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
        if (type === 'error') {
            notification.style.backgroundColor = '#f44336';
        } else if (type === 'success') {
            notification.style.backgroundColor = '#4CAF50';
        } else {
            notification.style.backgroundColor = '#2196F3';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }
    
    // é¡µé¢åŠ è½½å®Œæˆæ—¶è°ƒç”¨è·å–å¤©æ°”å‡½æ•°
    window.addEventListener('load', function() {
        getWeather();
        initWeatherCardsTouchScroll();
    });

    // å¼¹çª—ç›¸å…³å‡½æ•°
    function showOutfitModal(baseFilename, coordFilename, imageUrl) {
      const modal = document.getElementById('outfitModal');
      const img = document.getElementById('outfitImage1');
      
      // è®¾ç½®å›¾ç‰‡æºå’Œå±æ€§
      img.src = imageUrl;
      img.setAttribute('data-filename', coordFilename);
      img.setAttribute('data-base', baseFilename);
      img.setAttribute('data-showing-fit', 'false');
      
      // é‡ç½®æ ·å¼ç±»
      img.classList.remove('fit-mode');
      img.classList.add('coord-mode');
      
      // é‡ç½®çŠ¶æ€æŒ‡ç¤ºå™¨
      const indicator = img.parentElement.querySelector('.mode-indicator');
      if (indicator) {
        indicator.textContent = 'æ­é…';
        indicator.style.background = 'rgba(0, 0, 0, 0.7)';
      }
      
      // æ˜¾ç¤ºå¼¹çª—
      modal.style.display = 'flex';
      setTimeout(() => {
        modal.classList.add('show');
      }, 10);
    }

    function closeOutfitModal() {
      const modal = document.getElementById('outfitModal');
      modal.classList.remove('show');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }

    // å¤„ç†æ­é…å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
    async function handleOutfitImageClick() {
      const img = document.getElementById('outfitImage1');
      const baseFilename = img.getAttribute('data-base');
      const coordFilename = img.getAttribute('data-filename');
      
      console.log('=== å¤„ç†æ­é…å›¾ç‰‡ç‚¹å‡»äº‹ä»¶ ===');
      console.log('åŸºç¡€æ–‡ä»¶å:', baseFilename);
      console.log('æ­é…æ–‡ä»¶å:', coordFilename);
      
      // æ£€æŸ¥å½“å‰æ˜¾ç¤ºçš„æ˜¯æ­é…å›¾è¿˜æ˜¯è¯•ç©¿å›¾
      const isShowingFit = img.getAttribute('data-showing-fit') === 'true';
      
      if (isShowingFit) {
        // å½“å‰æ˜¾ç¤ºè¯•ç©¿å›¾ï¼Œåˆ‡æ¢å›æ­é…å›¾
        await switchToCoordMode(img, baseFilename, coordFilename);
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯¹åº”çš„è¯•ç©¿å›¾åƒ
      const fitFilename = coordFilename.replace('.jpg', '_FIT.jpg');
      const fitPath = `/static/recoms/${baseFilename}/${fitFilename}`;
      const coordPath = `/static/recoms/${baseFilename}/${coordFilename}`;
      
      console.log('è¯•ç©¿å›¾åƒè·¯å¾„:', fitPath);
      console.log('æ­é…å›¾åƒè·¯å¾„:', coordPath);
      
      // æ£€æŸ¥è¯•ç©¿å›¾åƒæ˜¯å¦å­˜åœ¨
      try {
        const fitResponse = await fetch(fitPath, { method: 'HEAD' });
        const fitExists = fitResponse.ok;
        
        if (fitExists) {
          console.log('è¯•ç©¿å›¾åƒå­˜åœ¨ï¼Œåˆ‡æ¢åˆ°è¯•ç©¿æ•ˆæœ');
          // è¯•ç©¿å›¾åƒå­˜åœ¨ï¼Œåˆ‡æ¢åˆ°è¯•ç©¿æ•ˆæœ
          await switchToFitMode(img, fitPath);
        } else {
          console.log('è¯•ç©¿å›¾åƒä¸å­˜åœ¨ï¼Œç”Ÿæˆè¯•ç©¿æ•ˆæœ');
          // è¯•ç©¿å›¾åƒä¸å­˜åœ¨ï¼Œç”Ÿæˆè¯•ç©¿æ•ˆæœ
          await generateTryOnImage(baseFilename, coordFilename, img);
        }
      } catch (error) {
        console.log('æ£€æŸ¥è¯•ç©¿å›¾åƒå¤±è´¥ï¼Œç”Ÿæˆæ–°çš„è¯•ç©¿æ•ˆæœ');
        // æ£€æŸ¥å¤±è´¥ï¼Œç”Ÿæˆæ–°çš„è¯•ç©¿æ•ˆæœ
        await generateTryOnImage(baseFilename, coordFilename, img);
      }
    }

    // åˆ‡æ¢åˆ°è¯•ç©¿æ¨¡å¼
    async function switchToFitMode(imgElement, fitPath) {
      // æ·»åŠ åˆ‡æ¢åŠ¨ç”»
      imgElement.classList.add('switching');
      
      // ç­‰å¾…åŠ¨ç”»å¼€å§‹
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // åˆ‡æ¢å›¾ç‰‡æº
      imgElement.src = fitPath;
      imgElement.setAttribute('data-showing-fit', 'true');
      
      // æ›´æ–°æ ·å¼ç±»
      imgElement.classList.remove('coord-mode');
      imgElement.classList.add('fit-mode');
      
      // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
      const indicator = imgElement.parentElement.querySelector('.mode-indicator');
      if (indicator) {
        indicator.textContent = 'è¯•ç©¿';
        indicator.style.background = 'rgba(103, 58, 183, 0.8)';
      }
      
      // ç­‰å¾…åŠ¨ç”»å®Œæˆ
      setTimeout(() => {
        imgElement.classList.remove('switching');
      }, 600);
      
      showNotification('å·²åˆ‡æ¢åˆ°è¯•ç©¿æ•ˆæœ', 'success');
    }

    // åˆ‡æ¢åˆ°æ­é…æ¨¡å¼
    async function switchToCoordMode(imgElement, baseFilename, coordFilename) {
      // æ·»åŠ åˆ‡æ¢åŠ¨ç”»
      imgElement.classList.add('switching');
      
      // ç­‰å¾…åŠ¨ç”»å¼€å§‹
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // åˆ‡æ¢å›¾ç‰‡æº
      const coordPath = `/static/recoms/${baseFilename}/${coordFilename}`;
      imgElement.src = coordPath;
      imgElement.removeAttribute('data-showing-fit');
      
      // æ›´æ–°æ ·å¼ç±»
      imgElement.classList.remove('fit-mode');
      imgElement.classList.add('coord-mode');
      
      // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
      const indicator = imgElement.parentElement.querySelector('.mode-indicator');
      if (indicator) {
        indicator.textContent = 'æ­é…';
        indicator.style.background = 'rgba(0, 0, 0, 0.7)';
      }
      
      // ç­‰å¾…åŠ¨ç”»å®Œæˆ
      setTimeout(() => {
        imgElement.classList.remove('switching');
      }, 600);
      
      showNotification('å·²åˆ‡æ¢å›æ­é…æ•ˆæœ', 'success');
    }

    // åˆ‡æ¢å›¾ç‰‡æ¨¡å¼ï¼ˆé€šè¿‡æŒ‰é’®ï¼‰
    async function toggleImageMode(imgElement) {
      const baseFilename = imgElement.getAttribute('data-base');
      const coordFilename = imgElement.getAttribute('data-filename');
      const isShowingFit = imgElement.getAttribute('data-showing-fit') === 'true';
      
      if (isShowingFit) {
        await switchToCoordMode(imgElement, baseFilename, coordFilename);
      } else {
        const fitFilename = coordFilename.replace('.jpg', '_FIT.jpg');
        const fitPath = `/static/recoms/${baseFilename}/${fitFilename}`;
        
        try {
          const fitResponse = await fetch(fitPath, { method: 'HEAD' });
          const fitExists = fitResponse.ok;
          
          if (fitExists) {
            await switchToFitMode(imgElement, fitPath);
          } else {
            await generateTryOnImage(baseFilename, coordFilename, imgElement);
          }
        } catch (error) {
          await generateTryOnImage(baseFilename, coordFilename, imgElement);
        }
      }
    }
    
    // ç”Ÿæˆè¯•ç©¿å›¾åƒ
    async function generateTryOnImage(baseFilename, coordFilename, imgElement) {
      try {
        // æ·»åŠ åŠ è½½çŠ¶æ€
        imgElement.classList.add('loading');
        
        // æ˜¾ç¤ºåŠ è½½é€šçŸ¥
        showNotification('æ­£åœ¨ç”Ÿæˆè¯•ç©¿æ•ˆæœï¼Œè¯·ç¨å€™...', 'info');
        
        // è°ƒç”¨åç«¯APIç”Ÿæˆè¯•ç©¿å›¾åƒ
        const response = await fetch("{% url 'generate_try_on_image' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            coord_filename: coordFilename,
            base_filename: baseFilename
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // ç”ŸæˆæˆåŠŸï¼Œæ˜¾ç¤ºè¯•ç©¿å›¾åƒ
          const fitPath = result.fit_path;
          
          // æ·»åŠ åˆ‡æ¢åŠ¨ç”»
          imgElement.classList.add('switching');
          imgElement.classList.remove('loading');
          
          // ç­‰å¾…åŠ¨ç”»å¼€å§‹
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // åˆ‡æ¢å›¾ç‰‡æº
          imgElement.src = fitPath;
          imgElement.setAttribute('data-showing-fit', 'true');
          
          // æ›´æ–°æ ·å¼ç±»
          imgElement.classList.remove('coord-mode');
          imgElement.classList.add('fit-mode');
          
          // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
          const indicator = imgElement.parentElement.querySelector('.mode-indicator');
          if (indicator) {
            indicator.textContent = 'è¯•ç©¿';
            indicator.style.background = 'rgba(103, 58, 183, 0.8)';
          }
          
          // ç­‰å¾…åŠ¨ç”»å®Œæˆ
          setTimeout(() => {
            imgElement.classList.remove('switching');
          }, 600);
          
          showNotification('è¯•ç©¿æ•ˆæœç”ŸæˆæˆåŠŸï¼', 'success');
        } else {
          // ç”Ÿæˆå¤±è´¥
          imgElement.classList.remove('loading');
          showNotification('è¯•ç©¿æ•ˆæœç”Ÿæˆå¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        console.error('ç”Ÿæˆè¯•ç©¿å›¾åƒé”™è¯¯:', error);
        imgElement.classList.remove('loading');
        showNotification('ç”Ÿæˆè¯•ç©¿æ•ˆæœæ—¶å‡ºé”™ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // è·å–CSRF Tokençš„è¾…åŠ©å‡½æ•°
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('outfitModal');
      if (event.target === modal) {
        closeOutfitModal();
      }
    });

    function getWeather() {
        const citySelect = document.getElementById('citySelect');
        const city = citySelect.value;
        document.cookie = `city=${encodeURIComponent(city)}; path=/`;
        const url = `/get_weather/?city=${encodeURIComponent(city)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    const weatherCardsDiv = document.getElementById('weatherCards');
                    weatherCardsDiv.innerHTML = ''; // æ¸…ç©ºç°æœ‰å¤©æ°”å¡ç‰‡

                    // è·å–ç©¿æ­å»ºè®®ç›¸å…³å…ƒç´ 
                    const hotTag = document.getElementById('hotTag');
                    const suggestText = document.getElementById('suggestText');
                    // è·å–ä»Šæ—¥æ­é…æè¿°å…ƒç´ 
                    const matchDesc = document.getElementById('matchDesc');
                    // è·å–ä»Šæ—¥æ­é…å¡ç‰‡å®¹å™¨
                    const matchCardsDiv = document.getElementById('matchCards');
                    matchCardsDiv.innerHTML = ''; // æ¸…ç©ºç°æœ‰æ­é…å¡ç‰‡

                    // å‡è®¾ä½¿ç”¨ç¬¬ä¸€å¤©çš„å¤©æ°”æ•°æ®æ¥ç”Ÿæˆå»ºè®®
                    const firstWeatherInfo = data.weather_info_list[0];
                    const condition = firstWeatherInfo.condition;
                    const tempHigh = parseInt(firstWeatherInfo.temp_high);
                    const tempLow = parseInt(firstWeatherInfo.temp_low);

                    if (condition === 'æ™´' && tempLow >= 20) {
                        hotTag.textContent = 'çƒ­';
                        hotTag.className = 'hot-tag hot';
                        suggestText.textContent = 'é€‚åˆç©¿æ¸…å‡‰çŸ­è¢–æ­é…çŸ­è£¤ï¼ŒçŸ­è£™ç­‰å¤æ—¥è£…æ‰®ã€‚';
                        // æ ¹æ®å¤©æ°”æƒ…å†µä¿®æ”¹ä»Šæ—¥æ­é…æè¿°
                        matchDesc.textContent = 'ä»Šæ—¥é€‚åˆå¤æ—¥æ¸…æ–°é£';
                    } else if (condition.includes('é›¨')) {
                        hotTag.textContent = 'é›¨';
                        hotTag.className = 'hot-tag rain';
                        suggestText.textContent = 'å»ºè®®æ·»åŠ å¤–å¥—ï¼Œå¤–å‡ºæ³¨æ„é˜²é›¨æªæ–½ï¼Œå»ºè®®é€Ÿå¹²æè´¨çš„è¡£ç‰©ã€‚';
                        // æ ¹æ®å¤©æ°”æƒ…å†µä¿®æ”¹ä»Šæ—¥æ­é…æè¿°
                        matchDesc.textContent = 'ä»Šæ—¥é€‚åˆç®€çº¦å®ç”¨é£';
                    } else {
                        hotTag.textContent = 'é˜´';
                        hotTag.className = 'hot-tag cloudy';
                        suggestText.textContent = 'æ¸©åº¦é€‚å®œï¼Œå»ºè®®çŸ­è¢–æ­é…é•¿è£¤ï¼Œé•¿è£™ï¼Œå¯æ ¹æ®ä¸ªäººæƒ…å†µæ·»åŠ è–„å¤–å¥—ã€‚';
                        // æ ¹æ®å¤©æ°”æƒ…å†µä¿®æ”¹ä»Šæ—¥æ­é…æè¿°
                        matchDesc.textContent = 'ä»Šæ—¥é€‚åˆæ—¥å¸¸ä¼‘é—²é£';
                    }

                    data.weather_info_list.forEach(weatherInfo => {
                        const date = weatherInfo.date.slice(5).replace('-', '/');
                        let iconUrl = '';
                        switch (weatherInfo.condition) {
                            case 'æ™´':
                                iconUrl = "{% static 'icons/sunny.png' %}";
                                break;
                            case 'å°é›¨':
                                iconUrl = "{% static 'icons/rainy.png' %}";
                                break;
                            case 'ä¸­é›¨':
                                iconUrl = "{% static 'icons/rainy.png' %}";
                                break;
                            case 'å¤§é›¨':
                                iconUrl = "{% static 'icons/rainy.png' %}";
                                break;
                            case 'é›·é˜µé›¨':
                                iconUrl = "{% static 'icons/é›·é˜µé›¨.png' %}";
                                break;
                            case 'å¤šäº‘':
                                iconUrl = "{% static 'icons/unsunny.png' %}";
                                break;
                            case 'é˜´':
                                iconUrl = "{% static 'icons/unsunny.png' %}";
                                break;
                            case 'é›ª':
                                iconUrl = "{% static 'icons/snowy.png' %}";
                                break;
                            case 'é£':
                                iconUrl = "{% static 'icons/windy.png' %}";
                                break;
                            default:
                                iconUrl = 'https://cdn-icons-png.flaticon.com/512/869/869869.png';
                        }

                        const cardHtml = `
                            <div class="weather-card">
                                <div class="weather-date">${date}</div>
                                <img src="${iconUrl}" alt="${weatherInfo.condition}" class="weather-icon">
                                <div class="weather-temp">${weatherInfo.condition}</div>
                                <div class="weather-temp">${weatherInfo.temp_low}Â°-${weatherInfo.temp_high}Â°</div>
                            </div>
                        `;
                        weatherCardsDiv.innerHTML += cardHtml;
                    });

                    // å¤©æ°”å¡ç‰‡ç”Ÿæˆåé‡æ–°åˆå§‹åŒ–è§¦æ‘¸æ»‘åŠ¨åŠŸèƒ½
                    setTimeout(() => {
                        initWeatherCardsTouchScroll();
                        
                        // æ·»åŠ æ»‘åŠ¨æç¤º
                        const weatherCardsDiv = document.getElementById('weatherCards');
                        if (weatherCardsDiv && weatherCardsDiv.children.length > 1) {
                            // åˆ›å»ºæ»‘åŠ¨æç¤º
                            const hint = document.createElement('div');
                            // è·å–å¤©æ°”å¡ç‰‡å®¹å™¨çš„ä½ç½®ä¿¡æ¯
                            const weatherCardsRect = weatherCardsDiv.getBoundingClientRect();
                            const topPosition = weatherCardsRect.top + weatherCardsRect.height / 2;
                            
                            hint.style.cssText = `
                                position: fixed;
                                top: ${topPosition}px;
                                right: 20px;
                                transform: translateY(-50%);
                                background: rgba(103, 58, 183, 0.8);
                                color: white;
                                padding: 8px 12px;
                                border-radius: 20px;
                                font-size: 12px;
                                z-index: 1000;
                                animation: fadeInOut 3s ease-in-out;
                                pointer-events: none;
                            `;
                            hint.textContent = 'â†åŒå‡»å¡ç‰‡ä»¥æ»‘åŠ¨';
                            document.body.appendChild(hint);
                            
                            // 3ç§’åç§»é™¤æç¤º
                            setTimeout(() => {
                                if (hint.parentNode) {
                                    hint.parentNode.removeChild(hint);
                                }
                            }, 3000);
                        }
                    }, 100);

                    // è°ƒç”¨åç«¯æ¥å£è·å–å›¾ç‰‡ URL
                    const weatherInfo = JSON.stringify(firstWeatherInfo);
                    const matchingUrl = `/get_matching_images/?city=${encodeURIComponent(city)}&weather_info=${encodeURIComponent(weatherInfo)}`;
                    
                    fetch(matchingUrl)
                        .then(response => response.json())
                        .then(matchingData => {
                            if (matchingData.error) {
                                // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
                                showNotification(matchingData.error, 'error');
                            } else {
                                // æ¸…ç©ºç°æœ‰å†…å®¹
                                matchCardsDiv.innerHTML = '';
                                
                                // è®¾ç½®å®¹å™¨æ ·å¼
                                matchCardsDiv.style.display = 'flex';
                                matchCardsDiv.style.gap = '12px';
                                matchCardsDiv.style.justifyContent = 'flex-start'; // å·¦å¯¹é½
                                
                                matchingData.image_urls.forEach((imageUrl, index) => {
                                    // ä»URLä¸­æå–ç›®å½•åå’Œæ–‡ä»¶å
                                    const urlParts = imageUrl.split('/');
                                    const directory = urlParts[urlParts.length - 2];
                                    const filename = urlParts[urlParts.length - 1];
                                    
                                    // æå–åŸºç¡€æ–‡ä»¶åï¼ˆå»æ‰æ‰©å±•åï¼‰
                                    const baseFilename = directory;
                                    const coordFilename = filename;
                                    
                                    // è®¡ç®—å›¾ç‰‡å®½åº¦ï¼šå¦‚æœåªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œå®½åº¦ä¸º200pxï¼›å¦‚æœæœ‰ä¸¤å¼ å›¾ç‰‡ï¼Œæ¯å¼ å®½åº¦ä¸º180px
                                    const cardWidth = matchingData.image_urls.length === 1 ? '200px' : '180px';
                                    
                                    const imgHtml = `
                                        <div class="match-card" style="width: ${cardWidth}; height: 300px; cursor: pointer; flex-shrink: 0;" 
                                             onclick="showOutfitModal('${baseFilename}', '${coordFilename}', '${imageUrl}')">
                                            <img src="${imageUrl}" alt="æ­é…å›¾ç‰‡" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                                        </div>
                                    `;
                                    matchCardsDiv.innerHTML += imgHtml;
                                });
                            }
                        })
                        .catch(error => {
                            showNotification('è¯·æ±‚æ­é…å›¾ç‰‡ä¿¡æ¯æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•', 'error');
                            console.error('Error:', error);
                        });
                }
            })
            .catch(error => {
                alert('è¯·æ±‚å¤©æ°”ä¿¡æ¯æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•');
                console.error('Error:', error);
            });
    }

    // å¤©æ°”å¡ç‰‡è§¦æ‘¸æ»‘åŠ¨åŠŸèƒ½ - å¢å¼ºç‰ˆæœ¬
    function initWeatherCardsTouchScroll() {
        const weatherCards = document.getElementById('weatherCards');
        if (!weatherCards) {
            console.log('Weather cards container not found');
            return;
        }

        console.log('Initializing enhanced weather cards touch scroll');

        // ç§»é™¤æ‰€æœ‰ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
        const newWeatherCards = weatherCards.cloneNode(true);
        weatherCards.parentNode.replaceChild(newWeatherCards, weatherCards);
        
        // é‡æ–°è·å–å…ƒç´ å¼•ç”¨
        const freshWeatherCards = document.getElementById('weatherCards');

        // ç¡®ä¿CSSæ ·å¼æ­£ç¡®åº”ç”¨
        freshWeatherCards.style.overflowX = 'auto';
        freshWeatherCards.style.webkitOverflowScrolling = 'touch';
        freshWeatherCards.style.scrollBehavior = 'smooth';
        freshWeatherCards.style.touchAction = 'pan-x';
        freshWeatherCards.style.userSelect = 'none';
        freshWeatherCards.style.webkitUserSelect = 'none';
        freshWeatherCards.style.mozUserSelect = 'none';
        freshWeatherCards.style.msUserSelect = 'none';
        
        // æ·»åŠ è§¦æ‘¸æç¤º
        freshWeatherCards.style.cursor = 'grab';
        freshWeatherCards.setAttribute('title', 'å·¦å³æ»‘åŠ¨æŸ¥çœ‹å¤©æ°”');
        
        // ç®€åŒ–æ»šåŠ¨çŠ¶æ€æ£€æµ‹
        freshWeatherCards.addEventListener('scroll', function() {
            console.log('Scroll detected');
        });
        
        // æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨æ¥å¢å¼ºå“åº”æ€§
        freshWeatherCards.addEventListener('touchstart', function(e) {
            console.log('Touch start detected');
            // å¼ºåˆ¶è§¦å‘é‡æ’ä»¥ç¡®ä¿è§¦æ‘¸å“åº”
            freshWeatherCards.offsetHeight;
        }, { passive: true });
        
        freshWeatherCards.addEventListener('touchmove', function(e) {
            console.log('Touch move detected');
        }, { passive: true });
        
        freshWeatherCards.addEventListener('touchend', function(e) {
            console.log('Touch end detected');
        }, { passive: true });
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ¥æµ‹è¯•æ»‘åŠ¨åŒºåŸŸ
        freshWeatherCards.addEventListener('click', function(e) {
            console.log('Click detected on weather cards container');
        });
        
        // æ·»åŠ åŒå‡»äº‹ä»¶æ¥å¼ºåˆ¶åˆ·æ–°æ»‘åŠ¨åŠŸèƒ½
        freshWeatherCards.addEventListener('dblclick', function(e) {
            console.log('Double click detected, refreshing scroll functionality');
            initWeatherCardsTouchScroll();
        });
        
        console.log('Weather cards touch scroll initialized successfully');
        console.log('Container styles:', {
            overflowX: freshWeatherCards.style.overflowX,
            webkitOverflowScrolling: freshWeatherCards.style.webkitOverflowScrolling,
            scrollBehavior: freshWeatherCards.style.scrollBehavior,
            touchAction: freshWeatherCards.style.touchAction
        });
    }
</script>
    </div>
</body>
</body>

</html>
