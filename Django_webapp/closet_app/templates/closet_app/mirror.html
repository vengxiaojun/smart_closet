<!DOCTYPE html>
<html lang="zh-CN">
{% load static %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#673ab7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>æ­é…é­”é•œ - æ™ºèƒ½æ­é…åŠ©æ‰‹</title>
  <link rel="stylesheet" href="{% static 'closet_app/responsive.css' %}">
  <script src="{% static 'closet_app/device-adapter.js' %}"></script>
  <style>
    /* é‡ç½®é»˜è®¤æ ·å¼ï¼Œæ–¹ä¾¿ç»Ÿä¸€æ§åˆ¶ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    /* ä¸ºé¡µé¢ä¸»ä½“æ·»åŠ åº•éƒ¨è¾¹è·ï¼Œé˜²æ­¢è¢«å›ºå®šå¯¼èˆªæ é®æŒ¡ */
    body {
      padding-bottom: 80px;
      background-color: #E4DCF5;
    }

    /* é¡µé¢å®¹å™¨æœ€å¤§å®½åº¦é™åˆ¶ */
    .page-container {
      max-width: 440px; /* æ¯”ä¸€èˆ¬æ‰‹æœºå±å¹•(375px)å®½çº¦17% */
      margin: 0 auto;
      background-color: #E4DCF5;
      min-height: 100vh;
      position: relative;
      overflow: hidden; /* ç¦ç”¨çºµå‘æ»‘åŠ¨ */
      touch-action: none; /* ç¦ç”¨è§¦æ‘¸æ»‘åŠ¨ */
      -webkit-overflow-scrolling: none; /* ç¦ç”¨iOSæ»šåŠ¨ */
    }

    /* æ‰‹æœºç«¯ç¦ç”¨æ»‘åŠ¨ */
    @media (max-width: 440px) {
      body {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
        touch-action: none;
        -webkit-overflow-scrolling: none;
      }
      
      html {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }
    }

    /* åœ¨ç”µè„‘ç«¯æ˜¾ç¤ºè¾¹æ¡†æ•ˆæœ */
    @media (min-width: 441px) {
      .page-container {
        border-left: 1px solid rgba(103, 58, 183, 0.1);
        border-right: 1px solid rgba(103, 58, 183, 0.1);
        box-shadow: 0 0 20px rgba(103, 58, 183, 0.1);
        margin-top: 20px; /* åœ¨ç”µè„‘ç«¯æ·»åŠ é¡¶éƒ¨è¾¹è· */
        margin-bottom: 20px; /* åœ¨ç”µè„‘ç«¯æ·»åŠ åº•éƒ¨è¾¹è· */
        border-radius: 12px; /* åœ†è§’æ•ˆæœ */
      }
    }

    /* é‡ç½® i æ ‡ç­¾çš„æ–œä½“æ ·å¼ï¼Œç¡®ä¿å›¾æ ‡æ­£å¸¸æ˜¾ç¤º */
    i {
      font-style: normal;
    }



    /* æ ‡é¢˜æ  */
    .title-bar {
      background: url("https://tse2.mm.bing.net/th/id/OIP.lM5MtEwr1UPCH47MeRafWAHaEG?rs=1&pid=ImgDetMain&o=7&rm=3");
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .title {
      font-size: 28px;
      color: #E4DCF5;
      font-weight: bold;
    }



    /* é€‰æ‹©æ¡†åŒºåŸŸ */
    .select-section {
      padding: 24px;
    }

    .select-box {
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #a1b5d0;
      border: 1px solid #c6f6f1;
      border-radius: 14px;
      padding: 14px 20px;
      margin-bottom: 30px;
      cursor: pointer;
      user-select: none;
    }

    .select-box span {
      font-size: 16px;
      color: #333;
    }

    .select-box i {
      font-size: 16px;
      color: #333;
      transition: transform 0.3s ease;
    }

    /* ä¸‹æ‹‰èœå• */
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      margin-top: 8px;
      padding: 8px 0;
      z-index: 999;
      max-height: 180px;
      overflow-y: auto;
    }

    .dropdown-menu li {
      padding: 8px 20px;
      font-size: 14px;
      color: #333;
      list-style: none;
      transition: background-color 0.2s ease;
    }

    .dropdown-menu li:hover {
      background-color: #f0f0f0;
    }

    /* å±•å¼€æ—¶ç®­å¤´å‘ä¸Š */
    .select-box.open i {
      transform: rotate(180deg);
    }

    .select-box.open .dropdown-menu {
      display: block;
    }

    /* è¾“å…¥ä¸è¯­éŸ³åŒºåŸŸ */
    .input-section {
      padding: 0 18px;
      position: relative;
    }

    .voice-btn {
      width: 56px;
      height: 56px;
      background-color: #ccc;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 70px;
      cursor: pointer;
      /* å¢åŠ è§¦æ‘¸åŒºåŸŸ */
      min-height: 56px;
      min-width: 56px;
      /* é˜²æ­¢æ–‡æœ¬é€‰ä¸­ */
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      /* ç§»é™¤ç‚¹å‡»é«˜äº® */
      -webkit-tap-highlight-color: transparent;
      /* ç¡®ä¿åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæœ‰è¶³å¤Ÿçš„ç‚¹å‡»åŒºåŸŸ */
      padding: 8px;
      /* å¢åŠ è§¦æ‘¸å“åº” */
      touch-action: manipulation;
    }

    .voice-btn i {
      background-color: transparent;
      border-radius: 0;
      margin-left: 0;
      font-size: 28px;
      line-height: 1;
    }

    .input-box {
      width: 100%;
      display: flex;
      align-items: center;
      margin-bottom: 70px;
      background-color: #e6e6e6;
      border-radius: 20px;
      padding: 8px 12px;
    }

    .input-box input {
      border: none;
      outline: none;
      background-color: transparent;
      font-size: 14px;
      color: #333;
      flex: 1;
    }

    .send-btn {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 48px;
      height: 48px;
      margin-left: auto;
      margin-right: auto;
      cursor: pointer;
      /* å¢åŠ è§¦æ‘¸åŒºåŸŸ */
      min-height: 48px;
      min-width: 48px;
      /* é˜²æ­¢æ–‡æœ¬é€‰ä¸­ */
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      /* ç§»é™¤ç‚¹å‡»é«˜äº® */
      -webkit-tap-highlight-color: transparent;
      /* ç¡®ä¿åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæœ‰è¶³å¤Ÿçš„ç‚¹å‡»åŒºåŸŸ */
      padding: 8px;
      /* å¢åŠ è§¦æ‘¸å“åº” */
      touch-action: manipulation;
    }

    .send-btn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: all 0.3s ease;
    }
    
    .send-btn.retry-mode img {
      transform: rotate(180deg);
    }
    
    .send-btn.retry-mode {
      background: linear-gradient(135deg, rgba(103, 58, 183, 0.7), rgba(156, 39, 176, 0.7));
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(103, 58, 183, 0.2);
    }
    
    .send-btn.retry-mode:active {
      transform: scale(0.95) rotate(180deg);
      transition: all 0.2s ease;
    }
    
    .send-btn.retry-mode:active img {
      transform: rotate(180deg);
      transition: all 0.2s ease;
    }
    
    .send-btn.retry-mode.rotating {
      animation: rotate360 0.8s ease-in-out;
    }
    
    .send-btn.retry-mode.rotating img {
      animation: rotate360 0.8s ease-in-out;
    }
    
    @keyframes rotate360 {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    /* åº•éƒ¨å¯¼èˆªæ ï¼ˆå¤ç”¨é€šç”¨æ ·å¼ï¼‰ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 440px; /* ä¸é¡µé¢å®¹å™¨ä¿æŒä¸€è‡´ */
      height: 60px;
      background: #fff;
      border-top: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1000;
    }

    /* åœ¨ç”µè„‘ç«¯ä¸ºåº•éƒ¨å¯¼èˆªæ æ·»åŠ è¾¹æ¡†æ•ˆæœ */
    @media (min-width: 441px) {
      .bottom-nav {
        border-left: 1px solid rgba(103, 58, 183, 0.1);
        border-right: 1px solid rgba(103, 58, 183, 0.1);
        border-bottom: 1px solid rgba(103, 58, 183, 0.1);
        border-radius: 0 0 12px 12px; /* åº•éƒ¨åœ†è§’ */
        box-shadow: 0 0 20px rgba(103, 58, 183, 0.1);
      }
    }

    .nav-item {
      text-align: center;
      flex: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s ease;
      padding: 8px 0;
      min-height: 60px;
    }
    .nav-item:hover {
      background-color: #f5f5f5;
    }
    .nav-item:active {
      background-color: #e0e0e0;
    }
    .nav-item i {
      font-size: 22px;
      color: #999;
      display: block;
      margin-bottom: 2px;
      pointer-events: none;
    }
    .nav-item span {
      font-size: 12px;
      color: #999;
      pointer-events: none;
    }
    .nav-item.active span {
      color: #673ab7;
    }

    /* ä¸­é—´æ‚¬æµ®æŒ‰é’® */
    .floating-btn {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      width: 56px;
      height: 56px;
      background: #673ab7;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      /* å¢åŠ è§¦æ‘¸åŒºåŸŸ */
      min-height: 56px;
      min-width: 56px;
      /* é˜²æ­¢æ–‡æœ¬é€‰ä¸­ */
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      /* ç§»é™¤ç‚¹å‡»é«˜äº® */
      -webkit-tap-highlight-color: transparent;
      /* ç¡®ä¿åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæœ‰è¶³å¤Ÿçš„ç‚¹å‡»åŒºåŸŸ */
      padding: 8px;
      /* å¢åŠ è§¦æ‘¸å“åº” */
      touch-action: manipulation;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .floating-btn:hover {
      transform: translateX(-50%) scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    .floating-btn:active {
      transform: translateX(-50%) scale(0.95);
    }

    /* åŠ¨æ€æç¤ºæŒ‰é’® */
    .custom-try-on-hint {
      position: fixed;
      bottom: 130px;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      background: rgba(103, 58, 183, 0.9);
      color: white;
      padding: 12px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 999;
      pointer-events: none;
      opacity: 0;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }

    .custom-try-on-hint.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-10px);
    }

    .custom-try-on-hint.hide {
      opacity: 0;
      transform: translateX(-50%) translateY(-10px);
    }

    /* ä¿æŒæ˜¾ç¤ºçŠ¶æ€çš„æ ·å¼ */
    .custom-try-on-hint.show {
      opacity: 1 !important;
      transform: translateX(-50%) translateY(-10px) !important;
    }

    /* æç¤ºæŒ‰é’®åŠ¨ç”» */
    @keyframes hintPulse {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.05); }
      100% { transform: translateX(-50%) scale(1); }
    }

    .custom-try-on-hint.pulse {
      animation: hintPulse 2s ease-in-out infinite;
    }

    /* æç¤ºæŒ‰é’®å…¥åœºåŠ¨ç”» */
    @keyframes hintSlideIn {
      0% { 
        opacity: 0; 
        transform: translateX(-50%) translateY(-40px);
      }
      100% { 
        opacity: 1; 
        transform: translateX(-50%) translateY(-10px);
      }
    }

    .custom-try-on-hint.slide-in {
      animation: hintSlideIn 0.6s ease-out forwards;
    }

    /* è‡ªå®šä¹‰è¯•ç©¿å¼¹çª— */
    .custom-try-on-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
    }

    .custom-try-on-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 24px;
      max-width: 800px;
      width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .custom-try-on-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }

    .custom-try-on-close:hover {
      background: rgba(255, 255, 255, 1);
      color: #666;
      transform: scale(1.1);
    }

    /* ç”¨æˆ·é€‰æ‹©åŒºåŸŸ */
    .user-selection {
      margin-bottom: 20px;
      padding: 16px;
      background: rgba(103, 58, 183, 0.1);
      border-radius: 12px;
    }

    .user-selection label {
      font-weight: bold;
      margin-right: 12px;
    }

    .user-selection select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    /* ä¸»è¦å†…å®¹åŒºåŸŸ */
    .custom-try-on-main {
      display: flex;
      gap: 20px;
    }

    /* è¡£ç‰©é€‰æ‹©åŒºåŸŸ */
    .garment-selection {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .garment-section {
      background: rgba(245, 245, 245, 0.8);
      border-radius: 12px;
      padding: 16px;
    }

    .garment-section h3 {
      margin: 0 0 12px 0;
      color: #333;
      font-size: 16px;
    }

    .garment-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 120px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .garment-placeholder:hover {
      border-color: #673ab7;
      background: rgba(103, 58, 183, 0.05);
    }

    .garment-placeholder i {
      font-size: 32px;
      margin-bottom: 8px;
      color: #999;
    }

    .garment-placeholder span {
      font-size: 14px;
      color: #666;
    }

    .garment-selected {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .garment-selected img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }

    .garment-selected span {
      font-size: 12px;
      color: #333;
      text-align: center;
    }

    .garment-selected button {
      padding: 4px 8px;
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    /* è¯•ç©¿ç»“æœåŒºåŸŸ */
    .try-on-result {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .try-on-result h3 {
      margin: 0 0 12px 0;
      color: #333;
      font-size: 16px;
    }

    .try-on-image-container {
      flex: 1;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(245, 245, 245, 0.8);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .try-on-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #999;
    }

    .try-on-placeholder i {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .try-on-placeholder span {
      font-size: 14px;
      text-align: center;
    }

    #generateTryOnBtn {
      padding: 12px 24px;
      background: #673ab7;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #generateTryOnBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #generateTryOnBtn:not(:disabled):hover {
      background: #5e35b1;
      transform: translateY(-2px);
    }

    /* è¡£ç‰©é€‰æ‹©å¼¹çª— */
    .garment-selector-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
    }

    .garment-selector-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 24px;
      max-width: 900px;
      width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .garment-selector-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }

    .garment-selector-close:hover {
      background: rgba(255, 255, 255, 1);
      color: #666;
      transform: scale(1.1);
    }

    .garment-selector-main {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    /* åˆ†ç±»å¯¼èˆª */
    .category-nav {
      width: 120px;
      background: rgba(103, 58, 183, 0.1);
      border-radius: 12px;
      padding: 12px;
      position: sticky;
      top: 0;
      height: fit-content;
      max-height: 700px; /* ä»400pxå¢åŠ åˆ°500pxï¼Œå¢åŠ 25% */
      overflow-y: auto;
    }

    .category-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 8px;
      margin-bottom: 8px;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .category-item:hover {
      background: rgba(103, 58, 183, 0.1);
    }

    .category-item.active {
      background: #673ab7;
      color: white;
    }

    .category-item .category-icon {
      width: 24px;
      height: 24px;
      margin-bottom: 4px;
      object-fit: contain;
    }

    .category-item span {
      font-size: 12px;
      text-align: center;
    }

    /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
    .upload-section {
      margin-top: 20px;
      padding: 12px;
      border-top: 1px solid rgba(103, 58, 183, 0.2);
    }

    .upload-btn {
      width: 100%;
      padding: 12px;
      background: rgba(103, 58, 183, 0.1);
      border: 2px dashed rgba(103, 58, 183, 0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .upload-btn:hover {
      background: rgba(103, 58, 183, 0.2);
      border-color: rgba(103, 58, 183, 0.5);
    }

    .upload-btn i {
      font-size: 20px;
      color: #673ab7;
    }

    .upload-btn span {
      font-size: 12px;
      color: #673ab7;
      font-weight: 500;
    }

    .upload-hint {
      font-size: 10px;
      color: #999;
      text-align: center;
      margin-top: 8px;
      line-height: 1.3;
    }

    /* è¡£ç‰©å±•ç¤ºç½‘æ ¼ */
    .garment-display {
      flex: 1;
    }

    .garment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      max-height: 700px; /* ä»400pxå¢åŠ åˆ°500pxï¼Œä¿æŒä¸å·¦ä¾§å¯¼èˆªä¸€è‡´ */
      overflow-y: auto;
    }

    .garment-item {
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .garment-item:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .garment-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }

    .garment-item.selected {
      border: 3px solid #673ab7;
    }

    .no-category, .no-garments {
      text-align: center;
      color: #999;
      padding: 20px;
      font-size: 14px;
    }

    /* æ–°å¢ç”¨æˆ·é¡¹æ ·å¼ */
    .user-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* æ­é…å›¾ç‰‡å®¹å™¨æ ·å¼ */
    .coord-image-container {
      margin-top: 20px;
      text-align: center;
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 280px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid rgba(103, 58, 183, 0.1);
      position: relative;
      z-index: 10;
    }

    .coord-image-container img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      display: block;
      margin: 0 auto;
      max-height: 400px;
      object-fit: contain;
    }

    .coord-image-container .title {
      font-size: 14px;
      font-weight: bold;
      color: #673ab7;
      margin-bottom: 10px;
      text-align: center;
    }

    /* å¼¹çª—æ ·å¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      width: calc(100% - 40px);
      max-width: 390px;
      height: 70vh;
      position: relative;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(103, 58, 183, 0.2);
      transform: translateY(100%);
      animation: slideUp 0.3s ease-out forwards;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(103, 58, 183, 0.3);
    }

    .modal-title {
      font-size: 16px;
      font-weight: bold;
      color: #673ab7;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 9999;
    }

    .modal-close:hover {
      background-color: rgba(103, 58, 183, 0.2);
      color: #673ab7;
      transform: scale(1.1);
    }

    .modal-body {
      display: flex;
      flex: 1 1 auto;
      height: calc(100% - 60px);
      width: 100%;
      margin-top: 10px;
      gap: 15px;
    }

    .modal-left {
      flex: 1 1 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .modal-right {
      flex: 1 1 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      position: relative;
    }

    .modal-image {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      object-fit: contain;
      background: rgba(245, 245, 245, 0.8);
      border: 2px dashed rgba(103, 58, 183, 0.3);
      backdrop-filter: blur(5px);
    }

    .try-on-button {
      background: linear-gradient(135deg, #673ab7, #9c27b0);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(103, 58, 183, 0.3);
      transition: all 0.3s ease;
    }

    .try-on-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(103, 58, 183, 0.4);
    }

    .try-on-button:active {
      transform: translateY(0);
    }

    .placeholder-image {
      width: 100%;
      height: 100%;
      background: rgba(245, 245, 245, 0.8);
      border: 2px dashed rgba(103, 58, 183, 0.3);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      backdrop-filter: blur(5px);
    }

    .loading-spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid rgba(103, 58, 183, 0.3);
      border-radius: 50%;
      border-top-color: #673ab7;
      animation: spin 1s ease-in-out infinite;
    }

    .retry-button {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
      transition: all 0.3s ease;
    }

    .retry-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
    }

    .try-on-result {
      margin-top: 15px;
      text-align: center;
    }

    .try-on-result img {
      border: 2px solid #673ab7;
      box-shadow: 0 2px 8px rgba(103, 58, 183, 0.2);
    }

    /* æŸ¥çœ‹æ­é…æŒ‰é’®æ ·å¼ */
    .view-outfit-btn {
      margin-top: 15px;
      text-align: center;
      animation: fadeInUp 0.5s ease-out;
    }

    .outfit-btn {
      background: linear-gradient(135deg, #673ab7, #9c27b0);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 16px 32px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(103, 58, 183, 0.3);
      transition: all 0.3s ease;
      margin: 0 auto;
      /* å¢åŠ è§¦æ‘¸åŒºåŸŸ */
      min-height: 48px;
      min-width: 120px;
      /* é˜²æ­¢æ–‡æœ¬é€‰ä¸­ */
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      /* ç§»é™¤ç‚¹å‡»é«˜äº® */
      -webkit-tap-highlight-color: transparent;
      /* å¢åŠ è§¦æ‘¸å“åº” */
      touch-action: manipulation;
    }
    
    .view-outfit-btn {
      transition: all 0.3s ease;
      opacity: 1;
      transform: translateY(0);
    }
    
    .view-outfit-btn.fade-out {
      opacity: 0;
      transform: translateY(-20px);
    }

    .outfit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(103, 58, 183, 0.4);
    }

    .outfit-btn:active {
      transform: translateY(0);
    }

    .btn-icon {
      font-size: 16px;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }



    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 400px) {
      .modal-content {
        max-width: 100%;
        border-radius: 15px 15px 0 0;
        padding: 15px;
      }
      
      .modal-overlay {
        padding-bottom: 70px;
      }
    }

    /* é€šçŸ¥æç¤ºæ ·å¼ */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      max-width: 300px;
      text-align: center;
    }

    .notification.success {
      background-color: #4caf50;
      color: white;
    }

    .notification.error {
      background-color: #f44336;
      color: white;
    }

    .notification.loading {
      background-color: #2196f3;
      color: white;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .notification.hide {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }

    /* è¯„åˆ†åŠŸèƒ½æ ·å¼ */
    .rating-section {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      border: 1px solid rgba(103, 58, 183, 0.2);
      text-align: center;
    }

    .rating-title {
      font-size: 14px;
      color: #673ab7;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .rating-stars {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .star {
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #ddd;
      /* å¢åŠ è§¦æ‘¸åŒºåŸŸ */
      min-width: 40px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      /* é˜²æ­¢æ–‡æœ¬é€‰ä¸­ */
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      /* ç§»é™¤ç‚¹å‡»é«˜äº® */
      -webkit-tap-highlight-color: transparent;
      /* å¢åŠ è§¦æ‘¸å“åº” */
      touch-action: manipulation;
      /* æ·»åŠ è¾¹æ¡†ä»¥ä¾¿è°ƒè¯• */
      border: 1px solid transparent;
      border-radius: 4px;
      /* æ·»åŠ ç‚¹å‡»æ•ˆæœ */
      position: relative;
    }
    
    .star:hover {
      transform: scale(1.1);
      border-color: rgba(103, 58, 183, 0.3);
    }
    
    .star:active {
      transform: scale(0.95);
    }

    .star:hover {
      transform: scale(1.1);
    }

    .star.active {
      color: #ffd700;
    }

    .star.half {
      color: #ffd700;
    }

    .rating-text {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }

    .submit-rating-btn {
      background: linear-gradient(135deg, #673ab7, #9c27b0);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(103, 58, 183, 0.3);
    }

    .submit-rating-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
    }

    .submit-rating-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .rating-submitted {
      color: #4caf50;
      font-size: 12px;
      font-weight: bold;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
    <div class="page-container">
      <!-- æ ‡é¢˜æ  -->
      <div class="title-bar">
      <div class="title">æ­é…é­”é•œ</div>
    </div>

    <!-- é€‰æ‹©æ¡†åŒºåŸŸ -->
    <div class="select-section">
      <div class="select-box dropdown" id="user-select">
        <span id="user-select-text">ç”¨æˆ·é€‰æ‹©</span>
        <i>&#x25BC;</i>
        <ul class="dropdown-menu" id="user-dropdown-menu">
          <!-- ç”¨æˆ·ä¿¡æ¯å°†åŠ¨æ€æ·»åŠ  -->
        </ul>
      </div>
      <div class="select-box dropdown" id="scene-select">
        <span id="scene-select-text">åœºæ™¯é€‰æ‹©</span>
        <i>&#x25BC;</i>
        <ul class="dropdown-menu">
          <li>æ—¥å¸¸ä¼‘é—²</li>
          <li>é€šå‹¤åŠå…¬</li>
          <li>è¿åŠ¨å¥èº«</li>
          <li>æ´¾å¯¹èšä¼š</li>
        </ul>
      </div>
    </div>

    <!-- è¾“å…¥ä¸è¯­éŸ³åŒºåŸŸ -->
    <div class="input-section">
      <div class="input-box">
        <input type="text" placeholder="è¯´å‡ºéœ€æ±‚ï¼Œæˆ‘ä¼šå¸®æ‚¨è‡ªåŠ¨æ­é…" />
        <!-- è¿™é‡Œæ”¾éº¦å…‹é£æŒ‰é’® -->
        <div class="voice-btn" id="voice-btn">
          <i>ğŸ¤</i>
        </div>
      </div>

      <!-- å³ä¸Šè§’æ”¾æ‰‹+åœ°çƒå›¾æ ‡ -->
      <div class="send-btn" id="send-btn">
        <img src="https://cdn-icons-png.flaticon.com/512/724/724927.png" alt="send" />
        <img src="{% static 'icons/retry.png' %}" alt="retry" style="display: none;" />
      </div>
      
      <!-- æŸ¥çœ‹æ­é…æŒ‰é’® -->
      <div class="view-outfit-btn" id="view-outfit-btn" style="display: none;">
        <button class="outfit-btn">
          <span class="btn-text">æŸ¥çœ‹æ­é…</span>
          <div class="btn-icon">ğŸ‘”</div>
        </button>
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ ï¼ˆå¤ç”¨ï¼‰ -->
    <div class="bottom-nav">
      <div class="nav-item">
        <a href="{% url 'index' %}" style="text-decoration: none">
          <i>ğŸ </i>
          <span>Home</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="{% url 'closet' %}" style="text-decoration: none">
          <i>ğŸ‘•</i>
          <span>closet</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="{% url 'match' %}" style="text-decoration: none">
          <i>â­ï¸</i>
          <span>favourite</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="{% url 'profile' %}" style="text-decoration: none">
          <i>ğŸ‘¤</i>
          <span>profile</span>
        </a>
      </div>
    </div>

    <!-- åŠ¨æ€æç¤ºæŒ‰é’® -->
    <div id="customTryOnHint" class="custom-try-on-hint" style="display: none;">
      <span>â†“ç‚¹å‡»è¿›è¡Œè‡ªå®šä¹‰è¯•ç©¿â†“</span>
    </div>

    <!-- ä¸­é—´æ‚¬æµ®æŒ‰é’® -->
    <div class="floating-btn active" onclick="showCustomTryOnModal()">
      <i>ğŸª</i>
    </div>

    <!-- è‡ªå®šä¹‰è¯•ç©¿å¼¹çª— -->
    <div id="customTryOnModal" class="custom-try-on-modal">
      <div class="custom-try-on-content">
        <button class="custom-try-on-close" onclick="closeCustomTryOnModal()">Ã—</button>
        
        <!-- é¡¶éƒ¨ç”¨æˆ·é€‰æ‹© -->
        <div class="user-selection">
          <label for="userSelect">é€‰æ‹©ç”¨æˆ·:</label>
          <select id="userSelect">
            <option value="">é»˜è®¤ç”¨æˆ·</option>
          </select>
        </div>
        
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="custom-try-on-main">
          <!-- å·¦ä¾§è¡£ç‰©é€‰æ‹© -->
          <div class="garment-selection">
            <!-- ä¸Šè¡£é€‰æ‹© -->
            <div class="garment-section">
              <h3>é€‰æ‹©ä¸Šè¡£</h3>
                          <div id="upperPlaceholder" class="garment-placeholder" onclick="showGarmentSelector('upper').catch(console.error)">
              <i>ğŸ‘•</i>
              <span>ç‚¹å‡»é€‰æ‹©ä¸Šè¡£</span>
            </div>
              <div id="upperSelected" class="garment-selected" style="display: none;">
                <img id="upperImage" src="" alt="å·²é€‰ä¸Šè¡£">
                <span id="upperName"></span>
                <button onclick="clearSelection('upper')">æ¸…é™¤</button>
              </div>
            </div>
            
            <!-- ä¸‹è£…é€‰æ‹© -->
            <div class="garment-section">
              <h3>é€‰æ‹©ä¸‹è£…</h3>
                          <div id="lowerPlaceholder" class="garment-placeholder" onclick="showGarmentSelector('lower').catch(console.error)">
              <i>ğŸ‘–</i>
              <span>ç‚¹å‡»é€‰æ‹©ä¸‹è£…</span>
            </div>
              <div id="lowerSelected" class="garment-selected" style="display: none;">
                <img id="lowerImage" src="" alt="å·²é€‰ä¸‹è£…">
                <span id="lowerName"></span>
                <button onclick="clearSelection('lower')">æ¸…é™¤</button>
              </div>
            </div>
          </div>
          
          <!-- å³ä¾§è¯•ç©¿ç»“æœ -->
          <div class="try-on-result">
            <h3>è¯•ç©¿æ•ˆæœ</h3>
            <div id="tryOnImageContainer" class="try-on-image-container">
              <div class="try-on-placeholder">
                <i>ğŸª</i>
                <span>â†“ç‚¹å‡»ä¸‹æ–¹ç”Ÿæˆâ†“</span>
              </div>
            </div>
            <button id="generateTryOnBtn" onclick="generateCustomTryOn()" disabled>ç”Ÿæˆè¯•ç©¿æ•ˆæœ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- è¡£ç‰©é€‰æ‹©å¼¹çª— -->
    <div id="garmentSelectorModal" class="garment-selector-modal">
      <div class="garment-selector-content">
        <button class="garment-selector-close" onclick="closeGarmentSelector()">Ã—</button>
        <h3 id="garmentSelectorTitle">é€‰æ‹©è¡£ç‰©</h3>
        
        <div class="garment-selector-main">
          <!-- å·¦ä¾§åˆ†ç±»å¯¼èˆª -->
          <div class="category-nav">
            <div id="categoryList"></div>
            <!-- è‡ªè¡Œä¸Šä¼ æŒ‰é’® -->
            <div class="upload-section">
              <input type="file" id="garmentUpload" accept="image/*" style="display: none;" onchange="handleGarmentUpload(event)">
              <button class="upload-btn" onclick="document.getElementById('garmentUpload').click()">
                <i>ğŸ“</i>
                <span>è‡ªè¡Œä¸Šä¼ </span>
              </button>
              <p class="upload-hint">ä¸åœ¨è¡£æŸœé‡Œï¼Ÿåœ¨è¿™é‡Œä¸Šä¼ </p>
            </div>
          </div>
          
          <!-- å³ä¾§è¡£ç‰©å±•ç¤º -->
          <div class="garment-display">
            <div id="garmentGrid"></div>
          </div>
        </div>
      </div>
    </div>
    

  <script>
        // ç«å±±å¼•æ“é…ç½®ï¼ˆä»…ä¿ç•™RTCç›¸å…³é…ç½®ï¼ŒASRæ”¹ä¸ºåç«¯å¤„ç†ï¼‰
        const VOLC_CONFIG = {
        appId: '2604474986', // ä»ç«å±±å¼•æ“æ§åˆ¶å°è·å–
        token: 'Z981ceaOj5reMSBsG-Jwguu5I4TPzdUk',
        userId: `user_${Date.now()}` // ç”Ÿæˆå”¯ä¸€ç”¨æˆ·ID
    };

    // å…¨å±€å˜é‡
    let rtcClient = null;
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let Stream = null;
    let finalTranscript = '';
    let interimTranscript = '';
    let selectedUser = null; // å½“å‰é€‰ä¸­çš„ç”¨æˆ·

    // æŒ‰é’®çŠ¶æ€ç®¡ç†å‡½æ•°
    function updateVoiceButtonState(recording) {
        if (recording) {
            voiceBtn.innerHTML = '<i>â¹ï¸</i>';
            voiceBtn.style.backgroundColor = '#ff4444';
            console.log('æŒ‰é’®çŠ¶æ€è®¾ç½®ä¸ºå½•åˆ¶ä¸­');
        } else {
            voiceBtn.innerHTML = '<i>ğŸ¤</i>';
            voiceBtn.style.backgroundColor = '#ccc';
            console.log('æŒ‰é’®çŠ¶æ€è®¾ç½®ä¸ºå¾…æœº');
        }
    }

    // DOMå…ƒç´ 
    const voiceBtn = document.getElementById("voice-btn");
    const inputBox = document.querySelector(".input-box input");

    // åˆå§‹åŒ–ç«å±±å¼•æ“RTCå®¢æˆ·ç«¯
    function initVolcEngines() {
        // åˆå§‹åŒ–RTCå®¢æˆ·ç«¯
        rtcClient = VolcEngineRTC.createClient({
            mode: 'rtc',
            codec: 'opus' // éŸ³é¢‘ä¼˜å…ˆé€‰æ‹©opusç¼–ç 
        });

        // RTCè¿æ¥çŠ¶æ€ç›‘å¬
        rtcClient.on('connection-state-change', (state) => {
            console.log('RTCè¿æ¥çŠ¶æ€:', state);
            if (state === 'disconnected' && isRecording) {
                alert('è¿æ¥å·²æ–­å¼€ï¼Œè¯­éŸ³å½•åˆ¶å·²åœæ­¢');
                stopRecording();
            }
        });
    }

         // å¼€å§‹å½•åˆ¶éŸ³é¢‘å¹¶å‘é€åˆ°åç«¯
     async function startRecording() {
         if (isRecording) return;
 
         try {
                          console.log('å¼€å§‹å½•åˆ¶éŸ³é¢‘...');
             
             // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
             if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                 console.error('getUserMedia API ä¸å¯ç”¨');
                 console.log('navigator.mediaDevices:', navigator.mediaDevices);
                 throw new Error('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³å½•åˆ¶åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Safariã€Edgeç­‰ï¼‰');
             }
             
             // æ›´æ–°æŒ‰é’®çŠ¶æ€
             console.log('æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºå½•åˆ¶ä¸­...');
             updateVoiceButtonState(true);
             isRecording = true;
             console.log('æŒ‰é’®çŠ¶æ€å·²æ›´æ–°ï¼ŒisRecording:', isRecording);
             finalTranscript = inputBox.value;
             interimTranscript = '';
             audioChunks = [];
             
             console.log('å°è¯•è·å–éº¦å…‹é£æƒé™...');
             
             // è·å–éº¦å…‹é£æƒé™å¹¶åˆ›å»ºéŸ³é¢‘æµï¼ˆä½¿ç”¨æ›´å…¼å®¹çš„é…ç½®ï¼‰
             const constraints = {
                 audio: {
                     echoCancellation: true,
                     noiseSuppression: true,
                     autoGainControl: true
                 },
                 video: false
             };
             
             // å°è¯•è·å–éŸ³é¢‘æµ
             stream = await navigator.mediaDevices.getUserMedia(constraints);
             
             console.log('éº¦å…‹é£æƒé™è·å–æˆåŠŸ:', stream);

            // åˆ›å»ºMediaRecorderå½•åˆ¶éŸ³é¢‘
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            // å½•åˆ¶åœæ­¢åå‘é€éŸ³é¢‘åˆ°åç«¯
            mediaRecorder.onstop = async () => {
                await sendAudioToBackend();
            };

            // å¼€å§‹å½•åˆ¶
            mediaRecorder.start();
            console.log('éŸ³é¢‘å½•åˆ¶å·²å¯åŠ¨');
        } catch (error) {
            console.error('å¯åŠ¨å½•åˆ¶å¤±è´¥:', error);
            alert(`å¯åŠ¨å¤±è´¥: ${error.message || 'è¯·æ£€æŸ¥éº¦å…‹é£æƒé™'}`);
            stopRecording();
        }
    }

    // åœæ­¢å½•åˆ¶å¹¶å‘é€éŸ³é¢‘åˆ°åç«¯
    async function stopRecording() {
        if (!isRecording) return;

        console.log('å¼€å§‹åœæ­¢å½•åˆ¶...');
        
        // ç«‹å³æ¢å¤æŒ‰é’®çŠ¶æ€
        console.log('æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºåœæ­¢å½•åˆ¶...');
        updateVoiceButtonState(false);
        isRecording = false;
        console.log('æŒ‰é’®çŠ¶æ€å·²æ¢å¤ï¼ŒisRecording:', isRecording);

        // åœæ­¢å½•åˆ¶å¹¶æ¸…ç†èµ„æº
        try {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                console.log('åœæ­¢MediaRecorder...');
                mediaRecorder.stop();
            }
            
            if (stream) {
                console.log('åœæ­¢éŸ³é¢‘æµ...');
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            console.log('å½•åˆ¶åœæ­¢å®Œæˆ');
        } catch (error) {
            console.error('åœæ­¢å½•åˆ¶å‡ºé”™:', error);
        }
    }

    // ä¸»è¦ä¿®æ”¹å‘é€éŸ³é¢‘çš„éƒ¨åˆ†ï¼Œå…¶ä»–é€»è¾‘ä¿æŒä¸å˜
    async function sendAudioToBackend() {
        if (!audioChunks.length) {
            console.error('æ²¡æœ‰éŸ³é¢‘æ•°æ®å¯å‘é€');
            return;
        }
        
        try {
            // åˆå¹¶æ‰€æœ‰éŸ³é¢‘ç‰‡æ®µä¸ºWAVæ ¼å¼
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            
            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.wav');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            inputBox.value = 'è¯­éŸ³è¯†åˆ«ä¸­...';
            
            // å‘é€éŸ³é¢‘åˆ°åç«¯æ–°æ¥å£
            const response = await fetch('/api/asr/', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
            }
            
            // è§£æJSONå“åº”
            const result = await response.json();
            
            // æ›´æ–°è¯†åˆ«ç»“æœ
            if (result.text) {
                finalTranscript += result.text;
                inputBox.value = finalTranscript;
                console.log('è¯†åˆ«ç»“æœ:', result.text);
            } else {
                console.error('æ²¡æœ‰è¯†åˆ«ç»“æœ:', result);
                alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œæœªè¿”å›ç»“æœ');
            }
        } catch (error) {
            console.error('å‘é€éŸ³é¢‘å¤±è´¥:', error);
            alert(`è¯­éŸ³è¯†åˆ«å¤±è´¥: ${error.message}`);
            inputBox.value = finalTranscript; // æ¢å¤ä¹‹å‰çš„å†…å®¹
        }
    }

         // å…¨å±€æµ‹è¯•å‡½æ•°ï¼Œå¯åœ¨æ§åˆ¶å°è°ƒç”¨
     window.testMicrophone = async function() {
         console.log('=== æ‰‹åŠ¨æµ‹è¯•éº¦å…‹é£ ===');
         try {
             const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
             console.log('âœ… éº¦å…‹é£æµ‹è¯•æˆåŠŸ:', stream);
             stream.getTracks().forEach(track => track.stop());
             return true;
         } catch (error) {
             console.error('âŒ éº¦å…‹é£æµ‹è¯•å¤±è´¥:', error);
             return false;
         }
     };

     // è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥æŒ‰é’®çŠ¶æ€
     window.checkVoiceButtonState = function() {
         console.log('=== æ£€æŸ¥éº¦å…‹é£æŒ‰é’®çŠ¶æ€ ===');
         console.log('isRecording:', isRecording);
         console.log('voiceBtn.innerHTML:', voiceBtn.innerHTML);
         console.log('voiceBtn.style.backgroundColor:', voiceBtn.style.backgroundColor);
         console.log('voiceBtnå…ƒç´ :', voiceBtn);
     };

     // æµ‹è¯•æŒ‰é’®çŠ¶æ€æ›´æ–°
     window.testButtonStateUpdate = function() {
         console.log('=== æµ‹è¯•æŒ‰é’®çŠ¶æ€æ›´æ–° ===');
         console.log('å½“å‰çŠ¶æ€:', isRecording);
         if (isRecording) {
             updateVoiceButtonState(false);
             isRecording = false;
             console.log('å·²åˆ‡æ¢åˆ°å¾…æœºçŠ¶æ€');
         } else {
             updateVoiceButtonState(true);
             isRecording = true;
             console.log('å·²åˆ‡æ¢åˆ°å½•åˆ¶çŠ¶æ€');
         }
     };
     
     // æµ‹è¯•æµè§ˆå™¨æ”¯æŒ
     function testBrowserSupport() {
         console.log('=== æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯• ===');
         console.log('User Agent:', navigator.userAgent);
         console.log('navigator.mediaDevices:', navigator.mediaDevices);
         console.log('navigator.getUserMedia:', navigator.getUserMedia);
         console.log('navigator.webkitGetUserMedia:', navigator.webkitGetUserMedia);
         console.log('navigator.mozGetUserMedia:', navigator.mozGetUserMedia);
         console.log('navigator.msGetUserMedia:', navigator.msGetUserMedia);
         
         // æ£€æŸ¥å„ç§å¯èƒ½çš„getUserMediaå®ç°
         const hasModernAPI = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
         const hasLegacyAPI = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
         
         console.log('ç°ä»£APIæ”¯æŒ:', hasModernAPI);
         console.log('æ—§ç‰ˆAPIæ”¯æŒ:', hasLegacyAPI);
         
         if (hasModernAPI) {
             console.log('âœ… æµè§ˆå™¨æ”¯æŒç°ä»£ getUserMedia API');
             return 'modern';
         } else if (hasLegacyAPI) {
             console.log('âš ï¸ æµè§ˆå™¨æ”¯æŒæ—§ç‰ˆ getUserMedia API');
             return 'legacy';
         } else {
             console.log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ getUserMedia API');
             return 'none';
         }
     }
     
         // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', () => {
      console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
      

      
      // æµ‹è¯•æµè§ˆå™¨æ”¯æŒ
      testBrowserSupport();
         
         // æ£€æŸ¥æ˜¯å¦åœ¨HTTPSç¯å¢ƒä¸‹
         if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
             console.warn('âš ï¸ å½“å‰ä¸åœ¨HTTPSç¯å¢ƒä¸‹ï¼ŒæŸäº›æµè§ˆå™¨å¯èƒ½é™åˆ¶getUserMediaåŠŸèƒ½');
             console.log('å½“å‰åè®®:', location.protocol);
             console.log('å½“å‰ä¸»æœº:', location.hostname);
             
             // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„æç¤º
             const httpsWarning = document.createElement('div');
             httpsWarning.style.cssText = `
                 position: fixed;
                 top: 10px;
                 left: 50%;
                 transform: translateX(-50%);
                 background: #ff9800;
                 color: white;
                 padding: 10px 20px;
                 border-radius: 5px;
                 font-size: 12px;
                 z-index: 1000;
                 max-width: 300px;
                 text-align: center;
             `;
             httpsWarning.innerHTML = `
                 <strong>æç¤ºï¼š</strong>è¯­éŸ³åŠŸèƒ½éœ€è¦HTTPSç¯å¢ƒã€‚<br>
                 å»ºè®®ä½¿ç”¨ <a href="https://127.0.0.1:8000" style="color: white; text-decoration: underline;">https://127.0.0.1:8000</a> è®¿é—®<br>
                 æˆ–è€…ä½¿ç”¨ <a href="http://localhost:8000" style="color: white; text-decoration: underline;">http://localhost:8000</a> è®¿é—®
             `;
             document.body.appendChild(httpsWarning);
             
             // 5ç§’åè‡ªåŠ¨éšè—æç¤º
             setTimeout(() => {
                 if (httpsWarning.parentNode) {
                     httpsWarning.parentNode.removeChild(httpsWarning);
                 }
             }, 5000);
         }
         
         // æ£€æŸ¥æµè§ˆå™¨åŸºæœ¬æ”¯æŒ
         const supportLevel = testBrowserSupport();
         
         if (supportLevel === 'none') {
             console.error('æµè§ˆå™¨å®Œå…¨ä¸æ”¯æŒ getUserMedia');
             alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³å½•åˆ¶åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Safariã€Edgeç­‰ï¼‰');
             return;
         } else if (supportLevel === 'legacy') {
             console.warn('æµè§ˆå™¨æ”¯æŒæ—§ç‰ˆ getUserMedia APIï¼Œå¯ç”¨å…¼å®¹æ¨¡å¼...');
             // ä¸ºæ—§ç‰ˆæµè§ˆå™¨åˆ›å»ºå…¼å®¹å±‚
             if (!navigator.mediaDevices) {
                 navigator.mediaDevices = {};
             }
             
             navigator.mediaDevices.getUserMedia = function(constraints) {
                 const getUserMedia = navigator.getUserMedia || 
                                   navigator.webkitGetUserMedia || 
                                   navigator.mozGetUserMedia || 
                                   navigator.msGetUserMedia;
                                   
                 if (!getUserMedia) {
                     return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                 }
                 
                 return new Promise(function(resolve, reject) {
                     getUserMedia.call(navigator, constraints, resolve, reject);
                 });
             };
             console.log('âœ… å…¼å®¹æ¨¡å¼å·²å¯ç”¨');
         } else {
             console.log('âœ… ä½¿ç”¨ç°ä»£ getUserMedia API');
         }
         
         // åŠ è½½ç«å±±å¼•æ“Web RTC SDK
         const rtcScript = document.createElement('script');
         rtcScript.src = 'https://lf-unpkg.volccdn.com/obj/vcloudfe/sdk/@volcengine/rtc/4.66.19/1750832750322/index.min.js';
         rtcScript.onload = () => {
             console.log('ç«å±±å¼•æ“RTC SDKåŠ è½½æˆåŠŸ');
             initVolcEngines();
         };
         rtcScript.onerror = () => {
             console.error('RTC SDKåŠ è½½å¤±è´¥ï¼ŒCDNåœ°å€æ— æ•ˆ');
             alert('RTC SDKåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ›´æ–°CDNåœ°å€');
         };
         document.head.appendChild(rtcScript);
         
         // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶ç›‘å¬
         if (voiceBtn) {
             // ç¡®ä¿æŒ‰é’®åˆå§‹çŠ¶æ€æ­£ç¡®
             updateVoiceButtonState(false);
             
             voiceBtn.addEventListener('click', () => {
                 console.log('éº¦å…‹é£æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå½“å‰isRecordingçŠ¶æ€:', isRecording);
                 if (isRecording) {
                     console.log('è°ƒç”¨stopRecording()');
                     stopRecording();
                 } else {
                     console.log('è°ƒç”¨startRecording()');
                     startRecording();
                 }
             });
             console.log('è¯­éŸ³æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
         } else {
             console.error('æœªæ‰¾åˆ°voice-btnå…ƒç´ ');
         }
     });
    
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        // è‡ªåŠ¨è·å–å¹¶è®¾ç½®é»˜è®¤ç”¨æˆ·
        autoSetDefaultUser();
    });

    // è‡ªåŠ¨è®¾ç½®é»˜è®¤ç”¨æˆ·
    async function autoSetDefaultUser() {
        try {
            const response = await fetch("{% url 'load_users' %}");
            const data = await response.json();
            
            // æŸ¥æ‰¾é»˜è®¤ç”¨æˆ·
            const defaultUser = data.users.find(user => user.is_default);
            
            if (defaultUser) {
                // è®¾ç½®é»˜è®¤ç”¨æˆ·
                selectedUser = defaultUser;
                const userSelectText = document.getElementById('user-select-text');
                userSelectText.textContent = defaultUser.name;
                console.log('è‡ªåŠ¨è®¾ç½®é»˜è®¤ç”¨æˆ·:', selectedUser);
            } else {
                console.log('æœªè®¾ç½®é»˜è®¤ç”¨æˆ·');
            }
        } catch (error) {
            console.error('è·å–é»˜è®¤ç”¨æˆ·å¤±è´¥:', error);
        }
    }

    // ä¸ºç”¨æˆ·é€‰æ‹©ä¸‹æ‹‰èœå•ç»‘å®šäº‹ä»¶
    const userSelectBox = document.getElementById('user-select');
    userSelectBox.addEventListener('click', async function (e) {
      // äº’æ–¥å±•å¼€ï¼šç‚¹å‡»ç”¨æˆ·é€‰æ‹©æ—¶å…³é—­åœºæ™¯é€‰æ‹©
      const sceneSelectBox = document.getElementById('scene-select');
      if (sceneSelectBox.classList.contains('open')) {
        sceneSelectBox.classList.remove('open');
      }

      const dropdownMenu = document.getElementById('user-dropdown-menu');
      const selectText = document.getElementById('user-select-text');

      // åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤ºçŠ¶æ€
      this.classList.toggle('open');

      // è‹¥èœå•æ‰“å¼€ï¼Œè¯·æ±‚ç”¨æˆ·æ•°æ®
      if (this.classList.contains('open')) {
        try {
          const response = await fetch("{% url 'load_users' %}");
          const data = await response.json();

          dropdownMenu.innerHTML = ''; // æ¸…ç©ºåŸæœ‰å†…å®¹

          if (data.users.length > 0) {
            data.users.forEach(user => {
              const li = document.createElement('li');
              const userItem = document.createElement('div');
              userItem.className = 'user-item';

              const avatar = document.createElement('img');
              avatar.className = 'user-avatar';
              avatar.src = user.photo_url || 'https://via.placeholder.com/30'; // è‹¥æ²¡æœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå ä½å›¾
              avatar.alt = user.name;

              const name = document.createElement('span');
              name.textContent = user.name;

              userItem.appendChild(avatar);
              userItem.appendChild(name);
              li.appendChild(userItem);

              li.addEventListener('click', (event) => {
                event.stopPropagation(); // é˜²æ­¢å†’æ³¡å¯¼è‡´èœå•é‡æ–°åˆ‡æ¢
                selectText.textContent = user.name;
                selectedUser = user; // ä¿å­˜é€‰ä¸­çš„ç”¨æˆ·ä¿¡æ¯
                console.log('é€‰ä¸­ç”¨æˆ·:', selectedUser);
                userSelectBox.classList.remove('open'); // è‡ªåŠ¨å…³é—­èœå•
              });
              dropdownMenu.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.textContent = 'æš‚æ— ç”¨æˆ·å½•å…¥ï¼Œè¯·è¿›å…¥"æˆ‘çš„"è¿›è¡Œå½•å…¥ã€‚';
            li.style.color = 'red';
            li.style.cursor = 'default';
            li.addEventListener('click', (e) => e.stopPropagation());
            dropdownMenu.appendChild(li);
          }
        } catch (error) {
          console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
          const li = document.createElement('li');
          li.textContent = 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
          li.style.color = 'red';
          li.style.cursor = 'default';
          li.addEventListener('click', (e) => e.stopPropagation());
          dropdownMenu.appendChild(li);
        }
      }
    });

    // ä¸ºåœºæ™¯é€‰æ‹©ä¸‹æ‹‰èœå•ç»‘å®šäº‹ä»¶
    const sceneSelectBox = document.getElementById('scene-select');
    sceneSelectBox.addEventListener('click', function (e) {
      // äº’æ–¥å±•å¼€ï¼šç‚¹å‡»åœºæ™¯é€‰æ‹©æ—¶å…³é—­ç”¨æˆ·é€‰æ‹©
      const userSelectBox = document.getElementById('user-select');
      if (userSelectBox.classList.contains('open')) {
        userSelectBox.classList.remove('open');
      }
      // åˆ‡æ¢å½“å‰èœå•æ˜¾ç¤º
      this.classList.toggle('open');
    });

    // ç»™åœºæ™¯é€‰æ‹©èœå•é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œé€‰ä¸­åæ›¿æ¢æ–‡å­—ï¼Œå¹¶å…³é—­èœå•
    sceneSelectBox.querySelectorAll('.dropdown-menu li').forEach((item) => {
      item.addEventListener('click', (e) => {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡å¯¼è‡´å…³é—­èœå•å†²çª
        const textSpan = sceneSelectBox.querySelector('span');
        textSpan.textContent = item.textContent;
        sceneSelectBox.classList.remove('open'); // è‡ªåŠ¨å…³é—­èœå•
      });
    });

    // ç‚¹å‡»é¡µé¢ç©ºç™½å¤„å…³é—­æ‰€æœ‰èœå•
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".select-box.dropdown")) {
        document.querySelectorAll(".select-box.dropdown.open").forEach((openBox) => {
          openBox.classList.remove("open");
        });
      }
    });

    function getCookie(name) {
       const value = `; ${document.cookie}`;
       const parts = value.split(`; ${name}=`);
       if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const sendBtn = document.getElementById('send-btn');
    const sendImg = sendBtn.querySelector('img[alt="send"]');
    const retryImg = sendBtn.querySelector('img[alt="retry"]');
    
    // æ›´æ–°sendBtnçŠ¶æ€ä¸ºé‡è¯•æ¨¡å¼
    function updateSendBtnToRetry() {
      if (sendImg && retryImg) {
        sendImg.style.display = 'none';
        retryImg.style.display = 'block';
        sendBtn.classList.add('retry-mode');
        // ç¡®ä¿æŒ‰é’®å¯è§
        sendBtn.style.display = 'flex';
        console.log('sendBtnå·²æ›´æ–°ä¸ºé‡è¯•æ¨¡å¼');
      } else {
        console.error('sendBtnå›¾ç‰‡å…ƒç´ æœªæ‰¾åˆ°');
      }
    }
    
    // é‡ç½®sendBtnçŠ¶æ€ä¸ºå‘é€æ¨¡å¼
    function resetSendBtnToSend() {
      if (sendImg && retryImg) {
        sendImg.style.display = 'block';
        retryImg.style.display = 'none';
        sendBtn.classList.remove('retry-mode');
        console.log('sendBtnå·²é‡ç½®ä¸ºå‘é€æ¨¡å¼');
      } else {
        console.error('sendBtnå›¾ç‰‡å…ƒç´ æœªæ‰¾åˆ°');
      }
    }
    
    // éšè—sendBtnï¼ˆç‚¹å‡»retryåä¸å†æ˜¾ç¤ºï¼‰
    function hideSendBtn() {
      sendBtn.style.display = 'none';
      console.log('sendBtnå·²éšè—');
    }
    
    // ç¡®ä¿sendBtnå¯è§
    function ensureSendBtnVisible() {
      sendBtn.style.display = 'flex';
      console.log('sendBtnå·²ç¡®ä¿å¯è§');
    }
    
    // éšè—"æŸ¥çœ‹æ­é…"æŒ‰é’®ï¼ˆå¸¦è¿‡æ¸¡åŠ¨ç”»ï¼‰
    function hideViewOutfitBtn() {
      const viewOutfitBtn = document.getElementById('view-outfit-btn');
      if (viewOutfitBtn) {
        viewOutfitBtn.classList.add('fade-out');
        setTimeout(() => {
          viewOutfitBtn.style.display = 'none';
          viewOutfitBtn.classList.remove('fade-out');
        }, 300);
        console.log('"æŸ¥çœ‹æ­é…"æŒ‰é’®å·²éšè—');
      }
    }
    
    // æ·»åŠ retryæŒ‰é’®æ—‹è½¬åŠ¨ç”»
    function addRetryButtonAnimation() {
      if (sendBtn.classList.contains('retry-mode')) {
        // æ·»åŠ æ—‹è½¬åŠ¨ç”»ç±»
        sendBtn.classList.add('rotating');
        
        // 0.8ç§’åç§»é™¤æ—‹è½¬ç±»ï¼ˆä¸CSSåŠ¨ç”»æ—¶é•¿ä¸€è‡´ï¼‰
        setTimeout(() => {
          sendBtn.classList.remove('rotating');
        }, 800);
        
        console.log('retryæŒ‰é’®æ—‹è½¬åŠ¨ç”»å·²è§¦å‘');
      }
    }
    
    sendBtn.addEventListener('click', async () => {
      // å¦‚æœæ˜¯retryæ¨¡å¼ï¼Œåªè§¦å‘æ—‹è½¬åŠ¨ç”»ï¼Œä¸éšè—æŒ‰é’®
      if (sendBtn.classList.contains('retry-mode')) {
        addRetryButtonAnimation();
        hideViewOutfitBtn();
        
        // é‡ç½®è¯„åˆ†çŠ¶æ€
        window.savedRating = undefined;
        window.savedRatingSubmitted = undefined;
        window.ratingInitialized = undefined;
        currentRating = 0;
        ratingSubmitted = false;
        console.log('retryæŒ‰é’®ç‚¹å‡»ï¼Œè¯„åˆ†çŠ¶æ€å·²é‡ç½®');
      }
      
      try {
        // ä» localStorage è·å–åŸå¸‚ä¿¡æ¯
        const city = decodeURIComponent(getCookie('city') || '');
        const now = new Date();
        const start_time = now.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '.');
        const end_time = start_time;  // ç¤ºä¾‹ä¸­å‡è®¾ç»“æŸæ—¶é—´å’Œå¼€å§‹æ—¶é—´ç›¸åŒ
        console.log('æ—¶é—´ä¿¡æ¯:', { start_time, end_time });
        
        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ç”¨æˆ·
        if (!selectedUser) {
          showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·', 'error');
          return;
        }
        
        console.log('é€‰æ‹©çš„ç”¨æˆ·:', selectedUser);
        
        const gender = selectedUser.gender || '';
        const height = selectedUser.height || '';
        const weight = selectedUser.weight || '';
        
        console.log('ç”¨æˆ·ä¿¡æ¯:', { gender, height, weight });
        
        // è·å–åœºæ™¯é€‰æ‹©ä¿¡æ¯
        const scene = document.getElementById('scene-select-text').textContent;
        console.log('åœºæ™¯ä¿¡æ¯:', scene);
        
        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†åœºæ™¯
        if (scene === 'åœºæ™¯é€‰æ‹©') {
          showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåœºæ™¯', 'error');
          return;
        }
        
        // è·å–è¾“å…¥æ¡†å†…å®¹
        const userInput = inputBox.value.trim();

        // æ‹¼æ¥åœºæ™¯å’Œè¾“å…¥
        const fullSceneInput = `${scene},  ${userInput}`;
        
        // wendang å­—æ®µå°†ç”±åç«¯è‡ªåŠ¨è·å– closet.json çš„å†…å®¹
        const wendang = ''; // å‰ç«¯ä¸ä¼ é€’ï¼Œç”±åç«¯è·å–

        const formData = new FormData();
        formData.append('city', city);
        formData.append('end_time', end_time);
        formData.append('gender', gender);
        formData.append('height', height);
        formData.append('start_time', start_time);
        formData.append('weight', weight);
        formData.append('wendang', wendang);
        formData.append('scene', fullSceneInput);

        console.log('=== å‘é€åˆ°åç«¯çš„å‚æ•° ===');
        for (let [key, value] of formData.entries()) {
          console.log(`${key}: ${value}`);
        }

        console.log('=== å¼€å§‹è°ƒç”¨åç«¯æ¥å£ ===');
        
        // éšè—ä¹‹å‰çš„"æŸ¥çœ‹æ­é…"æŒ‰é’®ï¼ˆå¸¦è¿‡æ¸¡åŠ¨ç”»ï¼‰
        hideViewOutfitBtn();
        
        // å¦‚æœå½“å‰æ˜¯retryæ¨¡å¼ï¼Œä¿æŒretryçŠ¶æ€ï¼›å¦åˆ™é‡ç½®ä¸ºå‘é€æ¨¡å¼
        if (!sendBtn.classList.contains('retry-mode')) {
          resetSendBtnToSend();
        }
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const loadingText = document.createElement('div');
        loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆæ­é…æ¨è...';
        loadingText.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 15px 25px;
          border-radius: 10px;
          z-index: 1000;
          font-size: 14px;
        `;
        document.body.appendChild(loadingText);
        
        const responseWorkflow = await fetch("{% url 'coze_workflow' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        });
        
        // ç§»é™¤åŠ è½½æç¤º
        loadingText.remove();

        console.log('=== åç«¯å“åº”çŠ¶æ€ ===');
        console.log('çŠ¶æ€ç :', responseWorkflow.status);
        console.log('çŠ¶æ€æ–‡æœ¬:', responseWorkflow.statusText);

        const result = await responseWorkflow.json();
        console.log('=== åç«¯è¿”å›ç»“æœ ===');
        console.log('å®Œæ•´ç»“æœ:', result);
        
        if (responseWorkflow.ok) {
          console.log('æ­é…æ¨èç»“æœ:', result.results);
          
                      if (result.success) {
              // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
              showNotification('æ­é…æ¨èç”ŸæˆæˆåŠŸï¼', 'success');
              
              // å¦‚æœæœ‰æ‹¼æ¥å›¾ç‰‡ï¼Œæ˜¾ç¤º"æŸ¥çœ‹æ­é…"æŒ‰é’®
              if (result.coord_url) {
                console.log('æ‹¼æ¥å›¾ç‰‡URL:', result.coord_url);
                console.log('æ‹¼æ¥å›¾ç‰‡æ–‡ä»¶å:', result.coord_image);
                
                // ä¿å­˜æ­é…æ•°æ®åˆ°å…¨å±€å˜é‡
                window.currentOutfitData = {
                  coord_url: result.coord_url,
                  coord_image: result.coord_image,
                  results: result.results
                };
                
                              // æ˜¾ç¤º"æŸ¥çœ‹æ­é…"æŒ‰é’®
              const viewOutfitBtn = document.getElementById('view-outfit-btn');
              viewOutfitBtn.style.display = 'block';
              // ç¡®ä¿æŒ‰é’®å¯è§
              viewOutfitBtn.style.opacity = '1';
              viewOutfitBtn.style.transform = 'translateY(0)';
              
              // æ›´æ–°sendBtnçŠ¶æ€ä¸ºé‡è¯•æ¨¡å¼
              updateSendBtnToRetry();
              // ç¡®ä¿retryæŒ‰é’®å¯è§
              ensureSendBtnVisible();
              }
            } else {
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            showNotification('æ­é…æ¨èå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        } else {
          console.error('è°ƒç”¨é”™è¯¯:', result.error);
          showNotification('æ­é…æ¨èå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        console.error('è¯·æ±‚å‡ºé”™:', error);
        showNotification('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
      }
    });

    // æŸ¥çœ‹æ­é…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå› ä¸ºæŒ‰é’®æ˜¯åŠ¨æ€åˆ›å»ºçš„
      document.addEventListener('click', function(e) {
        if (e.target.closest('.outfit-btn')) {
          showOutfitModal();
        }
      });
    });

    // æ˜¾ç¤ºæ­é…å¼¹çª—å‡½æ•°
    function showOutfitModal() {
      if (!window.currentOutfitData) {
        showNotification('æ²¡æœ‰å¯ç”¨çš„æ­é…æ•°æ®', 'error');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä¿å­˜çš„è¯„åˆ†çŠ¶æ€
      if (window.savedRating && window.savedRatingSubmitted) {
        // æ¢å¤ä¿å­˜çš„è¯„åˆ†çŠ¶æ€
        currentRating = window.savedRating;
        ratingSubmitted = window.savedRatingSubmitted;
        console.log('æ¢å¤ä¿å­˜çš„è¯„åˆ†çŠ¶æ€:', currentRating, ratingSubmitted);
      } else {
        // åªåœ¨ç¬¬ä¸€æ¬¡æ‰“å¼€å¼¹çª—æ—¶é‡ç½®è¯„åˆ†çŠ¶æ€
        if (typeof window.ratingInitialized === 'undefined') {
          currentRating = 0;
          ratingSubmitted = false;
          window.ratingInitialized = true;
        }
      }
      
      // å»¶è¿Ÿæ‰§è¡ŒUIçŠ¶æ€æ¢å¤ï¼Œç¡®ä¿DOMå…ƒç´ å·²åˆ›å»º
      setTimeout(() => {
        if (ratingSubmitted && currentRating > 0) {
          // æ¢å¤UIçŠ¶æ€
          const stars = document.querySelectorAll('.star');
          const ratingText = document.querySelector('.rating-text');
          const submitBtn = document.querySelector('.submit-rating-btn');
          
          // æ¢å¤æ˜Ÿæ˜ŸçŠ¶æ€
          stars.forEach((star, index) => {
            const starRating = parseInt(star.dataset.rating);
            if (starRating <= currentRating) {
              star.classList.add('active');
            } else {
              star.classList.remove('active');
            }
          });
          
          // æ¢å¤æ–‡æœ¬å’ŒæŒ‰é’®çŠ¶æ€
          if (ratingText) {
            const ratingDescriptions = {
              1: 'éå¸¸ä¸æ»¡æ„',
              2: 'ä¸æ»¡æ„',
              3: 'ä¸€èˆ¬',
              4: 'æ»¡æ„',
              5: 'éå¸¸æ»¡æ„'
            };
            ratingText.innerHTML = '<span class="rating-submitted">âœ“ è¯„åˆ†å·²æäº¤</span>';
          }
          
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'å·²æäº¤';
          }
          
          console.log('UIçŠ¶æ€å·²æ¢å¤');
        }
      }, 100);

      // ç§»é™¤ä¹‹å‰çš„å¼¹çª—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const existingModal = document.querySelector('.modal-overlay');
      if (existingModal) {
        existingModal.remove();
      }
      
      // åˆ›å»ºå¼¹çª—é®ç½©
      const modalOverlay = document.createElement('div');
      modalOverlay.className = 'modal-overlay';
      
      // åˆ›å»ºå¼¹çª—å†…å®¹
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      
      // åˆ›å»ºå¼¹çª—å¤´éƒ¨
      const modalHeader = document.createElement('div');
      modalHeader.className = 'modal-header';
      
      // åˆ›å»ºæ ‡é¢˜
      const modalTitle = document.createElement('div');
      modalTitle.className = 'modal-title';
      modalTitle.textContent = 'æ­é…æ¨è';
      
      // åˆ›å»ºå…³é—­æŒ‰é’®
      const closeButton = document.createElement('button');
      closeButton.className = 'modal-close';
      closeButton.innerHTML = 'Ã—';
      closeButton.onclick = function() {
        closeModal(modalOverlay);
      };
      
      // ä¸»ä½“åŒºåŸŸï¼ˆæ°´å¹³åˆ†æ ï¼‰
      const modalBody = document.createElement('div');
      modalBody.className = 'modal-body';

      // å·¦ä¾§åŒºåŸŸï¼ˆæ­é…å›¾ç‰‡ï¼‰
      const modalLeft = document.createElement('div');
      modalLeft.className = 'modal-left';
      const modalImage = document.createElement('img');
      modalImage.className = 'modal-image';
      modalImage.src = window.currentOutfitData.coord_url;
      modalImage.alt = 'æ­é…æ¨è';
      modalLeft.appendChild(modalImage);

      // å³ä¾§åŒºåŸŸï¼ˆè¯•ç©¿æŒ‰é’®ï¼‰
      const modalRight = document.createElement('div');
      modalRight.className = 'modal-right';
      const tryOnButton = document.createElement('button');
      tryOnButton.className = 'try-on-button';
      tryOnButton.innerHTML = '<span>æŸ¥çœ‹è¯•ç©¿æ•ˆæœ</span><div>ğŸ‘¤</div>';
      tryOnButton.onclick = function() {
        console.log('è¯•ç©¿æŒ‰é’®è¢«ç‚¹å‡»');
        showTryOnPlaceholder();
      };
      modalRight.appendChild(tryOnButton);

      // åˆ›å»ºè¯„åˆ†åŒºåŸŸ
      const ratingSection = document.createElement('div');
      ratingSection.className = 'rating-section';
      
      const ratingTitle = document.createElement('div');
      ratingTitle.className = 'rating-title';
      ratingTitle.textContent = 'è¯·ä¸ºæœ¬æ¬¡æ­é…æ¨èè¯„åˆ†';
      
      const ratingStars = document.createElement('div');
      ratingStars.className = 'rating-stars';
      
      // åˆ›å»º5é¢—æ˜Ÿ
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.className = 'star';
        star.innerHTML = 'â˜…';
        star.dataset.rating = i;
        star.style.cursor = 'pointer';
        star.style.userSelect = 'none';
        star.style.webkitUserSelect = 'none';
        
        // æ·»åŠ å¤šç§äº‹ä»¶ç›‘å¬å™¨ç¡®ä¿å…¼å®¹æ€§
        star.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('æ˜Ÿæ˜Ÿè¢«ç‚¹å‡»ï¼Œè¯„åˆ†:', i);
          setRating(i);
        });
        
        // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
        star.addEventListener('touchstart', function(e) {
          e.preventDefault();
          console.log('æ˜Ÿæ˜Ÿè¢«è§¦æ‘¸ï¼Œè¯„åˆ†:', i);
          setRating(i);
        });
        
        ratingStars.appendChild(star);
      }
      
      const ratingText = document.createElement('div');
      ratingText.className = 'rating-text';
      ratingText.textContent = 'ç‚¹å‡»æ˜Ÿæ˜Ÿè¿›è¡Œè¯„åˆ†';
      
      const submitRatingBtn = document.createElement('button');
      submitRatingBtn.className = 'submit-rating-btn';
      submitRatingBtn.textContent = 'æäº¤è¯„åˆ†';
      submitRatingBtn.disabled = true;
      submitRatingBtn.onclick = function() {
        submitRating();
      };
      
      ratingSection.appendChild(ratingTitle);
      ratingSection.appendChild(ratingStars);
      ratingSection.appendChild(ratingText);
      ratingSection.appendChild(submitRatingBtn);
      
      // ç»„è£…å¼¹çª—
      modalHeader.appendChild(modalTitle);
      modalHeader.appendChild(closeButton);
      modalContent.appendChild(modalHeader);
      modalBody.appendChild(modalLeft);
      modalBody.appendChild(modalRight);
      modalContent.appendChild(modalBody);
      modalContent.appendChild(ratingSection);
      modalOverlay.appendChild(modalContent);
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(modalOverlay);
      
      // ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
      modalOverlay.addEventListener('click', function(e) {
        if (e.target === modalOverlay) {
          closeModal(modalOverlay);
        }
      });
    }

    // è‡ªå®šä¹‰è¯•ç©¿ç›¸å…³å‡½æ•°
    let selectedUpperGarment = null;
    let selectedLowerGarment = null;
    let currentGarmentType = null;
    let closetData = null;
    let usersData = null;

    // æ˜¾ç¤ºåŠ¨æ€æç¤º
    function showCustomTryOnHint() {
      const hint = document.getElementById('customTryOnHint');
      if (hint) {
        console.log('æ˜¾ç¤ºåŠ¨æ€æç¤º');
        hint.style.display = 'block';
        
        // æ·»åŠ å…¥åœºåŠ¨ç”»
        hint.classList.add('slide-in');
        
        // ç­‰å¾…å…¥åœºåŠ¨ç”»å®Œæˆåä¿æŒæ˜¾ç¤ºçŠ¶æ€
        setTimeout(() => {
          hint.classList.remove('slide-in');
          hint.classList.add('show');
        }, 600);
      } else {
        console.error('æœªæ‰¾åˆ°åŠ¨æ€æç¤ºå…ƒç´ ');
      }
    }

    // æ˜¾ç¤ºè‡ªå®šä¹‰è¯•ç©¿å¼¹çª—
    function showCustomTryOnModal() {
      const modal = document.getElementById('customTryOnModal');
      modal.style.display = 'flex';
      loadUsersForTryOn();
      loadClosetData();
    }

    // å…³é—­è‡ªå®šä¹‰è¯•ç©¿å¼¹çª—
    function closeCustomTryOnModal() {
      const modal = document.getElementById('customTryOnModal');
      modal.style.display = 'none';
      // é‡ç½®é€‰æ‹©
      selectedUpperGarment = null;
      selectedLowerGarment = null;
      updateGenerateButton();
    }

    // åŠ è½½ç”¨æˆ·æ•°æ®
    async function loadUsersForTryOn() {
      try {
        const response = await fetch("{% url 'get_users_for_try_on' %}");
        const data = await response.json();
        
        if (data.success) {
          usersData = data;
          const userSelect = document.getElementById('userSelect');
          userSelect.innerHTML = '<option value="">é»˜è®¤ç”¨æˆ·</option>';
          
          data.users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.name;
            userSelect.appendChild(option);
          });
          
          // è®¾ç½®é»˜è®¤ç”¨æˆ·
          if (data.default_user) {
            userSelect.value = data.default_user.id;
          }
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
      }
    }

    // åŠ è½½è¡£æŸœæ•°æ®
    async function loadClosetData() {
      try {
        const response = await fetch("{% url 'get_closet_data' %}");
        const data = await response.json();
        
        if (data.success) {
          closetData = data;
          console.log('è¡£æŸœæ•°æ®åŠ è½½æˆåŠŸ:', data);
        } else {
          console.error('è¡£æŸœæ•°æ®åŠ è½½å¤±è´¥:', data.error);
        }
      } catch (error) {
        console.error('åŠ è½½è¡£æŸœæ•°æ®å¤±è´¥:', error);
      }
    }

    // æ˜¾ç¤ºè¡£ç‰©é€‰æ‹©å™¨
    async function showGarmentSelector(type) {
      currentGarmentType = type;
      const modal = document.getElementById('garmentSelectorModal');
      const title = document.getElementById('garmentSelectorTitle');
      
      if (type === 'upper') {
        title.textContent = 'é€‰æ‹©ä¸Šè¡£';
      } else {
        title.textContent = 'é€‰æ‹©ä¸‹è£…';
      }
      
      modal.style.display = 'flex';
      
      // ç¡®ä¿è¡£æŸœæ•°æ®å·²åŠ è½½
      if (!closetData) {
        console.log('è¡£æŸœæ•°æ®æœªåŠ è½½ï¼Œæ­£åœ¨åŠ è½½...');
        await loadClosetData();
      }
      
      loadGarmentCategories(type);
    }

    // å…³é—­è¡£ç‰©é€‰æ‹©å™¨
    function closeGarmentSelector() {
      const modal = document.getElementById('garmentSelectorModal');
      modal.style.display = 'none';
    }

    // åŠ è½½è¡£ç‰©åˆ†ç±»
    function loadGarmentCategories(type) {
      console.log('=== å¼€å§‹åŠ è½½è¡£ç‰©åˆ†ç±» ===');
      console.log('ç±»å‹:', type);
      console.log('è¡£æŸœæ•°æ®:', closetData);
      
      if (!closetData) {
        console.error('è¡£æŸœæ•°æ®æœªåŠ è½½');
        return;
      }
      
      const categoryList = document.getElementById('categoryList');
      const garmentGrid = document.getElementById('garmentGrid');
      
      console.log('categoryListå…ƒç´ :', categoryList);
      console.log('garmentGridå…ƒç´ :', garmentGrid);
      
      if (!categoryList || !garmentGrid) {
        console.error('æœªæ‰¾åˆ°åˆ†ç±»åˆ—è¡¨æˆ–è¡£ç‰©ç½‘æ ¼å…ƒç´ ');
        return;
      }
      
      categoryList.innerHTML = '';
      garmentGrid.innerHTML = '';
      
      const garments = type === 'upper' ? closetData.upper_garments : closetData.lower_garments;
      console.log(`${type}è¡£ç‰©æ•°æ®:`, garments);
      console.log(`${type}è¡£ç‰©æ•°é‡:`, garments ? garments.length : 0);
      
      if (!garments || garments.length === 0) {
        console.log(`æ²¡æœ‰æ‰¾åˆ°${type}ç±»å‹çš„è¡£ç‰©`);
        categoryList.innerHTML = '<div class="no-category">æš‚æ— è¡£ç‰©åˆ†ç±»</div>';
        garmentGrid.innerHTML = '<div class="no-garments">æš‚æ— è¡£ç‰©</div>';
        return;
      }
      
      const categories = [...new Set(garments.map(item => item.category))];
      console.log('åˆ†ç±»åˆ—è¡¨:', categories);
      console.log('åˆ†ç±»æ•°é‡:', categories.length);
      console.log('æ‰€æœ‰è¡£ç‰©è¯¦æƒ…:', garments.map(item => ({
        filename: item.filename,
        category: item.category,
        url: item.url
      })));
      
      categories.forEach((category, index) => {
        console.log(`åˆ›å»ºåˆ†ç±»é¡¹: ${category} (ç´¢å¼•: ${index})`);
        const categoryItem = document.createElement('div');
        categoryItem.className = 'category-item';
                  categoryItem.innerHTML = `
            <img src="${getCategoryIcon(category)}" alt="${getCategoryDisplayName(category)}" class="category-icon">
            <span>${getCategoryDisplayName(category)}</span>
          `;
        
        categoryItem.onclick = () => {
          console.log(`ç‚¹å‡»åˆ†ç±»: ${category}`);
          // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
          document.querySelectorAll('.category-item').forEach(item => item.classList.remove('active'));
          categoryItem.classList.add('active');
          
          // æ˜¾ç¤ºå¯¹åº”åˆ†ç±»çš„è¡£ç‰©
          showGarmentsByCategory(category, type);
        };
        
        categoryList.appendChild(categoryItem);
        console.log(`åˆ†ç±»é¡¹å·²æ·»åŠ åˆ°DOM: ${category}`);
        
        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªåˆ†ç±»
        if (index === 0) {
          console.log(`é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªåˆ†ç±»: ${category}`);
          categoryItem.classList.add('active');
          showGarmentsByCategory(category, type);
        }
      });
      
      console.log('=== è¡£ç‰©åˆ†ç±»åŠ è½½å®Œæˆ ===');
    }

    // æ ¹æ®åˆ†ç±»æ˜¾ç¤ºè¡£ç‰©
    function showGarmentsByCategory(category, type) {
      console.log(`=== æ˜¾ç¤ºè¡£ç‰©åˆ†ç±» ===`);
      console.log('åˆ†ç±»:', category);
      console.log('ç±»å‹:', type);
      
      if (!closetData) {
        console.error('è¡£æŸœæ•°æ®æœªåŠ è½½');
        return;
      }
      
      const garmentGrid = document.getElementById('garmentGrid');
      console.log('garmentGridå…ƒç´ :', garmentGrid);
      
      if (!garmentGrid) {
        console.error('æœªæ‰¾åˆ°è¡£ç‰©ç½‘æ ¼å…ƒç´ ');
        return;
      }
      
      garmentGrid.innerHTML = '';
      
      const garments = type === 'upper' ? closetData.upper_garments : closetData.lower_garments;
      const categoryGarments = garments.filter(item => item.category === category);
      
      console.log(`åˆ†ç±» ${category} çš„è¡£ç‰©æ•°é‡:`, categoryGarments.length);
      console.log('åˆ†ç±»è¡£ç‰©è¯¦æƒ…:', categoryGarments);
      
      if (categoryGarments.length === 0) {
        garmentGrid.innerHTML = '<div class="no-garments">è¯¥åˆ†ç±»æš‚æ— è¡£ç‰©</div>';
        return;
      }
      
      categoryGarments.forEach((garment, index) => {
        console.log(`åˆ›å»ºè¡£ç‰©é¡¹ ${index + 1}:`, garment);
        const garmentItem = document.createElement('div');
        garmentItem.className = 'garment-item';
        garmentItem.innerHTML = `
          <img src="${garment.url}" alt="è¡£ç‰©å›¾ç‰‡" title="${garment.remark}">
        `;
        
        garmentItem.onclick = () => {
          console.log(`é€‰æ‹©è¡£ç‰©:`, garment);
          // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
          document.querySelectorAll('.garment-item').forEach(item => item.classList.remove('selected'));
          garmentItem.classList.add('selected');
          
          // é€‰æ‹©è¡£ç‰©
          selectGarment(garment, type);
        };
        
        garmentGrid.appendChild(garmentItem);
        console.log(`è¡£ç‰©é¡¹å·²æ·»åŠ åˆ°DOM: ${garment.filename}`);
      });
      
      console.log(`=== è¡£ç‰©æ˜¾ç¤ºå®Œæˆï¼Œå…± ${categoryGarments.length} ä»¶ ===`);
    }

    // è·å–åˆ†ç±»å›¾æ ‡
    function getCategoryIcon(category) {
      const iconMap = {
        'T-SHIRT': "{% static 'icons/t-shirt.png' %}",
        'SHIRT': "{% static 'icons/shirt.png' %}",
        'COAT': "{% static 'icons/coat.png' %}",
        'CARDIGAN': "{% static 'icons/cardigan.png' %}",
        'SUIT': "{% static 'icons/suit.png' %}",
        'SWEATSHIRT': "{% static 'icons/sweatshirt.png' %}",
        'SHORTS': "{% static 'icons/short-pants.png' %}",
        'TROUSERS': "{% static 'icons/long-pants.png' %}",
        'SHORT-SKIRT': "{% static 'icons/short-skirt.png' %}"
      };
      return iconMap[category] || "{% static 'icons/t-shirt.png' %}";
    }

    // è·å–åˆ†ç±»æ˜¾ç¤ºåç§°
    function getCategoryDisplayName(category) {
      const nameMap = {
        'T-SHIRT': 'Tæ¤',
        'SHIRT': 'è¡¬è¡«',
        'COAT': 'å¤–å¥—',
        'CARDIGAN': 'å¼€è¡«',
        'SUIT': 'æ­£è£…',
        'SWEATSHIRT': 'å«è¡£',
        'SHORTS': 'çŸ­è£¤',
        'TROUSERS': 'é•¿è£¤',
        'SHORT-SKIRT': 'çŸ­è£™'
      };
      return nameMap[category] || category;
    }

    // é€‰æ‹©è¡£ç‰©
    function selectGarment(garment, type) {
      if (type === 'upper') {
        selectedUpperGarment = garment;
        showSelectedGarment(garment, 'upper');
      } else {
        selectedLowerGarment = garment;
        showSelectedGarment(garment, 'lower');
      }
      
      closeGarmentSelector();
      updateGenerateButton();
    }

    // å¤„ç†è¡£ç‰©ä¸Šä¼ 
    async function handleGarmentUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // æ£€æŸ¥æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('image/')) {
        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        return;
      }

      // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
      if (file.size > 5 * 1024 * 1024) {
        alert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
        return;
      }

      try {
        // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
        const uploadBtn = document.querySelector('.upload-btn');
        const originalText = uploadBtn.innerHTML;
        uploadBtn.innerHTML = '<i>â³</i><span>å¤„ç†ä¸­...</span>';
        uploadBtn.disabled = true;

        // åˆ›å»ºFormData
        const formData = new FormData();
        formData.append('image', file);
        formData.append('type', currentGarmentType); // 'upper' æˆ– 'lower'

        // å‘é€åˆ°åç«¯å¤„ç†
        const response = await fetch("{% url 'process_uploaded_garment' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          // åˆ›å»ºä¸Šä¼ çš„è¡£ç‰©å¯¹è±¡
          const uploadedGarment = {
            filename: result.filename,
            url: result.processed_url,
            category: 'UPLOADED',
            remark: 'ç”¨æˆ·ä¸Šä¼ çš„è¡£ç‰©',
            is_uploaded: true
          };

          // é€‰æ‹©ä¸Šä¼ çš„è¡£ç‰©
          selectGarment(uploadedGarment, currentGarmentType);
          
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          showNotification('è¡£ç‰©ä¸Šä¼ å¹¶å¤„ç†æˆåŠŸï¼', 'success');
        } else {
          throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        showNotification('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const uploadBtn = document.querySelector('.upload-btn');
        uploadBtn.innerHTML = originalText;
        uploadBtn.disabled = false;
        
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
        event.target.value = '';
      }
    }

    // æ˜¾ç¤ºå·²é€‰è¡£ç‰©
    function showSelectedGarment(garment, type) {
      const placeholder = document.getElementById(`${type}Placeholder`);
      const selected = document.getElementById(`${type}Selected`);
      const image = document.getElementById(`${type}Image`);
      const name = document.getElementById(`${type}Name`);
      
      placeholder.style.display = 'none';
      selected.style.display = 'flex';
      
      image.src = garment.url;
    }

    // æ¸…é™¤é€‰æ‹©
    function clearSelection(type) {
      const placeholder = document.getElementById(`${type}Placeholder`);
      const selected = document.getElementById(`${type}Selected`);
      
      placeholder.style.display = 'flex';
      selected.style.display = 'none';
      
      if (type === 'upper') {
        selectedUpperGarment = null;
      } else {
        selectedLowerGarment = null;
      }
      
      updateGenerateButton();
    }

    // æ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
    function updateGenerateButton() {
      const btn = document.getElementById('generateTryOnBtn');
      btn.disabled = !(selectedUpperGarment && selectedLowerGarment);
    }

    // ç”Ÿæˆè‡ªå®šä¹‰è¯•ç©¿æ•ˆæœ
    async function generateCustomTryOn() {
      if (!selectedUpperGarment || !selectedLowerGarment) {
        alert('è¯·å…ˆé€‰æ‹©ä¸Šè¡£å’Œä¸‹è£…');
        return;
      }
      
      const btn = document.getElementById('generateTryOnBtn');
      btn.disabled = true;
      btn.textContent = 'ç”Ÿæˆä¸­...';
      
      try {
        const userSelect = document.getElementById('userSelect');
        const userId = userSelect.value;
        
        const response = await fetch("{% url 'custom_try_on' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            upper_garment: selectedUpperGarment.filename,
            lower_garment: selectedLowerGarment.filename,
            user_id: userId
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // æ˜¾ç¤ºè¯•ç©¿ç»“æœ
          const container = document.getElementById('tryOnImageContainer');
          container.innerHTML = `
            <img src="${result.fit_path}" alt="è¯•ç©¿æ•ˆæœ" style="max-width: 100%; max-height: 100%; object-fit: contain;">
          `;
        } else {
          alert('ç”Ÿæˆè¯•ç©¿æ•ˆæœå¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('ç”Ÿæˆè¯•ç©¿æ•ˆæœå¤±è´¥:', error);
        alert('ç”Ÿæˆè¯•ç©¿æ•ˆæœå¤±è´¥ï¼Œè¯·é‡è¯•');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ç”Ÿæˆè¯•ç©¿æ•ˆæœ';
      }
    }

    // è·å–CSRF Token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºæç¤º
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        showCustomTryOnHint();
      }, 2000);
    });

    // æ˜¾ç¤ºè¯•ç©¿å ä½å›¾
    function showTryOnPlaceholder() {
      console.log('æ˜¾ç¤ºè¯•ç©¿å ä½å›¾');
      const modalRight = document.querySelector('.modal-right');
      if (!modalRight) {
        console.error('æœªæ‰¾åˆ°modal-rightå…ƒç´ ');
        return;
      }
      
      // æ¸…ç©ºå³ä¾§åŒºåŸŸ
      modalRight.innerHTML = '';
      
      // åˆ›å»ºå ä½å›¾
      const placeholder = document.createElement('div');
      placeholder.className = 'placeholder-image';
      placeholder.innerHTML = '<div class="loading-spinner"></div><div style="margin-top: 10px; color: #999; font-size: 12px;">ç”Ÿæˆè¯•ç©¿æ•ˆæœä¸­...</div>';
      modalRight.appendChild(placeholder);
      
      // æ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹
      setTimeout(() => {
        console.log('å¼€å§‹è°ƒç”¨generateTryOnImage');
        generateTryOnImage();
      }, 2000);
    }

    // ç”Ÿæˆè¯•ç©¿å›¾åƒ
    async function generateTryOnImage() {
      console.log('=== generateTryOnImage å‡½æ•°è¢«è°ƒç”¨ ===');
      
      if (!selectedUser) {
        console.error('æœªé€‰æ‹©ç”¨æˆ·');
        showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·', 'error');
        return;
      }
      
      if (!window.currentOutfitData) {
        console.error('æ²¡æœ‰æ­é…æ•°æ®');
        showNotification('æ²¡æœ‰å¯ç”¨çš„æ­é…æ•°æ®', 'error');
        return;
      }
      
      console.log('å¼€å§‹ç”Ÿæˆè¯•ç©¿å›¾åƒ...');
      console.log('é€‰ä¸­ç”¨æˆ·:', selectedUser);
      console.log('æ­é…æ•°æ®:', window.currentOutfitData);
      
              try {
          // æ˜¾ç¤ºåŠ è½½æç¤º
          showNotification('æ­£åœ¨ç”Ÿæˆè¯•ç©¿å›¾åƒï¼Œè¯·ç¨å€™...', 'loading');
        
        // å‡†å¤‡è¯•ç©¿æ•°æ®
        const formData = new FormData();
        
        // è·å–ç”¨æˆ·å½¢ä½“å›¾ç‰‡
        const userPhotoUrl = selectedUser.photo_url;
        if (!userPhotoUrl) {
          throw new Error('ç”¨æˆ·æ²¡æœ‰ä¸Šä¼ å½¢ä½“å›¾ç‰‡');
        }
        
        // è·å–æ­é…å›¾ç‰‡
        const outfitImageUrl = window.currentOutfitData.coord_url;
        if (!outfitImageUrl) {
          throw new Error('æ²¡æœ‰å¯ç”¨çš„æ­é…å›¾ç‰‡');
        }
        
        // ä¸‹è½½å¹¶è½¬æ¢ä¸ºæ–‡ä»¶
        const humanImageBlob = await fetchImageAsBlob(userPhotoUrl);
        const clothingImageBlob = await fetchImageAsBlob(outfitImageUrl);
        
        formData.append('human_image', humanImageBlob, 'human.jpg');
        formData.append('clothing_image', clothingImageBlob, 'clothing.jpg');
        
        // è°ƒç”¨è¯•ç©¿API
        console.log('å‡†å¤‡è°ƒç”¨è¯•ç©¿API...');
        console.log('FormDataå†…å®¹:');
        for (let [key, value] of formData.entries()) {
          console.log(`${key}: ${value instanceof Blob ? `Blob(${value.size} bytes)` : value}`);
        }
        
        const response = await fetch("{% url 'leffa_process' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        });
        
        console.log('APIå“åº”çŠ¶æ€:', response.status);
        console.log('APIå“åº”çŠ¶æ€æ–‡æœ¬:', response.statusText);
        
        if (!response.ok) {
          throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('è¯•ç©¿ç»“æœ:', result);
        
        if (result.success && result.image_data) {
          // æ˜¾ç¤ºè¯•ç©¿ç»“æœ
          displayTryOnResult(result.image_data);
          showNotification('è¯•ç©¿å›¾åƒç”ŸæˆæˆåŠŸï¼', 'success');
        } else {
          throw new Error(result.error || 'è¯•ç©¿å¤±è´¥');
        }
        
              } catch (error) {
          console.error('ç”Ÿæˆè¯•ç©¿å›¾åƒå¤±è´¥:', error);
          showNotification(`è¯•ç©¿å¤±è´¥: ${error.message}`, 'error');
          showRetryButton();
        }
    }
    
    // è·å–å›¾ç‰‡ä¸ºBlob
    async function fetchImageAsBlob(imageUrl) {
      const response = await fetch(imageUrl);
      if (!response.ok) {
        throw new Error(`ä¸‹è½½å›¾ç‰‡å¤±è´¥: ${response.status}`);
      }
      return await response.blob();
    }
    
    // æ˜¾ç¤ºè¯•ç©¿ç»“æœ
    function displayTryOnResult(imageData) {
      const modalRight = document.querySelector('.modal-right');
      if (!modalRight) return;
      
      // æ¸…ç©ºå³ä¾§åŒºåŸŸ
      modalRight.innerHTML = '';
      
      // åˆ›å»ºè¯•ç©¿ç»“æœå›¾ç‰‡
      const tryOnImage = document.createElement('img');
      tryOnImage.src = `data:image/jpeg;base64,${imageData}`;
      tryOnImage.className = 'modal-image';
      tryOnImage.alt = 'è¯•ç©¿æ•ˆæœ';
      modalRight.appendChild(tryOnImage);
      
      console.log('è¯•ç©¿ç»“æœå·²æ˜¾ç¤ºåœ¨å¼¹çª—å³ä¾§');
    }

    // æ˜¾ç¤ºé‡è¯•æŒ‰é’®
    function showRetryButton() {
      const modalRight = document.querySelector('.modal-right');
      if (!modalRight) return;
      
      // æ¸…ç©ºå³ä¾§åŒºåŸŸ
      modalRight.innerHTML = '';
      
      // åˆ›å»ºé‡è¯•æŒ‰é’®
      const retryButton = document.createElement('button');
      retryButton.className = 'retry-button';
      retryButton.innerHTML = 'é‡è¯•';
      retryButton.onclick = function() {
        showTryOnPlaceholder();
      };
      
      const retryContainer = document.createElement('div');
      retryContainer.className = 'placeholder-image';
      retryContainer.innerHTML = '<div style="text-align: center; color: #999; font-size: 12px; margin-bottom: 10px;">è¯•ç©¿ç”Ÿæˆå¤±è´¥</div>';
      retryContainer.appendChild(retryButton);
      modalRight.appendChild(retryContainer);
    }

    // è¯„åˆ†åŠŸèƒ½ç›¸å…³å˜é‡
    let currentRating = 0;
    let ratingSubmitted = false;

    // è®¾ç½®è¯„åˆ†
    function setRating(rating) {
      if (ratingSubmitted) return;
      
      console.log('setRatingè¢«è°ƒç”¨ï¼Œè¯„åˆ†:', rating);
      currentRating = rating;
      
      // ä¿å­˜è¯„åˆ†çŠ¶æ€åˆ°å…¨å±€å˜é‡
      window.savedRating = rating;
      window.savedRatingSubmitted = false;
      
      const stars = document.querySelectorAll('.star');
      const ratingText = document.querySelector('.rating-text');
      const submitBtn = document.querySelector('.submit-rating-btn');
      
      if (!stars.length) {
        console.error('æœªæ‰¾åˆ°æ˜Ÿæ˜Ÿå…ƒç´ ');
        return;
      }
      
      console.log('æ‰¾åˆ°æ˜Ÿæ˜Ÿå…ƒç´ æ•°é‡:', stars.length);
      
      // æ›´æ–°æ˜Ÿæ˜ŸçŠ¶æ€
      stars.forEach((star, index) => {
        const starRating = parseInt(star.dataset.rating);
        console.log(`æ˜Ÿæ˜Ÿ${index + 1}ï¼Œè¯„åˆ†:${starRating}ï¼Œå½“å‰è¯„åˆ†:${rating}`);
        if (starRating <= rating) {
          star.classList.add('active');
          console.log(`æ˜Ÿæ˜Ÿ${index + 1}å·²æ¿€æ´»`);
        } else {
          star.classList.remove('active');
          console.log(`æ˜Ÿæ˜Ÿ${index + 1}å·²å–æ¶ˆæ¿€æ´»`);
        }
      });
      
      // æ›´æ–°æç¤ºæ–‡æœ¬
      const ratingDescriptions = {
        1: 'éå¸¸ä¸æ»¡æ„',
        2: 'ä¸æ»¡æ„',
        3: 'ä¸€èˆ¬',
        4: 'æ»¡æ„',
        5: 'éå¸¸æ»¡æ„'
      };
      if (ratingText) {
        ratingText.textContent = ratingDescriptions[rating] || 'ç‚¹å‡»æ˜Ÿæ˜Ÿè¿›è¡Œè¯„åˆ†';
      }
      
      // å¯ç”¨æäº¤æŒ‰é’®
      if (submitBtn) {
        submitBtn.disabled = false;
      }
      
      console.log('è¯„åˆ†è®¾ç½®å®Œæˆå¹¶å·²ä¿å­˜');
    }

    // æäº¤è¯„åˆ†
    async function submitRating() {
      if (ratingSubmitted || currentRating === 0) return;
      
      try {
        // å‡†å¤‡è¯„åˆ†æ•°æ®
        const ratingData = {
          rating: currentRating,
          outfit_data: window.currentOutfitData,
          user_id: selectedUser ? selectedUser.id : null,
          timestamp: new Date().toISOString()
        };
        
        // å‘é€è¯„åˆ†åˆ°åç«¯ï¼ˆè¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„APIè°ƒç”¨ï¼‰
        console.log('æäº¤è¯„åˆ†:', ratingData);
        
        // æ¨¡æ‹ŸAPIè°ƒç”¨
        // const response = await fetch('/submit_rating/', {
        //   method: 'POST',
        //   headers: {
        //     'Content-Type': 'application/json',
        //     'X-CSRFToken': '{{ csrf_token }}'
        //   },
        //   body: JSON.stringify(ratingData)
        // });
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showNotification(`è¯„åˆ†æäº¤æˆåŠŸï¼æ‚¨ç»™äº†${currentRating}é¢—æ˜Ÿ`, 'success');
        
        // æ›´æ–°UIçŠ¶æ€
        ratingSubmitted = true;
        
        // ä¿å­˜æäº¤çŠ¶æ€åˆ°å…¨å±€å˜é‡
        window.savedRatingSubmitted = true;
        
        const submitBtn = document.querySelector('.submit-rating-btn');
        const ratingText = document.querySelector('.rating-text');
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'å·²æäº¤';
        ratingText.innerHTML = '<span class="rating-submitted">âœ“ è¯„åˆ†å·²æäº¤</span>';
        
        // ç¦ç”¨æ˜Ÿæ˜Ÿç‚¹å‡»
        const stars = document.querySelectorAll('.star');
        stars.forEach(star => {
          star.style.cursor = 'default';
          star.onclick = null;
        });
        
        console.log('è¯„åˆ†å·²æäº¤å¹¶ä¿å­˜çŠ¶æ€');
        
      } catch (error) {
        console.error('æäº¤è¯„åˆ†å¤±è´¥:', error);
        showNotification('è¯„åˆ†æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // æ˜¾ç¤ºé€šçŸ¥æç¤º
    function showNotification(message, type = 'info') {
      // ç§»é™¤ä¹‹å‰çš„é€šçŸ¥
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // åˆ›å»ºæ–°é€šçŸ¥
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      // æ ¹æ®ç±»å‹æ·»åŠ å›¾æ ‡
      let icon = '';
      if (type === 'loading') {
        icon = '<div class="loading-spinner"></div>';
      } else if (type === 'success') {
        icon = 'âœ… ';
      } else if (type === 'error') {
        icon = 'âŒ ';
      }
      
      notification.innerHTML = `${icon}${message}`;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(notification);
      
      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);
      
      // è‡ªåŠ¨éšè—ï¼ˆé™¤äº†loadingç±»å‹ï¼‰
      if (type !== 'loading') {
        setTimeout(() => {
          notification.classList.add('hide');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }, 3000);
      }
      
      return notification;
    }

    // å…³é—­å¼¹çª—å‡½æ•°
    function closeModal(modalOverlay) {
      const modalContent = modalOverlay.querySelector('.modal-content');
      modalContent.style.animation = 'slideDown 0.3s ease-in forwards';
      
      setTimeout(() => {
        modalOverlay.remove();
      }, 300);
    }

    // æµ‹è¯•æ˜Ÿæ˜Ÿç‚¹å‡»åŠŸèƒ½
    window.testStarClick = function() {
      console.log('=== æµ‹è¯•æ˜Ÿæ˜Ÿç‚¹å‡»åŠŸèƒ½ ===');
      const stars = document.querySelectorAll('.star');
      console.log('æ‰¾åˆ°æ˜Ÿæ˜Ÿæ•°é‡:', stars.length);
      
      if (stars.length === 0) {
        console.log('æ²¡æœ‰æ‰¾åˆ°æ˜Ÿæ˜Ÿå…ƒç´ ï¼Œè¯·å…ˆæ‰“å¼€æ­é…å¼¹çª—');
        return;
      }
      
      stars.forEach((star, index) => {
        console.log(`æ˜Ÿæ˜Ÿ${index + 1}:`, star);
        console.log(`- dataset.rating:`, star.dataset.rating);
        console.log(`- classList:`, star.classList.toString());
        console.log(`- onclick:`, star.onclick);
        console.log(`- event listeners:`, star.getEventListeners ? star.getEventListeners() : 'æ— æ³•è·å–äº‹ä»¶ç›‘å¬å™¨');
      });
    };
  </script>

  <style>
    @keyframes slideDown {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(100%);
      }
    }
  </style>
    </div>
</body>
</html>
